<!doctype html>
<html class="no-js" lang="zh-CN">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="编辑要素" href="editring.html" /><link rel="prev" title="11 ShapeEditor – 选择和编辑特征" href="index.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>选择要编辑的要素 - python地理空间开发 1.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../_static/mystyles.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">python地理空间开发 1.0 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">python地理空间开发 1.0 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">内容</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about_author.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about_reviewers.html">审稿人简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch1/index.html">1 使用 Python 进行地理空间开发</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch1/python.html">Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/geo_dev.html">地理空间开发</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/applications.html">地理空间开发的应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/recent_dev.html">最新动态</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch2/index.html">2 GIS</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch2/core_concepts.html">核心 GIS 概念</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/gis_data_format.html">GIS 数据格式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/working.html">手动处理 GIS 数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch3/index.html">3 用于地理空间开发的 Python 库</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch3/rw.html">读取和写入地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/dealing_proj.html">处理投影</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/analyzing.html">分析和处理地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/visualizing.html">可视化地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch4/index.html">4 地理空间数据来源</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch4/vector_format.html">矢量格式的地理空间数据来源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/raster_format.html">栅格格式地理空间数据源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/other_format.html">其他类型地理空间数据的来源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/choosing_format.html">选择地理空间数据源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch5/index.html">5 使用 Python 处理地理空间数据</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch5/pre-req.html">先决条件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/rw.html">读取和写入地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/changing.html">更改基准和投影</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/representing.html">表示和存储地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/performing.html">执行地理空间计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/converting.html">转换和标准化几何和距离单位</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/exercises.html">练习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch6/index.html">6 数据库中的 GIS</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch6/spatially.html">空间数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/spatially-indexes.html">空间索引</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/open-source.html">支持空间功能的开源数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/commerical.html">商业空间数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/recommended.html">建议的最佳做法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/working.html">使用 Python 处理地理空间数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch7/index.html">7 使用空间数据</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch7/about-distal.html">关于 DISTAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/designing.html">设计和构建数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/downloading.html">下载数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/importing-data.html">导入数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/implementing.html">实现 DISTAL 应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/aplication.html">应用程序审查和改进</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch8/index.html">8 使用 Python 和 Mapnik 生成地图</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch8/introducing.html">Mapnik 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/creating.html">创建示例地图</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/mapnik.html">Mapnik 深度介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/mapgenerator.html">重新审视 MapGenerator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/mapdefinition.html">地图定义文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch9/index.html">9 整合所有要素——完整的地图系统</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch9/about-shapeditor.html">关于 ShapeEditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/designing-shape.html">设计 ShapeEditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/prerequisites.html">先决条件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/the-structure-ofdjango.html">Django 应用程序的结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/settingup-database.html">设置数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/settingup-shapeeditor.html">设置 ShapeEditor 项目</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/defining-shapeditor.html">定义 ShapeEditor 的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/creating-shared.html">创建共享应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/defining-datamodel.html">定义数据模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/playing.html">玩转管理系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch10/index.html">10 ShapeEditor – 实现列表视图、导入和导出</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch10/implementing.html">实现“列出 Shapefile”视图</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/importing.html">导入 Shapefile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/exporting.html">导出 shapefiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">11 ShapeEditor – 选择和编辑特征</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">选择要编辑的要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="editring.html">编辑要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding.html">添加要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="deleting.html">删除要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="deleting-shapefiles.html">删除 shapefiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html">使用 ShapeEditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="further.html">进一步改进和增强</a></li>
<li class="toctree-l2"><a class="reference internal" href="summary.html">小结</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="id1">
<h1>选择要编辑的要素<a class="headerlink" href="#id1" title="此标题的永久链接">#</a></h1>
<p>Selecting a feature to edit</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p>正如我们在设计 ShapeEditor 这一节中讨论的那样，GeoDjango 内置的地图小部件一次只能显示一个特征。为了在地图上显示所有 shapefile 的特征，我们将必须直接使用 OpenLayers，并结合瓦片地图服务器 (Tile Map Server) 和自定义基于 AJAX 的点击事件处理程序。基本的工作流程如下所示：</p>
<img alt="../_images/441-0.png" class="align-center" src="../_images/441-0.png" />
<p>让我们从实现瓦片地图服务器 (Tile Map Server) 开始，然后看看如何使用 OpenLayers、结合自定义点击事件处理程序和一些服务器端 AJAX 代码，以响应用户点击地图时的操作。</p>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p>As we discussed in the section on designing the ShapeEditor, GeoDjango’s built-in
map widgets can only display a single feature at a time. In order to display a map
with all the shapefile’s features on it, we will have to use OpenLayers directly, along
with a Tile Map Server and a custom AJAX-based click handler. The basic workflow
will look like this:</p>
<img alt="../_images/441-0.png" class="align-center" src="../_images/441-0.png" />
<p>Let’s start by implementing the Tile Map Server, and then see what’s involved in using OpenLayers, along with a custom click-handler and some server-side AJAX code, to respond when the user clicks on the map.</p>
</div>
</div>
<section id="tile">
<h2>实现 Tile 地图服务器<a class="headerlink" href="#tile" title="此标题的永久链接">#</a></h2>
<p>Implementing Tile Map Server</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>正如我们在附录中讨论的“Python 地理空间开发的 Web 框架”（下载链接见前言）所述， <strong>瓦片地图服务协议（Tile Map Server Protocol，TMS）</strong> 是一种简单的 RESTful 协议，用于提供地图瓦片。TMS 协议包括调用识别各种可显示地图的方法，以及提供可用地图瓦片的信息，并允许访问地图瓦片图像本身。</p>
<p>让我们简要回顾一下 TMS 协议使用的术语：</p>
<ul class="simple">
<li><p><strong>瓦片地图服务器（Tile Map Server）</strong> 是实现 TMS 协议的整体 Web 服务器。</p></li>
<li><p><strong>瓦片地图服务（Tile Map Service）</strong> 提供对特定一组地图的访问。单个瓦片地图服务器可以托管多个瓦片地图服务。</p></li>
<li><p><strong>瓦片地图（Tile Map）</strong> 是地球表面全部或部分的完整地图，显示特定的要素集或以特定样式显示。一个瓦片地图服务可以提供对多个瓦片地图的访问。</p></li>
<li><p><strong>瓦片集（Tile Set）</strong> 是在给定缩放级别显示特定瓦片地图的瓦片集合。</p></li>
<li><p><strong>瓦片（Tile）</strong> 是表示由瓦片集显示的地图的一小部分的单个地图图像。</p></li>
</ul>
<p>这听起来可能有些复杂，但实际上并不太难。我们将实现一个仅包含一个瓦片地图服务的瓦片地图服务器，我们将其称为“ShapeEditor 瓦片地图服务”。每个上传的 shapefile 将有一个瓦片地图，我们将支持标准缩放级别范围的瓦片集。最后，我们将使用 Mapnik 渲染瓦片集中的单个瓦片。</p>
<p>遵循 Django 将大型复杂系统分解为独立自包含应用程序的原则，我们将在 ShapeEditor 项目中将瓦片地图服务器实现为一个独立的应用程序。首先进入 ShapeEditor 项目目录并输入以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">tms</span>
</pre></div>
</div>
<p>这将在顶级目录中创建我们的 tms 应用程序，使其成为一个可重用的应用程序。将新创建的目录移动到 shapeEditor 子目录中，可以使用鼠标操作，也可以输入以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="n">tms</span> <span class="n">shapeEditor</span>
</pre></div>
</div>
<p>这使得瓦片地图服务器特定于我们的项目。然后我们需要通过编辑项目的 settings.py 模块并添加以下条目到 INSTALLED_APPS 列表的末尾来启用该应用程序:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;shapeEditor.tms&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>接下来，我们希望将瓦片地图服务器的 URL 作为 ShapeEditor 项目的一部分提供。为此，请编辑全局 urls.py 模块（位于主 ShapeEditor 目录中），并在第一个 urlpatterns = … 语句中添加以下高亮行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^editor/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;shapeEditor.editor.urls&#39;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^tms/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;shapeEditor.tms.urls&#39;</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>现在我们想要定义瓦片地图服务器应用程序提供的各个 URL。为此，在 tms 目录中创建一个名为 urls.py 的新模块，并在此模块中输入以下内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># shapeEditor.tms 应用的 URLConf</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;shapeEditor.tms.views&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">),</span> <span class="c1"># &quot;/tms&quot; 调用 root()</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;[0-9.]+)$&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">),</span> <span class="c1"># 例如 &quot;/tms/1.0&quot; 调用 service(version=&quot;1.0&quot;)</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;[0-9.]+)/&#39;</span> <span class="o">+</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;shapefile_id&gt;\d+)$&#39;</span><span class="p">,</span> <span class="s1">&#39;tileMap&#39;</span><span class="p">),</span> <span class="c1"># 例如 &quot;/tms/1.0/2&quot; 调用 tileMap(version=&quot;1.0&quot;, shapefile_id=2)</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;[0-9.]+)/&#39;</span> <span class="o">+</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;shapefile_id&gt;\d+)/(?P&lt;zoom&gt;\d+)/&#39;</span> <span class="o">+</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;x&gt;\d+)/(?P&lt;y&gt;\d+)\.png$&#39;</span><span class="p">,</span> <span class="s1">&#39;tile&#39;</span><span class="p">),</span> <span class="c1"># 例如 &quot;/tms/1.0/2/3/4/5&quot; 调用 tile(version=&quot;1.0&quot;, shapefile_id=2, zoom=3, x=4, y=5)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>这些 URL 模式比我们之前使用的更复杂，因为我们现在从 URL 中提取参数。例如，考虑以下 URL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">tms</span><span class="o">/</span><span class="mf">1.0</span>
</pre></div>
</div>
<p>它将由 tms 应用程序 urls.py 模块中的第二个正则表达式匹配:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>^(?P&lt;version&gt;[0-9.]+)$
</pre></div>
</div>
<p>这个正则表达式将提取 URL 中的 1.0 部分并将其赋值给名为 version 的参数。然后，该参数被传递给与此 URL 模式关联的视图函数，如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tileMap</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>通过这种方式，我们的每个 URL 模式都将传入的 RESTful URL 映射到 tms 应用程序内的适当视图函数。包含的注释给出了正则表达式如何映射到视图函数的示例。</p>
<p>现在让我们设置这些视图函数。编辑 tms 目录中的 views.py 模块，并在此模块中添加以下内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile Map Server&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile Map Service&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tileMap</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile Map&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>显然，这些只是占位符视图函数，但它们为我们提供了瓦片地图服务器的基本结构。</p>
<p>为了测试这是否有效，请运行 <cite>python manage.py runserver</cite> 命令启动 ShapeEditor 服务器，并在 Web 浏览器中访问 <a class="reference external" href="http://127.0.0.1:8000/tms">http://127.0.0.1:8000/tms</a>。您应该看到输入到占位符 root() 视图函数中的文本。</p>
<p>让我们让这个顶层视图函数做一些有用的事情。返回 tms 应用程序的 views.py 模块，并将 root() 函数更改为如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">baseURL</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;Services&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileMapService &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;title=&quot;ShapeEditor Tile Map Service&quot; &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;version=&quot;1.0&quot; href=&quot;&#39;</span> <span class="o">+</span> <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;/1.0&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/Services&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/xml&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>您还需要在模块顶部添加以下导入语句:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</pre></div>
</div>
<p>此视图函数返回一个 XML 格式的响应，描述 TMS 服务器支持的唯一的瓦片地图服务。此瓦片地图服务由版本号 1.0 标识（瓦片地图服务通常由版本号标识）。如果您现在访问 <a class="reference external" href="http://127.0.0.1:8000/tms">http://127.0.0.1:8000/tms</a>，您将在 Web 浏览器中看到 TMS 响应：</p>
<img alt="../_images/445-0.png" class="align-center" src="../_images/445-0.png" />
<p>如您所见，这提供了 TMS 服务器提供的瓦片地图服务列表。OpenLayers 将使用此信息访问我们的瓦片地图服务。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>错误处理</p>
<p>注意我们在 TMS 视图函数周围包装了一个 try…except 语句，并使用 traceback 标准库模块在出现问题时打印出异常。
我们这样做是因为我们的代码将直接由 OpenLayers 使用 AJAX 调用；Django 会帮助处理异常并向调用者返回 HTML 错误页面，但在这种情况下，如果您的代码中有错误，OpenLayers 不会显示该页面。相反，您只会看到破碎的图像图标而不是地图，错误本身仍然是个谜。
通过将我们的 Python 代码包装在 try…except 语句中，我们可以捕获 Python 代码中的任何异常并打印它们。这将导致错误出现在 Django 的 Web 服务器日志中，因此我们可以看到出了什么问题。每当您编写 Python 中的 AJAX 请求处理程序时，这都是一个有用的技术。</p>
</div>
<p>我们现在准备实现瓦片地图服务本身。再次编辑 view.py 模块，并将 service() 函数更改为如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="n">baseURL</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;TileMapService version=&quot;1.0&quot; services=&quot;&#39;</span> <span class="o">+</span>
                    <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Title&gt;ShapeEditor Tile Map Service&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;&lt;/Title&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Abstract&gt;&lt;/Abstract&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileMaps&gt;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">shapefile</span> <span class="ow">in</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">shapefile</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &lt;TileMap title=&quot;&#39;</span> <span class="o">+</span>
                        <span class="n">shapefile</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        srs=&quot;EPSG:4326&quot;&#39;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        href=&quot;&#39;</span><span class="o">+</span><span class="n">baseURL</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">id</span><span class="o">+</span><span class="s1">&#39;&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;/TileMaps&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/TileMapService&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/xml&quot;</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>您还需要在模块顶部添加以下导入语句:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geodjango.shapeEditor.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Shapefile</span>
</pre></div>
</div>
<p>请注意，如果版本号错误，此函数将引发 Http404 异常。此异常告诉 Django 返回 HTTP 404 错误，这是使用错误 URL 时的标准错误响应。</p>
<p>假设版本号正确，我们将遍历数据库中的各种 Shapefile 对象，将每个上传的 shapefile 列为瓦片地图。</p>
<p>如果您保存此文件并在 Web 浏览器中输入 <a class="reference external" href="http://127.0.0.1:8000/tms/1.0">http://127.0.0.1:8000/tms/1.0</a>，您应该会看到可用瓦片地图的列表，以 XML 格式显示：</p>
<img alt="../_images/447-0.png" class="align-center" src="../_images/447-0.png" />
<p>接下来我们需要实现 tileMap() 函数，以显示给定瓦片地图可用的各种瓦片集。然而，在此之前，我们需要了解一些关于缩放级别的概念。</p>
<p>正如我们所见，切片地图允许用户放大和缩小以查看地图内容。这种缩放是通过控制地图的缩放级别来完成的。通常，缩放级别指定为一个简单的数字：缩放级别零是地图完全缩小的状态，缩放级别 1 是地图放大一次的状态，依此类推。</p>
<p>让我们首先考虑地图完全缩小（即缩放级别 0）时的情况。在这种情况下，我们希望整个地球表面仅由两个地图瓦片覆盖：</p>
<img alt="../_images/448-0.png" class="align-center" src="../_images/448-0.png" />
<p>在此缩放级别下，每个地图瓦片将覆盖 180 度的纬度和经度。如果每个瓦片是 256 像素见方，则每个像素将覆盖 180 / 256 = 0.703125 个地图单位，在这种情况下，“地图单位”是纬度或经度的一个度。这个数字在计算瓦片地图时非常重要。</p>
<p>现在，每当我们放大（例如从缩放级别 0 放大到缩放级别 1）时，可见区域的宽度和高度减半。例如，在缩放级别 1，地球表面将显示为以下八个瓦片序列：</p>
<img alt="../_images/448-1.png" class="align-center" src="../_images/448-1.png" />
<p>按照这个模式，我们可以使用以下公式计算给定缩放级别下地图上单个像素覆盖的地图单位数：</p>
<img alt="../_images/449-0.png" class="align-center" src="../_images/449-0.png" />
<p>由于我们将在 TMS 服务器中使用此公式，让我们继续将以下代码添加到 tms.py 模块的末尾:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_unitsPerPixel</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.703125</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">zoomLevel</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>请注意，我们以一个下划线开头函数名；这是 Python 中命名模块内“私有”函数的标准约定。</p>
</div>
<p>您还需要在文件顶部添加 <cite>import math</cite> 语句。</p>
<p>接下来，我们需要在模块顶部添加一些常量来定义每个地图瓦片的大小以及我们支持的缩放级别数量:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_ZOOM_LEVEL</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">TILE_WIDTH</span>     <span class="o">=</span> <span class="mi">256</span>
<span class="n">TILE_HEIGHT</span>    <span class="o">=</span> <span class="mi">256</span>
</pre></div>
</div>
<p>有了这些，我们终于准备好实现 tileMap() 函数，以返回给定 shapefile 的瓦片地图可用的瓦片集信息。编辑此函数，使其如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tileMap</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">baseURL</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;TileMap version=&quot;1.0&quot; &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;tilemapservice=&quot;&#39;</span> <span class="o">+</span> <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Title&gt;&#39;</span> <span class="o">+</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&lt;/Title&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Abstract&gt;&lt;/Abstract&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;SRS&gt;EPSG:4326&lt;/SRS&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;BoundingBox minx=&quot;-180&quot; miny=&quot;-90&quot; &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;maxx=&quot;180&quot; maxy=&quot;90&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Origin x=&quot;-180&quot; y=&quot;-90&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileFormat width=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s1">&#39;&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TILE_HEIGHT</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;mime-type=&quot;image/png&quot; extension=&quot;png&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileSets profile=&quot;global-geodetic&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zoomLevel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_ZOOM_LEVEL</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">unitsPerPixel</span> <span class="o">=</span> <span class="n">_unitsPerPixel</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &lt;TileSet href=&quot;&#39;</span> <span class="o">+</span>
                        <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39;&quot; units-per-pixel=&quot;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">unitsPerPixel</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39;&quot; order=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;/TileSets&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/TileMap&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/xml&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>如您所见，我们首先对版本和 shapefile ID 进行一些基本错误检查，然后遍历可用的缩放级别以提供可用瓦片集的信息。</p>
<p>如果您保存更改并在 Web 浏览器中输入 <a class="reference external" href="http://127.0.0.1:8000/tms/1.0/2">http://127.0.0.1:8000/tms/1.0/2</a>，您应该看到关于记录 ID 为 2 的 shapefile 对象的瓦片地图的以下信息：</p>
<img alt="../_images/451-0.png" class="align-center" src="../_images/451-0.png" />
<p>请注意，我们总共提供了十一个缩放级别，从零到十，并为每个缩放级别计算了适当的每像素单位数。</p>
<p>我们现在已实现了实现自己的瓦片地图服务器所需的四个视图函数中的三个。对于最后一个函数 tile()，我们将编写自己的瓦片渲染器。tile() 函数接受瓦片地图服务版本、shapefile ID、缩放级别以及所需瓦片的 X 和 Y 坐标:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>此函数需要生成适当的地图瓦片并将渲染的图像返回给调用者。在实现此函数之前，让我们退一步思考地图渲染应该是什么样子。</p>
<p>我们希望地图包含给定 shapefile 中各种要素的轮廓。然而，仅这些要素本身看起来并不十分有意义：</p>
<img alt="../_images/452-0.png" class="align-center" src="../_images/452-0.png" />
<p>只有当这些要素在背景中显示 <strong>基础地图</strong> 时，我们才能看到它们所代表的内容：</p>
<img alt="../_images/452-1.png" class="align-center" src="../_images/452-1.png" />
<p>因此，我们需要显示一个基础地图，在此基础上绘制要素。让我们构建这个基础地图，然后我们可以使用它以及 shapefile 的要素来渲染地图瓦片。</p>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>As we discussed in Bonus chapter, Web Frameworks for Python Geospatial Development
(Download link available in preface) the Tile Map Server Protocol is a simple
RESTful protocol for serving map tiles. The TMS protocol includes calls to identify
the various maps which can be displayed, along with information about the available
map tiles, as well as providing access to the map tile images themselves.</p>
<p>Let’s briefly review the terminology used by the TMS protocol:</p>
<ul class="simple">
<li><p>A <strong>Tile Map Server</strong> is the overall web server which is implementing the TMS protocol.</p></li>
<li><p>A <strong>Tile Map Service</strong> provides access to a particular set of maps. There can be multiple Tile Map Services hosted by a single Tile Map Server.</p></li>
<li><p>A <strong>Tile Map</strong> is a complete map of all or part of the Earth’s surface, displaying a particular set of features or styled in a particular way. A Tile Map Service can provide access to more than one Tile Map.</p></li>
<li><p>A <strong>Tile Set</strong> is a collection of tiles displaying a given Tile Map at a given zoom level.</p></li>
<li><p>A <strong>Tile</strong> is a single map image representing a small portion of the map being displayed by the Tile Set.</p></li>
</ul>
<p>This may sound confusing, but it’s actually not too bad. We’ll be implementing a Tile
Map Server with just one Tile Map Service, which we’ll call the “ShapeEditor Tile Map
Service”. There will be one Tile Map for each shapefile that has been uploaded, and
we’ll support Tile Sets for a standard range of zoom levels. Finally, we’ll use Mapnik
to render the individual Tiles within the Tile Set.</p>
<p>Following the Django principle of breaking a large and complex system down
into separate self-contained applications, we will implement the Tile Map Server
as a separate application within the shapeEditor project. Start by cd’ing into the
shapeEditor project directory and type the following:</p>
<blockquote>
<div><p>python manage.py startapp tms</p>
</div></blockquote>
<p>This creates our tms application in the top-level directory, making it a reusable
application. Move the newly-created directory into the shapeEditor sub-directory,
either using the mouse or by typing the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="n">tms</span> <span class="n">shapeEditor</span>
</pre></div>
</div>
<p>This makes the Tile Map Server specific to our project. We then have to enable the
application by editing our project’s settings.py module and adding the following
entry to the end of the INSTALLED_APPS list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;shapeEditor.tms&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>Next, we want to make our Tile Map Server’s URLs available as part of the
shapeEditor project. To do this, edit the global urls.py module (located inside
the main shapeEditor directory), and add the following highlighted line to the
first urlpatterns = … statement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^editor/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;shapeEditor.editor.urls&#39;</span><span class="p">)),</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^tms/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;shapeEditor.tms.urls&#39;</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We now want to define the individual URLs provided by our Tile Map Server
application. To do this, create a new module named urls.py inside the tms
directory, and enter the following into this module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># URLConf for the shapeEditor.tms application.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;shapeEditor.tms.views&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span>
         <span class="s1">&#39;root&#39;</span><span class="p">),</span> <span class="c1"># &quot;/tms&quot; calls root()</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;[0-9.]+)$&#39;</span><span class="p">,</span>
         <span class="s1">&#39;service&#39;</span><span class="p">),</span> <span class="c1"># eg, &quot;/tms/1.0&quot; calls service(version=&quot;1.0&quot;)</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;[0-9.]+)/&#39;</span> <span class="o">+</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;shapefile_id&gt;\d+)$&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tileMap&#39;</span><span class="p">),</span> <span class="c1"># eg, &quot;/tms/1.0/2&quot; calls</span>
                    <span class="c1"># tileMap(version=&quot;1.0&quot;, shapefile_id=2)</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;version&gt;[0-9.]+)/&#39;</span> <span class="o">+</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;shapefile_id&gt;\d+)/(?P&lt;zoom&gt;\d+)/&#39;</span> <span class="o">+</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;x&gt;\d+)/(?P&lt;y&gt;\d+)\.png$&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tile&#39;</span><span class="p">),</span> <span class="c1"># eg, &quot;/tms/1.0/2/3/4/5&quot; calls</span>
    <span class="c1"># tile(version=&quot;1.0&quot;, shapefile_id=2, zoom=3, x=4, y=5)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>These URL patterns are more complicated than those we’ve used in the past,
because we’re now extracting parameters from the URL. For example, consider
the following URL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">tms</span><span class="o">/</span><span class="mf">1.0</span>
</pre></div>
</div>
<p>This will be matched by the second regular expression in our tms application’s
urls.py module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>^(?P&lt;version&gt;[0-9.]+)$
</pre></div>
</div>
<p>This regular expression will extract the 1.0 portion of the URL and assign it to a
parameter named version. This parameter is then passed on to the view function
associated with this URL pattern, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tileMap</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this way, each of our URL patterns maps an incoming RESTful URL to the
appropriate view function within our tms application. The included comments
give examples of how the regular expressions will map to the view functions.</p>
<p>Let’s now set up these view functions. Edit the views.py module inside the tms
directory, and add the following to this module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile Map Server&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile Map Service&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tileMap</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile Map&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Tile&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Obviously these are only placeholder view functions, but they give us the basic
structure for our Tile Map Server.</p>
<p>To test that this works, launch the ShapeEditor server by running the
python manage.py runserver command, and point your web browser to
<a class="reference external" href="http://127.0.0.1:8000/tms">http://127.0.0.1:8000/tms</a>. You should see the text you entered into your
placeholder root() view function.</p>
<p>Let’s make that top-level view function do something useful. Go back to the tms
application’s views.py module, and change the root() function to look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">baseURL</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;Services&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileMapService &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;title=&quot;ShapeEditor Tile Map Service&quot; &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;version=&quot;1.0&quot; href=&quot;&#39;</span> <span class="o">+</span> <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;/1.0&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/Services&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/xml&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>

        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You’ll also need to add the following import statement to the top of the module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</pre></div>
</div>
<p>This view function returns an XML-format response describing the one-and-only Tile
Map Service supported by our TMS server. This Tile Map Service is identified by a
version number, 1.0 (Tile Map Services are typically identified by version number).
If you now go to <a class="reference external" href="http://127.0.0.1:8000/tms">http://127.0.0.1:8000/tms</a>, you’ll see the TMS response
displayed in your web browser:</p>
<img alt="../_images/445-0.png" class="align-center" src="../_images/445-0.png" />
<p>As you can see, this provides a list of the Tile Map Services which this TMS server provides. OpenLayers will use this to access our Tile Map Service.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Error handling</p>
<p>Notice that we’ve wrapped our TMS view function in a try…
except statement, and used the traceback standard library
module to print out the exception if anything goes wrong.
We’re doing this because our code will be called directly by
OpenLayers using AJAX; Django helpfully handles exceptions
and returns an HTML error page to the caller, but in this case
OpenLayers won’t display that page if there is an error in your
code. Instead, all you’ll see are broken image icons instead of a
map, and the error itself will remain a mystery.
By wrapping our Python code in a try…except statement,
we can catch any exceptions in our Python code and print them
out. This will cause the error to appear in Django’s web server
log, so we can see what went wrong. This is a useful technique
to use whenever you write AJAX request handlers in Python.</p>
</div>
<p>We’re now ready to implement the Tile Map Service itself. Edit the view.py module
again, and change the service() function to look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="n">baseURL</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;TileMapService version=&quot;1.0&quot; services=&quot;&#39;</span> <span class="o">+</span>
                    <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Title&gt;ShapeEditor Tile Map Service&#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;&lt;/Title&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Abstract&gt;&lt;/Abstract&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileMaps&gt;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">shapefile</span> <span class="ow">in</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">shapefile</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &lt;TileMap title=&quot;&#39;</span> <span class="o">+</span>
                        <span class="n">shapefile</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        srs=&quot;EPSG:4326&quot;&#39;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        href=&quot;&#39;</span><span class="o">+</span><span class="n">baseURL</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">id</span><span class="o">+</span><span class="s1">&#39;&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;/TileMaps&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/TileMapService&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/xml&quot;</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You’ll also need to add the following import statements to the top of the module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geodjango.shapeEditor.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Shapefile</span>
</pre></div>
</div>
<p>Notice that this function raises an Http404 exception if the version number is wrong.
This exception tells Django to return a HTTP 404 error, which is the standard error
response when an incorrect URL has been used.</p>
<p>Assuming the version number is correct, we iterate over the various Shapefile
objects in the database, listing each uploaded shapefile as a Tile Map.</p>
<p>If you save this file and enter <a class="reference external" href="http://127.0.0.1:8000/tms/1.0">http://127.0.0.1:8000/tms/1.0</a> into your web
browser, you should see a list of the available tile maps, in XML format:</p>
<img alt="../_images/447-0.png" class="align-center" src="../_images/447-0.png" />
<p>We next need to implement the <em>tileMap()</em> function to display the various Tile Sets
available for a given Tile Map. Before we can do this, though, we’re going to have to
learn a bit about the notion of zoom levels.</p>
<p>As we have seen, a slippy map lets the user zoom in and out to view the map’s
contents. This zooming is done by controlling the map’s zoom level. Typically,
a zoom level is specified as a simple number: zoom level zero is when the map
is fully zoomed out, zoom level 1 is when the map is zoomed in once, and so on.</p>
<p>Let’s start by considering the map when it is zoomed out completely (in other words,
zoom level 0). In this case, we want the entire Earth’s surface to be covered by just
two map tiles:</p>
<img alt="../_images/448-0.png" class="align-center" src="../_images/448-0.png" />
<p>Each map tile at this zoom level would cover 180 degrees of latitude and longitude.
If each tile was 256 pixels square, this would mean that each pixel would cover 180
/ 256 = 0.703125 map units, where in this case a “map unit” is a degree of latitude or
longitude. This number is going to be very important when it comes to calculating
the Tile Maps.</p>
<p>Now, whenever we zoom in (for example by going from zoom level 0 to zoom level
1), the width and height of the visible area is halved. For example, at zoom level 1
the Earth’s surface would be displayed as the following series of eight tiles:</p>
<img alt="../_images/448-1.png" class="align-center" src="../_images/448-1.png" />
<p>Following this pattern, we can calculate the number of map units covered by a single
pixel on the map, for a given zoom level, using the following formula:</p>
<img alt="../_images/449-0.png" class="align-center" src="../_images/449-0.png" />
<p>Since we’ll be using this formula in our TMS server, let’s go ahead and add the
following code to the end of our tms.py module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_unitsPerPixel</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.703125</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">zoomLevel</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Notice that we start the function name with an underscore; this is a standard Python convention for naming “private” functions within a module.</p>
</div>
<p>You’ll also need to add an import math statement to the top of the file.</p>
<p>Next, we need to add some constants to the top of the module to define the size of
each map tile, and how many zoom levels we support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_ZOOM_LEVEL</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">TILE_WIDTH</span>     <span class="o">=</span> <span class="mi">256</span>
<span class="n">TILE_HEIGHT</span>    <span class="o">=</span> <span class="mi">256</span>
</pre></div>
</div>
<p>With all this, we’re finally ready to implement the tileMap() function to return
information about the available Tile Sets for a given shapefile’s Tile Map. Edit this
function to look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tileMap</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">baseURL</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;TileMap version=&quot;1.0&quot; &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;tilemapservice=&quot;&#39;</span> <span class="o">+</span> <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Title&gt;&#39;</span> <span class="o">+</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&lt;/Title&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Abstract&gt;&lt;/Abstract&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;SRS&gt;EPSG:4326&lt;/SRS&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;BoundingBox minx=&quot;-180&quot; miny=&quot;-90&quot; &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;maxx=&quot;180&quot; maxy=&quot;90&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;Origin x=&quot;-180&quot; y=&quot;-90&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileFormat width=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s1">&#39;&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TILE_HEIGHT</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;mime-type=&quot;image/png&quot; extension=&quot;png&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;TileSets profile=&quot;global-geodetic&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zoomLevel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_ZOOM_LEVEL</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">unitsPerPixel</span> <span class="o">=</span> <span class="n">_unitsPerPixel</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    &lt;TileSet href=&quot;&#39;</span> <span class="o">+</span>
                        <span class="n">baseURL</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39;&quot; units-per-pixel=&quot;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">unitsPerPixel</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s1">&#39;&quot; order=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">zoomLevel</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &lt;/TileSets&gt;&#39;</span><span class="p">)</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/TileMap&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/xml&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>As you can see, we start with some basic error checking on the version and shapefile
ID, and then iterate through the available zoom levels to provide information about
the available Tile Sets.</p>
<p>If you save your changes and enter <a class="reference external" href="http://127.0.0.1:8000/tms/1.0/2">http://127.0.0.1:8000/tms/1.0/2</a> into your
web browser, you should see the following information about the Tile Map for the
shapefile object with record ID 2:</p>
<img alt="../_images/451-0.png" class="align-center" src="../_images/451-0.png" />
<p>Notice that we provide a total of eleven zoom levels, from zero to ten, with an
appropriately-calculated units-per-pixel value for each zoom level.</p>
<p>We have now implemented three of the four view functions required to implement
our own Tile Map Server. For the final function, tile(), we are going to write
our own tile renderer. The tile() function accepts a Tile Map Service version,
a shapefile ID, a zoom level, and the X and Y coordinates for the desired tile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This function needs to generate the appropriate map tile and return the rendered
image back to the caller. Before we implement this function, let’s take a step back
and think about what the map rendering should look like.</p>
<p>We want the map to include the outline of the various features within the given
shapefile. However, by themselves these features won’t look very meaningful:</p>
<img alt="../_images/452-0.png" class="align-center" src="../_images/452-0.png" />
<p>It isn’t until these features are shown in context, by displaying a <strong>base map</strong> behind the
features, that we can see what they are supposed to represent:</p>
<img alt="../_images/452-1.png" class="align-center" src="../_images/452-1.png" />
<p>Because of this, we’re going to have to display a base map on which the features
themselves are drawn. Let’s build that base map, and then we can use this, along
with the shapefile’s features, to render the map tiles.</p>
</div>
</div>
<section id="id2">
<h3>设置基础地图<a class="headerlink" href="#id2" title="此标题的永久链接">#</a></h3>
<p>Setting up the base map</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p>为了我们的底图，我们将使用本书中多次使用的《世界边界数据集》。虽然当放大时这个数据集的效果不太好，但它作为一个底图非常适合在其上绘制shapefile的特征。</p>
<p>我们将首先创建一个数据库模型来保存底图的数据。由于底图将特定于我们的Tile Map Server应用程序，因此我们希望为此应用程序添加一个特定的数据库表。为此，请编辑tms应用程序目录中的models.py模块，并将此文件更改为如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.gis.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BaseMap</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">MultiPolygonField</span><span class="p">(</span><span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GeoManager</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>不要忘记更改文件顶部的导入语句。</p>
</div>
<p>如您所见，我们正在存储国家名称以及它们的几何图形，这些几何图形恰好是MultiPolygons。现在，从命令行进入您的项目目录并键入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">syncdb</span>
</pre></div>
</div>
<p>这将创建BaseMap对象使用的数据库表。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>请记住，Django 1.4中存在一个错误，导致地理空间字段无法自动创建。为了解决此问题，运行Postgresql命令行客户端:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ psql shapeeditor
</pre></div>
</div>
<p>然后手动添加缺失的几何字段及其相关的空间索引，键入以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">tms_basemap</span> <span class="n">ADD</span> <span class="n">COLUMN</span> <span class="n">geometry</span> <span class="n">geometry</span><span class="p">(</span><span class="n">MultiPolygon</span><span class="p">,</span> <span class="mi">4326</span><span class="p">);</span>
<span class="n">CREATE</span> <span class="n">INDEX</span> <span class="n">tms_basemap_geometry_id</span> <span class="n">ON</span> <span class="n">tms_basemap</span> <span class="n">USING</span> <span class="n">GIST</span><span class="p">(</span><span class="n">geometry</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>现在我们有了存储底图的地方，让我们导入数据。将《世界边界数据集》shapefile的副本放在一个方便的位置，打开命令行窗口，并进入您的shapeEditor项目目录。然后键入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">shell</span>
</pre></div>
</div>
<p>这将运行一个Python交互式shell，安装了您的项目设置和路径。现在创建以下变量，将文本替换为《世界边界数据集》shapefile的绝对路径：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">shapefile</span> <span class="o">=</span> <span class="s2">&quot;/path/to/TM_WORLD_BORDERS-0.3.shp&quot;</span>
</pre></div>
</div>
<p>然后键入以下内容：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.gis.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">LayerMapping</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">shapeEditor.tms.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseMap</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapping</span> <span class="o">=</span> <span class="n">LayerMapping</span><span class="p">(</span><span class="n">BaseMap</span><span class="p">,</span> <span class="n">shapefile</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="s2">&quot;MULTIPOLYGON&quot;</span><span class="p">},</span> <span class="n">transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;iso-8859-1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapping</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>我们使用GeoDjango的LayerMapping模块将数据从shapefile导入到我们的数据库中。导入过程中，各国将按顺序显示，这将花费几秒钟。</p>
<p>完成后，您可以通过在交互式shell中键入命令来检查导入的数据，例如：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">BaseMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">246</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">BaseMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;BaseMap: Antigua and Barbuda&gt;, &lt;BaseMap: Algeria&gt;, &lt;BaseMap: Azerbaijan&gt;, &lt;BaseMap: Albania&gt;, &lt;BaseMap: Armenia&gt;, &lt;BaseMap: Angola&gt;, &lt;BaseMap: American Samoa&gt;, &lt;BaseMap: Argentina&gt;, &lt;BaseMap: Australia&gt;, &lt;BaseMap: Bahrain&gt;, &lt;BaseMap: Barbados&gt;, &lt;BaseMap: Bermuda&gt;, &lt;BaseMap: Bahamas&gt;, &lt;BaseMap: Bangladesh&gt;, &lt;BaseMap: Belize&gt;, &lt;BaseMap: Bosnia and Herzegovina&gt;, &lt;BaseMap: Bolivia&gt;, &lt;BaseMap: Burma&gt;, &lt;BaseMap: Benin&gt;, &lt;BaseMap: Solomon Islands&gt;, ...]</span>
</pre></div>
</div>
<p>如果您愿意，可以进行更多的操作；Django教程包括了如何使用交互式shell探索数据对象的多个示例。</p>
<p>因为这个底图将成为ShapeEditor项目的一部分（该应用程序没有它就无法运行），如果Django能够将这些数据视为项目源代码的一部分，那会很好。这样，如果我们需要从头开始重建数据库，底图将自动重新安装。</p>
<p>Django允许您通过创建**fixture**来实现这一点。Fixture是一组可以按需加载到数据库中的数据，可以手动加载，也可以在数据库初始化时自动加载。我们将把底图数据保存到一个fixture中，以便Django根据需要重新加载数据。</p>
<p>在tms应用程序目录中创建一个名为fixtures的目录。然后，在终端窗口中进入shapeEditor项目目录并键入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">dumpdata</span> <span class="n">tms</span> <span class="o">&gt;</span> <span class="n">shapeEditor</span><span class="o">/</span><span class="n">tms</span><span class="o">/</span><span class="n">fixtures</span><span class="o">/</span><span class="n">initial_data</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>这将为tms应用程序创建一个名为initial_data.json的fixture。如其名称所示，如果Django需要重新初始化数据库，fixture的内容将自动加载。</p>
<p>现在我们有了一个底图，让我们用它来实现我们的瓦片渲染代码。</p>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>For our base map, we’re going to use the World Borders Dataset we’ve used several times throughout this book. While this dataset doesn’t look great when zoomed right in, it works well as a base map on which we can draw the shapefile’s features.</p>
<p>We’ll start by creating a database model to hold the base map’s data. Because the
base map will be specific to our Tile Map Server application, we want to add a
database table specific to this application. To do this, edit the models.py module
inside the tms application directory, and change this file to look like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.gis.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseMap</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span>     <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">MultiPolygonField</span><span class="p">(</span><span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GeoManager</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Don’t forget to change the import statement at the top of the file.</p>
</div>
<p>As you can see, we’re storing the country names as well as their geometries, which
happen to be MultiPolygons. Now from the command line, cd into your project
directory and type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">syncdb</span>
</pre></div>
</div>
<p>This will create the database table used by the BaseMap object.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Remember that there’s a bug in Django 1.4 that prevents the
geospatial fields from being created automatically. To fix this,
run the Postgresql command-line client:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ psql shapeeditor
</pre></div>
</div>
<p>You can then manually add the missing geometry field and its
associated spatial index by typing in the following commands:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tms_basemap</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">geometry</span><span class="w"> </span><span class="n">geometry</span><span class="p">(</span><span class="n">MultiPolygon</span><span class="p">,</span><span class="w"> </span><span class="mi">4326</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">tms_basemap_geometry_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tms_basemap</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIST</span><span class="p">(</span><span class="n">geometry</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Now that we have somewhere to store the base map, let’s import the data. Place
a copy of the World Borders Dataset shapefile somewhere convenient, open up a
command line window, and cd into your shapeEditor project directory. Then type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">shell</span>
</pre></div>
</div>
<p>This runs a Python interactive shell with your project’s settings and paths installed.
Now create the following variable, replacing the text with the absolute path to the
World Borders Dataset’s shapefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">shapefile</span> <span class="o">=</span> <span class="s2">&quot;/path/to/TM_WORLD_BORDERS-0.3.shp&quot;</span>
<span class="go">Then type the following:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.gis.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">LayerMapping</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">shapeEditor.tms.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseMap</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapping</span> <span class="o">=</span> <span class="n">LayerMapping</span><span class="p">(</span><span class="n">BaseMap</span><span class="p">,</span> <span class="n">shapefile</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
<span class="go">&#39;geometry&#39; : &quot;MULTIPOLYGON&quot;}, transform=False, encoding=&quot;iso-8859-1&quot;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapping</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We’re using GeoDjango’s LayerMapping module to import the data from this
shapefile into our database. The various countries will be displayed as they are
imported, which will take a few seconds.</p>
<p>Once this has been done, you can check the imported data by typing commands
into the interactive shell, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">BaseMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">246</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">BaseMap</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;BaseMap: Antigua and Barbuda&gt;, &lt;BaseMap: Algeria&gt;, &lt;BaseMap:</span>
<span class="go">Azerbaijan&gt;, &lt;BaseMap: Albania&gt;, &lt;BaseMap: Armenia&gt;, &lt;BaseMap: Angola&gt;,</span>
<span class="go">&lt;BaseMap: American Samoa&gt;, &lt;BaseMap: Argentina&gt;, &lt;BaseMap: Australia&gt;,</span>
<span class="go">&lt;BaseMap: Bahrain&gt;, &lt;BaseMap: Barbados&gt;, &lt;BaseMap: Bermuda&gt;, &lt;BaseMap:</span>
<span class="go">Bahamas&gt;, &lt;BaseMap: Bangladesh&gt;, &lt;BaseMap: Belize&gt;, &lt;BaseMap: Bosnia and</span>
<span class="go">Herzegovina&gt;, &lt;BaseMap: Bolivia&gt;, &lt;BaseMap: Burma&gt;, &lt;BaseMap: Benin&gt;,</span>
<span class="go">&lt;BaseMap: Solomon Islands&gt;, &#39;...(remaining elements truncated)...&#39;]</span>
</pre></div>
</div>
<p>Feel free to play some more if you want; the Django tutorial includes several examples of exploring your data objects using the interactive shell.</p>
<p>Because this base map is going to be part of the ShapeEditor project itself (the
application won’t run without it), it would be good if Django could treat that
data as part of the project’s source code. That way, if we ever had to rebuild the
database from scratch, the base map would be reinstalled automatically.</p>
<p>Django allows you to do this by creating a <strong>fixture</strong>. A fixture is a set of data that can
be loaded into the database on demand, either manually, or automatically when the
database is initialized. We’ll save our base map data into a fixture so that Django
can reload that data as required.</p>
<p>Create a directory named fixtures within the tms application directory. Then, in a
terminal window, cd into the shapeEditor project directory and type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">dumpdata</span> <span class="n">tms</span> <span class="o">&gt;</span> <span class="n">shapeEditor</span><span class="o">/</span><span class="n">tms</span><span class="o">/</span><span class="n">fixtures</span><span class="o">/</span><span class="n">initial_data</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>This will create a fixture named initial_data.json for the tms application. As the
name suggests, the contents of this fixture will be loaded automatically if Django
ever has to re-initialize the database.</p>
<p>Now that we have a base map, let’s use it to implement our tile rendering code.</p>
</div>
</div>
</section>
<section id="id3">
<h3>Tile 渲染<a class="headerlink" href="#id3" title="此标题的永久链接">#</a></h3>
<p>Tile rendering</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>通过我们对Mapnik的了解，我们将实现TMS服务器的 <cite>tile()</cite> 函数。我们生成的地图将包含两层： <strong>底图层</strong> 显示底图， <strong>特征层</strong> 显示导入的shapefile中的特征。由于我们的所有数据都存储在PostGIS数据库中，因此我们将为这两层使用mapnik.PostGIS数据源。</p>
<p>我们的 <cite>tile()</cite> 函数将包括五个步骤：</p>
<ol class="arabic simple">
<li><p>解析查询参数。</p></li>
<li><p>设置地图。</p></li>
<li><p>定义底图层。</p></li>
<li><p>定义特征层。</p></li>
<li><p>渲染地图。</p></li>
</ol>
<p>让我们依次处理这些步骤。</p>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>Using our knowledge of Mapnik, we’re going to implement the TMS server’s tile()
function. Our generated map will consist of two layers: a <strong>base layer</strong> showing the base
map, and a <strong>feature layer</strong> showing the features in the imported shapefile. Since all our
data is stored in a PostGIS database, we’ll be using a mapnik.PostGIS datasource for
both layers.</p>
<p>Our tile() function will involve five steps:</p>
<ol class="arabic simple">
<li><p>Parse the query parameters.</p></li>
<li><p>Set up the map.</p></li>
<li><p>Define the base layer.</p></li>
<li><p>Define the feature layer.</p></li>
<li><p>Render the map.</p></li>
</ol>
<p>Let’s work through each of these in turn.</p>
</div>
</div>
<section id="id4">
<h4>解析查询参数<a class="headerlink" href="#id4" title="此标题的永久链接">#</a></h4>
<p>Parsing the query parameters</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>编辑 <cite>tms</cite> 应用程序的 <cite>views.py</cite> 模块，并删除我们在 <cite>tile()</cite> 函数中编写的占位代码。我们将逐步添加解析代码，首先从基本的错误检查代码开始，以确保版本号正确且 Shapefile 存在，并且再次使用 <cite>try…except</cite> 语句来捕获拼写错误和其他错误:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>
</pre></div>
</div>
<p>现在，我们需要将查询参数（Django 传递给我们的字符串）转换为整数，以便进行处理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zoom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">x</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>接下来，我们检查缩放级别是否正确:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">zoom</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">zoom</span> <span class="o">&gt;</span> <span class="n">MAX_ZOOM_LEVEL</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">Http404</span>
</pre></div>
</div>
<p>下一步是将提供的 <cite>x</cite> 和 <cite>y</cite> 参数转换为瓦片所覆盖的最小和最大纬度、经度值。这需要使用我们之前定义的 <cite>_unitsPerPixel()</cite> 函数，来计算当前缩放级别下瓦片覆盖的地球表面范围:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xExtent</span> <span class="o">=</span> <span class="n">_unitsPerPixel</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span> <span class="o">*</span> <span class="n">TILE_WIDTH</span>
<span class="n">yExtent</span> <span class="o">=</span> <span class="n">_unitsPerPixel</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span> <span class="o">*</span> <span class="n">TILE_HEIGHT</span>

<span class="n">minLong</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">xExtent</span> <span class="o">-</span> <span class="mf">180.0</span>
<span class="n">minLat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">yExtent</span> <span class="o">-</span> <span class="mf">90.0</span>
<span class="n">maxLong</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">+</span> <span class="n">xExtent</span>
<span class="n">maxLat</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">+</span> <span class="n">yExtent</span>
</pre></div>
</div>
<p>最后，我们可以添加一些基本的错误检查，以确保瓦片的坐标有效:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">minLong</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span> <span class="ow">or</span> <span class="n">maxLong</span> <span class="o">&gt;</span> <span class="mi">180</span> <span class="ow">or</span>
    <span class="n">minLat</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span> <span class="ow">or</span> <span class="n">maxLat</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">Http404</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>Edit the tms application’s views.py module, and delete the dummy code we had
in the tile() function. We’ll add our parsing code one step at a time, starting with
some basic error-checking code to ensure the version number is correct and that the
shapefile exists, and once again wrapping our code in a try…except statement to
catch typos and other errors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>
</pre></div>
</div>
<p>We now need to convert the query parameters (which Django passes to us as strings)
into integers so that we can work with them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zoom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">x</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>We can now check that the zoom level is correct:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">zoom</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">zoom</span> <span class="o">&gt;</span> <span class="n">MAX_ZOOM_LEVEL</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">Http404</span>
</pre></div>
</div>
<p>Our next step is to convert the supplied x and y parameters into the minimum and
maximum latitude and longitude values covered by the tile. This requires us to use
the _unitsPerPixel() function we defined earlier to calculate the amount of the
Earth’s surface covered by the tile for the current zoom level:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xExtent</span> <span class="o">=</span> <span class="n">_unitsPerPixel</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span> <span class="o">*</span> <span class="n">TILE_WIDTH</span>
<span class="n">yExtent</span> <span class="o">=</span> <span class="n">_unitsPerPixel</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span> <span class="o">*</span> <span class="n">TILE_HEIGHT</span>

<span class="n">minLong</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">xExtent</span> <span class="o">-</span> <span class="mf">180.0</span>
<span class="n">minLat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">yExtent</span> <span class="o">-</span> <span class="mf">90.0</span>
<span class="n">maxLong</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">+</span> <span class="n">xExtent</span>
<span class="n">maxLat</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">+</span> <span class="n">yExtent</span>
</pre></div>
</div>
<p>Finally, we can add some rudimentary error checking to ensure that the tile’s coordinates are valid:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">minLong</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span> <span class="ow">or</span> <span class="n">maxLong</span> <span class="o">&gt;</span> <span class="mi">180</span> <span class="ow">or</span>
    <span class="n">minLat</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span> <span class="ow">or</span> <span class="n">maxLat</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">Http404</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h4>设置地图<a class="headerlink" href="#id5" title="此标题的永久链接">#</a></h4>
<p>Setting up the map</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<p>现在我们准备创建 mapnik.Map 对象来表示地图。这很简单:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">,</span> <span class="n">TILE_HEIGHT</span><span class="p">,</span>
                <span class="s2">&quot;+proj=longlat +datum=WGS84&quot;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#7391ad&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<p>We’re now ready to create the mapnik.Map object to represent the map. This is trivial:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">,</span> <span class="n">TILE_HEIGHT</span><span class="p">,</span>
                <span class="s2">&quot;+proj=longlat +datum=WGS84&quot;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#7391ad&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h4>定义基础层<a class="headerlink" href="#id6" title="此标题的永久链接">#</a></h4>
<p>Defining the base layer</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>现在，我们需要定义用于绘制基础地图的图层。为此，我们必须为该图层设置一个 <cite>mapnik.PostGIS</cite> 数据源:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbSettings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATABASES</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
<span class="n">datasource</span> <span class="o">=</span> \
    <span class="n">mapnik</span><span class="o">.</span><span class="n">PostGIS</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">],</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">],</span>
                    <span class="n">dbname</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                    <span class="n">table</span><span class="o">=</span><span class="s1">&#39;tms_basemap&#39;</span><span class="p">,</span>
                    <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
                    <span class="n">geometry_field</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
                    <span class="n">geometry_table</span><span class="o">=</span><span class="s1">&#39;tms_basemap&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>正如你所见，我们从项目的 <cite>settings</cite> 模块中获取数据库名称、用户名和密码。然后，我们使用这些设置创建一个 PostGIS 数据源。使用此数据源，我们现在可以创建基础图层本身:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseLayer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;baseLayer&quot;</span><span class="p">)</span>
<span class="n">baseLayer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">datasource</span>
<span class="n">baseLayer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;baseLayerStyle&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>接下来，我们需要为图层设置样式。在本例中，我们将使用一个包含两个符号化器（symbolizer）的规则（rule）：
一个 <cite>PolygonSymbolizer</cite> 用于绘制基础地图多边形的内部，另一个 <cite>LineSymbolizer</cite> 用于绘制多边形的轮廓:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#b5d19c&quot;</span><span class="p">)))</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#404040&quot;</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">))</span>

<span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
</pre></div>
</div>
<p>最后，我们可以将基础图层及其样式添加到地图中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;baseLayerStyle&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">baseLayer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>We now want to define the layer which draws our base map. To do this, we have to
set up a mapnik.PostGIS datasource for the layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbSettings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATABASES</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
<span class="n">datasource</span> <span class="o">=</span> \
    <span class="n">mapnik</span><span class="o">.</span><span class="n">PostGIS</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">],</span>
                   <span class="n">password</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">],</span>
                   <span class="n">dbname</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                   <span class="n">table</span><span class="o">=</span><span class="s1">&#39;tms_basemap&#39;</span><span class="p">,</span>
                   <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
                   <span class="n">geometry_field</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
                   <span class="n">geometry_table</span><span class="o">=</span><span class="s1">&#39;tms_basemap&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>As you can see, we get the name of the database, the username, and the password
from our project’s settings module. We then create a PostGIS datasource using
these settings. With this data source, we can now create the base layer itself:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseLayer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;baseLayer&quot;</span><span class="p">)</span>
<span class="n">baseLayer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">datasource</span>
<span class="n">baseLayer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;baseLayerStyle&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We now need to set up the layer’s style. In this case, we’ll use a single rule with
two symbolizers: a PolygonSymbolizer which draws the interior of the base map’s
polygons, and a LineSymbolizer to draw the polygon outlines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#b5d19c&quot;</span><span class="p">)))</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#404040&quot;</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">))</span>

<span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we can add the base layer and its style to the map:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;baseLayerStyle&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">baseLayer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h4>定义要素层<a class="headerlink" href="#id7" title="此标题的永久链接">#</a></h4>
<p>Defining the feature layer</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>我们的下一个任务是添加另一个图层，以便将 Shapefile 的要素绘制到地图上。
同样，我们需要为新图层设置一个 <cite>mapnik.PostGIS</cite> 数据源:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geometry_field</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calc_geometry_field</span><span class="p">(</span><span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;(select &#39;</span> <span class="o">+</span> <span class="n">geometry_field</span> \
        <span class="o">+</span> <span class="s1">&#39; from &quot;shared_feature&quot; where&#39;</span> \
        <span class="o">+</span> <span class="s1">&#39; shapefile_id=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shapefile</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) as geom&#39;</span>

<span class="n">datasource</span> <span class="o">=</span> \
    <span class="n">mapnik</span><span class="o">.</span><span class="n">PostGIS</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">],</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">],</span>
                    <span class="n">dbname</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                    <span class="n">table</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
                    <span class="n">geometry_field</span><span class="o">=</span><span class="n">geometryField</span><span class="p">,</span>
                    <span class="n">geometry_table</span><span class="o">=</span><span class="s1">&#39;shared_feature&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在这里，我们调用 <cite>utils.calc_geometry_field()</cite> 来确定 <cite>shared_feature</cite> 表中存储几何数据的字段。</p>
<p>现在，我们可以创建新图层本身:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">featureLayer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;featureLayer&quot;</span><span class="p">)</span>
<span class="n">featureLayer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">datasource</span>
<span class="n">featureLayer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;featureLayerStyle&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>接下来，我们需要为要素图层定义样式。与之前类似，我们仍然使用单一规则，但这次会根据要素的类型选择不同的符号化器（symbolizer）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

<span class="k">if</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiPoint&quot;</span><span class="p">]:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">PointSymbolizer</span><span class="p">())</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LineString&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiLineString&quot;</span><span class="p">]:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">]:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#f7edee&quot;</span><span class="p">)))</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">))</span>

<span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
</pre></div>
</div>
<p>最后，我们将新的要素图层添加到地图中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;featureLayerStyle&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featureLayer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>Our next task is to add another layer to draw the shapefile’s features onto the map.
Once again, we’ll set up a mapnik.PostGIS datasource for the new layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geometry_field</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calc_geometry_field</span><span class="p">(</span><span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;(select &#39;</span> <span class="o">+</span> <span class="n">geometry_field</span> \
      <span class="o">+</span> <span class="s1">&#39; from &quot;shared_feature&quot; where&#39;</span> \
      <span class="o">+</span> <span class="s1">&#39; shapefile_id=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shapefile</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) as geom&#39;</span>

<span class="n">datasource</span> <span class="o">=</span> \
    <span class="n">mapnik</span><span class="o">.</span><span class="n">PostGIS</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">],</span>
                   <span class="n">password</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">],</span>
                   <span class="n">dbname</span><span class="o">=</span><span class="n">dbSettings</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                   <span class="n">table</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                   <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
                   <span class="n">geometry_field</span><span class="o">=</span><span class="n">geometryField</span><span class="p">,</span>
                   <span class="n">geometry_table</span><span class="o">=</span><span class="s1">&#39;shared_feature&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, we are calling utils.calc_geometry_field() to see which field in the shared_feature table contains the geometry we’re going to display.</p>
<p>We’re now ready to create the new layer itself:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">featureLayer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;featureLayer&quot;</span><span class="p">)</span>
<span class="n">featureLayer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">datasource</span>
<span class="n">featureLayer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;featureLayerStyle&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we want to define the styles used by the feature layer. As before, we’ll have just
a single rule, but in this case we’ll use different symbolizers depending on the type of
feature we are displaying:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

<span class="k">if</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiPoint&quot;</span><span class="p">]:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">PointSymbolizer</span><span class="p">())</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LineString&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiLineString&quot;</span><span class="p">]:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">]:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#f7edee&quot;</span><span class="p">)))</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">))</span>

<span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we can add our new feature layer to the map:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;featureLayerStyle&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">featureLayer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id8">
<h4>渲染地图图块<a class="headerlink" href="#id8" title="此标题的永久链接">#</a></h4>
<p>Rendering the map tile</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<p>在 <em>附录章节：Python 地理空间开发的 Web 框架</em> 中，我们已经探讨了如何使用 Mapnik 来渲染地图图像。
渲染地图瓦片的基本过程是相同的，不同之处在于我们不会将结果存储为磁盘上的图像文件。
相反，我们会创建一个 <cite>mapnik.Image</cite> 对象，将其转换为 PNG 格式的原始图像数据，并使用 <cite>HttpResponse</cite> 对象将数据返回给调用方:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span><span class="o">.</span><span class="n">zoom_to_box</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Box2d</span><span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span>
                                <span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">))</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">,</span> <span class="n">TILE_HEIGHT</span><span class="p">)</span>
<span class="n">mapnik</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
<span class="n">imageData</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>

<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">imageData</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>现在，我们只需要在函数的末尾添加错误捕获代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">except</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>至此，我们已完成 <cite>Tile Map Server</cite> 的 <cite>tile()</cite> 函数实现。
现在，让我们整理代码并进行测试。</p>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<p>We looked at using Mapnik to render map images in Bonus Chapter, Web Frameworks
for Python Geospatial Development. The basic process of rendering a map tile is the
same, except that we won’t be storing the results into an image file on disk. Instead,
we’ll create a mapnik.Image object, convert it into raw image data in PNG format,
and return that data back to the caller using an HttpResponse object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span><span class="o">.</span><span class="n">zoom_to_box</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Box2d</span><span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span>
                             <span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">))</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">TILE_WIDTH</span><span class="p">,</span> <span class="n">TILE_HEIGHT</span><span class="p">)</span>
<span class="n">mapnik</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
<span class="n">imageData</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>

<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">imageData</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>All that’s left now is to add our error-catching code to the end of the function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">except</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>That completes the implementation of our Tile Map Server’s tile() function. Let’s tidy up and do some testing.</p>
</div>
</div>
</section>
<section id="id9">
<h4>完成图块地图服务器<a class="headerlink" href="#id9" title="此标题的永久链接">#</a></h4>
<p>Completing the Tile Map Server</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p>由于我们在 <cite>views.py</cite> 模块中引用了一些新模块，因此需要在文件顶部添加额外的 <cite>import</cite> 语句:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapnik</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">utils</span>
</pre></div>
</div>
<p>理论上，我们的 Tile Map Server 现在应该可以运行了。让我们来测试一下。
如果你的 Django Web 服务器尚未运行，请进入 <cite>shapeEditor</cite> 项目目录，并输入以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">runserver</span>
</pre></div>
</div>
<p>启动你的 Web 浏览器，并在地址栏中输入以下 URL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">tms</span><span class="o">/</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mf">0.</span><span class="n">png</span>
</pre></div>
</div>
<p>如果一切正常，你应该会在浏览器中看到一个 256 × 256 像素的地图瓦片：</p>
<img alt="../_images/460-0.png" class="align-center" src="../_images/460-0.png" />
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><strong>遇到问题？</strong></p>
<p>如果出现错误，可能有两个常见原因：代码输入错误，或者 Shapefile 的记录 ID 不正确。
请检查你运行 <cite>python manage.py runserver</cite> 命令的终端窗口中的 Web 服务器日志。</p>
<p>当 Python 发生异常时，错误的回溯信息将会打印在该窗口中。
这些信息可以帮助你判断是否存在语法错误、其他错误，或者 <cite>Http404</cite> 异常。</p>
<p>如果你遇到 <cite>Http404</cite> 异常，很可能是 Shapefile 的记录 ID 不正确。
URL 的结构如下所示：</p>
<p><code class="docutils literal notranslate"><span class="pre">http://path/to/tms/&lt;version&gt;/&lt;shapefile_id&gt;/&lt;zoom&gt;/&lt;x&gt;/&lt;y&gt;.png</span></code></p>
<p>如果你按照本章的内容顺序进行操作，你之前导入的 <em>World Borders Dataset</em> Shapefile 的记录 ID 应该是 <cite>2</cite>。
但如果你在此期间导入了其他 Shapefile，或者在管理界面中创建了更多 Shapefile 记录，你可能需要使用不同的记录 ID。</p>
<p>要查看某个 Shapefile 的记录 ID，可以访问 <cite>http://127.0.0.1:8000/editor</cite>，
然后点击目标 Shapefile 对应的 <strong>Edit</strong> 超链接。</p>
<p>你可能会看到 <em>Page Not Found</em> 错误，但该超链接的最后一部分就是该 Shapefile 的记录 ID。
将之前 URL 中的记录 ID 替换为正确的 ID，地图瓦片应该就会正确显示。</p>
</div>
<p>当你在 Web 浏览器中成功看到地图瓦片后，恭喜你！
你已经实现了一个可运行的 <strong>Tile Map Server</strong>！ 🎉</p>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p>Because we’ve referred to some new modules in our views.py module, we’ll have to
add some extra import statements to the top of the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapnik</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">utils</span>
</pre></div>
</div>
<p>In theory, our Tile Map Server should now be ready to go. Let’s test it out. If you
don’t currently have the Django web server running, cd into the shapeEditor project
directory and type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">runserver</span>
</pre></div>
</div>
<p>Start up your web browser and enter the following URL into your browser’s
address bar:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">tms</span><span class="o">/</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mf">0.</span><span class="n">png</span>
</pre></div>
</div>
<p>All going well, you should see a 256 x 256 pixel map tile appear in your web browser:</p>
<img alt="../_images/460-0.png" class="align-center" src="../_images/460-0.png" />
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><strong>Problems?</strong></p>
<p>If an error occurs, there are two likely causes: you might have made
a mistake typing in the code, or you might have the record ID of the
shapefile wrong. Check the web server log in the terminal window
you used to run the python manage.py runserver command;</p>
<p>when a Python exception occurs, the traceback will be printed out
in this window. This will tell you if you have a syntax error, some
other error, or if an Http404 exception was raised.</p>
<p>If you do get an Http404 exception, it’s most likely because you’re
using the wrong record ID for the shapefile. The URL is structured
like this:</p>
<p><a class="reference external" href="http://path/to/tms">http://path/to/tms</a>/&lt;version&gt;/&lt;shapefile_id&gt;/&lt;zoom&gt;/&lt;x&gt;/&lt;y&gt;.png</p>
<p>If you’ve been working through this chapter in order, the record ID
of the World Borders Dataset shapefile you imported earlier should
be 2, but if you’ve imported other shapefiles in the meantime,
or created more shapefile records while playing with the admin
interface, you may need to use a different record ID. To see what
record ID a given shapefile has, go to <a class="reference external" href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a>
editor and click on the Edit hyperlink for the desired shapefile.
You’ll see a Page Not Found error, but the final part of the
hyperlink will be the record ID of the shapefile. Replace the record
ID in the previous URL with the correct ID, and the map tile should
appear.</p>
</div>
<p>Once you’ve reached the point of seeing the previous image in your web browser, you deserve a pat on the back: congratulations, you have just implemented your own working Tile Map Server!</p>
</div>
</div>
</section>
</section>
</section>
<section id="openlayers">
<h2>使用 OpenLayers 显示地图<a class="headerlink" href="#openlayers" title="此标题的永久链接">#</a></h2>
<p>Using OpenLayers to display the map</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>现在我们的 TMS 服务器已经运行起来了，我们可以使用 OpenLayers 库在 <strong>slippy map</strong> 中显示渲染的地图瓦片。
这个 slippy map 将用于我们的 <cite>edit_shapefile</cite> 视图函数，以显示 Shapefile 的所有要素，
允许用户选择要编辑的要素。</p>
<p>让我们实现 <cite>edit_shapefile</cite> 视图。
编辑 <cite>editor</cite> 应用的 <cite>urls.py</cite> 模块，并添加以下高亮部分:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;shapeEditor.editor.views&#39;</span><span class="p">,</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="s1">&#39;list_shapefiles&#39;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^import$&#39;</span><span class="p">,</span> <span class="s1">&#39;import_shapefile&#39;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^export/(?P&lt;shapefile_id&gt;\d+)$&#39;</span><span class="p">,</span> <span class="s1">&#39;export_shapefile&#39;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^edit/(?P&lt;shapefile_id&gt;\d+)$&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_shapefile&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>这样，任何符合 <cite>/editor/edit/N</cite> 形式的 URL 都会被传递给 <cite>edit_shapefile()</cite> 视图函数。</p>
<p>接下来，实现该函数。
编辑 <cite>editor</cite> 应用的 <cite>views.py</cite> 模块，并添加以下代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">edit_shapefile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseNotFound</span><span class="p">()</span>

    <span class="n">tms_url</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="n">get_host</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/tms/&quot;</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;select_feature.html&quot;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;shapefile&#39;</span><span class="p">:</span> <span class="n">shapefile</span><span class="p">,</span>
                <span class="s1">&#39;tms_url&#39;</span><span class="p">:</span> <span class="n">tms_url</span><span class="p">})</span>
</pre></div>
</div>
<p>可以看到，我们获取了目标 <cite>Shapefile</cite> 对象，计算访问 TMS 服务器的 URL，
然后将它们传递给名为 <cite>select_feature.html</cite> 的模板。
真正的地图渲染将在该模板中完成。</p>
<p>现在，我们需要编写该模板。
在 <cite>editor</cite> 应用的 <cite>templates</cite> 目录下创建一个名为 <cite>select_feature.html</cite> 的新文件，
然后输入以下内容：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ShapeEditor<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="nt">div</span><span class="p">#</span><span class="nn">map</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="kt">px</span><span class="p">;</span>
<span class="w">                </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="kt">px</span><span class="p">;</span>
<span class="w">                </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#ccc</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Edit Shapefile<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span>Please choose a feature to edit<span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;map&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;map&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;margin-left:20px&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span>
                <span class="na">onClick</span><span class="o">=</span><span class="s">&#39;window.location=&quot;/editor&quot;;&#39;</span><span class="p">&gt;</span>
                Cancel
            <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>这只是模板的基本框架，但它已经可以使用了。
在终端窗口运行 Django 服务器（<cite>python manage.py runserver</cite>），
然后访问 <cite>http://127.0.0.1:8000/editor</cite>，点击某个 Shapefile 旁的 <strong>Edit</strong> 超链接，
你应该会看到 <strong>选择要素页面</strong> 的基本框架:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">image</span><span class="p">::</span> <span class="o">./</span><span class="n">img</span><span class="o">/</span><span class="mi">463</span><span class="o">-</span><span class="mf">0.</span><span class="n">png</span>
</pre></div>
</div>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">align<span class="colon">:</span></dt>
<dd class="field-odd"><p>center</p>
</dd>
</dl>
</div></blockquote>
<p>请注意，我们在 HTML 中创建了一个 <cite>&lt;div&gt;</cite> 元素用于存放 OpenLayers 地图，
并使用 CSS 设定了地图的固定大小和边框。
但目前地图仍然不会显示，因为我们还没有编写 JavaScript 代码来启动 OpenLayers。
接下来，让我们来实现这一部分。</p>
<p>在模板的 <cite>&lt;head&gt;</cite> 部分添加以下 <cite>&lt;script&gt;</cite> 标签:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;http://openlayers.org/api/OpenLayers.js&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
    <span class="n">function</span> <span class="n">init</span><span class="p">()</span> <span class="p">{}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>同时，将 <cite>&lt;body&gt;</cite> 标签修改为:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">body</span> <span class="n">onload</span><span class="o">=</span><span class="s2">&quot;init()&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>这里包含两个 <cite>&lt;script&gt;</cite> 标签：
第一个用于从 <cite>http://openlayers.org</cite> 加载 <cite>OpenLayers.js</cite> 库，
第二个用于编写我们即将实现的 JavaScript 代码，以创建地图。
此外，我们定义了一个 <cite>init()</cite> JavaScript 函数，它会在页面加载时被调用。</p>
<p>接下来，替换 <cite>function init() {}</cite> 这一行代码，改为以下内容：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nb">Map</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">,</span>
<span class="w">                            </span><span class="p">{</span><span class="nx">maxResolution</span><span class="o">:</span><span class="w"> </span><span class="mf">0.703125</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">numZoomLevels</span><span class="o">:</span><span class="w"> </span><span class="mf">11</span><span class="p">});</span>
<span class="w">    </span><span class="nx">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">TMS</span><span class="p">(</span><span class="s1">&#39;TMS&#39;</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">&quot;{{ tms_url }}&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="p">{</span><span class="nx">serviceVersion</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">layername</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;{{ shapefile.id }}&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="p">});</span>
<span class="w">    </span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span>
<span class="w">    </span><span class="nx">map</span><span class="p">.</span><span class="nx">zoomToMaxExtent</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>即使你没有使用过 JavaScript，这段代码的逻辑也相对清晰：
- <cite>OpenLayers.Map</cite> 对象创建一个 <strong>slippy map</strong>。
- <cite>OpenLayers.Layer.TMS</cite> 对象定义了一个从 TMS 服务器获取地图数据的图层。
- 然后我们将该图层添加到地图，并将地图缩放到最大范围，以便用户可以看到整个世界地图。</p>
<p>注意：
- <cite>OpenLayers.Map</cite> 需要传递 <cite>div</cite> 的 <cite>ID</cite> 以确定地图的容器，并可以接受一个选项字典：
- <cite>maxResolution</cite> 指定地图的最大分辨率。
- <cite>numZoomLevels</cite> 设定地图的缩放级别数。
- <cite>OpenLayers.Layer.TMS</cite> 需要传递 TMS 服务器的 <cite>URL`（由 Python 视图函数传递给模板），
还需要 `Tile Map Service</cite> 版本以及 <a href="#id10"><span class="problematic" id="id11">`</span></a>layername`（即 Shapefile 的记录 ID）。</p>
<p>到此，我们已经完成了 <strong>基本的 slippy map</strong> 实现！
保存更改，并确保 Django 服务器正在运行。
访问 <cite>http://127.0.0.1:8000/editor</cite>，点击某个 Shapefile 旁的 <strong>Edit</strong> 超链接，
你应该会看到工作中的 slippy map:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">image</span><span class="p">::</span> <span class="o">./</span><span class="n">img</span><span class="o">/</span><span class="mi">465</span><span class="o">-</span><span class="mf">0.</span><span class="n">png</span>
</pre></div>
</div>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">align<span class="colon">:</span></dt>
<dd class="field-odd"><p>center</p>
</dd>
</dl>
</div></blockquote>
<p>你现在可以进行 <strong>缩放、平移、点击</strong> 交互。
当然，目前的交互功能仍然有限（除了 <strong>Cancel 按钮</strong>），
但我们已经成功集成了 <strong>Tile Map Server</strong> 与 OpenLayers JavaScript 组件！ 🎉</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><strong>如果地图未能正确显示怎么办？</strong></p>
<p>如果地图没有正确显示，可能有多个原因：
- 首先，检查 Django 服务器日志，任何 Python 异常都会在那里打印出来。
- 如果 Django 服务器日志没有错误，请打开浏览器的 <strong>错误控制台</strong>，查看 JavaScript 是否报错。
- 由于我们现在正在编写 JavaScript 代码，错误信息可能会出现在 <strong>浏览器端</strong>，而不是 Django 服务器日志中。
- 在 <strong>Firefox</strong> 中，可以从 <strong>工具**（Tools）菜单中选择 **错误控制台**（Error Console）。
- 其他浏览器也有类似的 **JavaScript 错误日志窗口</strong>。</p>
<p>JavaScript 调试对 Web 开发人员来说可能会有些棘手，即使是有经验的开发者也是如此。
如果你遇到了困难，可以参考这篇文章进行 JavaScript 调试：
<cite>http://www.webmonkey.com/2010/02/javascript_debugging_for_beginners</cite></p>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>Now that we have our TMS server up and running, we can use the OpenLayers
library to display the rendered map tiles within a slippy map. This slippy map
will be used within our edit shapefile view function to display all the shapefile’s
features, allowing the user to select a feature within the shapefile to edit.</p>
<p>Let’s implement this edit shapefile view. Edit the urls.py module within the
editor application, and add the following highlighted entry to this file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;shapeEditor.editor.views&#39;</span><span class="p">,</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="s1">&#39;list_shapefiles&#39;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^import$&#39;</span><span class="p">,</span> <span class="s1">&#39;import_shapefile&#39;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^export/(?P&lt;shapefile_id&gt;\d+)$&#39;</span><span class="p">,</span> <span class="s1">&#39;export_shapefile&#39;</span><span class="p">),</span>
        <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^edit/(?P&lt;shapefile_id&gt;\d+)$&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_shapefile&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This will pass any incoming URLs of the form /editor/edit/N to the
edit_shapefile() view function.</p>
<p>Let’s implement that function. Edit the editor application’s views.py module
and add the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">edit_shapefile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">shapefile_id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseNotFound</span><span class="p">()</span>

    <span class="n">tms_url</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="n">get_host</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/tms/&quot;</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;select_feature.html&quot;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;shapefile&#39;</span> <span class="p">:</span> <span class="n">shapefile</span><span class="p">,</span>
                <span class="s1">&#39;tms_url&#39;</span><span class="p">:</span> <span class="n">tms_url</span><span class="p">})</span>
</pre></div>
</div>
<p>As you can see, we obtain the desired Shapefile object, calculate the URL used to
access our TMS server, and pass both on to a template called select_feature.html.
That template is where all the hard work will take place.</p>
<p>Now we need to write the template. Start by creating a new file named select_feature.html in the editor application’s templates directory, and enter the following into this file:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ShapeEditor<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="nt">div</span><span class="p">#</span><span class="nn">map</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="kt">px</span><span class="p">;</span>
<span class="w">                </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="kt">px</span><span class="p">;</span>
<span class="w">                </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#ccc</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Edit Shapefile<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span>Please choose a feature to edit<span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;map&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;map&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;margin-left:20px&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span>
                <span class="na">onClick</span><span class="o">=</span><span class="s">&#39;window.location=&quot;/editor&quot;;&#39;</span><span class="p">&gt;</span>
                Cancel
            <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>This is only the basic outline for this template, but it gives us something to work with. With the Django development server running (<strong>python manage.py runserver</strong> in a terminal window), go to <a class="reference external" href="http://127.0.0.1:8000/editor">http://127.0.0.1:8000/editor</a> click on the <strong>Edit</strong> hyperlink for a shapefile. You should see the basic outline for the select feature page:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">image</span><span class="p">::</span> <span class="o">./</span><span class="n">img</span><span class="o">/</span><span class="mi">463</span><span class="o">-</span><span class="mf">0.</span><span class="n">png</span>
</pre></div>
</div>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">align<span class="colon">:</span></dt>
<dd class="field-odd"><p>center</p>
</dd>
</dl>
</div></blockquote>
<p>Notice that we created a &lt;div&gt; element to hold the OpenLayers map, and we use
a CSS stylesheet to give the map a fixed size and border. The map itself isn’t being
displayed yet, because we haven’t written the JavaScript code needed to launch
OpenLayers. Let’s do that now.</p>
<p>Add the following &lt;script&gt; tags to the &lt;head&gt; section of your template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;http://openlayers.org/api/OpenLayers.js&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
    <span class="n">function</span> <span class="n">init</span><span class="p">()</span> <span class="p">{}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Also, change the &lt;body&gt; tag definition to look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">body</span> <span class="n">onload</span><span class="o">=</span><span class="s2">&quot;init()&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Notice that there are two &lt;script&gt; tags: the first loads the OpenLayers.js library
from the <a class="reference external" href="http://openlayers.org">http://openlayers.org</a> website, while the second will hold the JavaScript
code that we’ll write to create the map. We’ve also defined a JavaScript function
called init() which will be called when the page is loaded.</p>
<p>Let’s implement that initialization function. Replace the line which says function
init() {} with the following:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nb">Map</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">,</span>
<span class="w">                            </span><span class="p">{</span><span class="nx">maxResolution</span><span class="o">:</span><span class="w"> </span><span class="mf">0.703125</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">numZoomLevels</span><span class="o">:</span><span class="w"> </span><span class="mf">11</span><span class="p">});</span>
<span class="w">    </span><span class="nx">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">TMS</span><span class="p">(</span><span class="s1">&#39;TMS&#39;</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">&quot;{{ tms_url }}&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="p">{</span><span class="nx">serviceVersion</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">layername</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;{{ shapefile.id }}&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="p">});</span>
<span class="w">    </span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span>
<span class="w">    </span><span class="nx">map</span><span class="p">.</span><span class="nx">zoomToMaxExtent</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Even if you haven’t used JavaScript before, this code should be quite straightforward:
the first instruction creates an OpenLayers.Map object representing the slippy map.
We then create an OpenLayers.Layer.TMS object to represent a map layer that takes
data from a TMS server. Then we add the layer to the map, and zoom the map out as
far as possible so that the user sees the entire world when the map is first displayed.</p>
<p>Notice that the Map object accepts the ID of the &lt;div&gt; tag in which to place the map,
along with a dictionary of options. The maxResolution option defines the maximum
resolution to use for the map, and the numZoomLevels option tells OpenLayers how
many zoom levels the map should support.</p>
<p>For the Layer.TMS object, we pass in the URL used to access the Tile Map Server
(which is a parameter passed to the template from our Python view), along with the
version of the Tile Map Service to use and the name of the layer—which in our Tile
Map Server is the record ID of the shapefile to display the features for.</p>
<p>That’s all we need to do to get a basic slippy map working with OpenLayers. Save
your changes, start up the Django web server if it isn’t already running, and point
your web browser to <a class="reference external" href="http://127.0.0.1:8000/editor">http://127.0.0.1:8000/editor</a>. Click on the Edit hyperlink
for the shapefile you imported, and you should see the working slippy map:</p>
<img alt="../_images/465-0.png" class="align-center" src="../_images/465-0.png" />
<p>You can zoom in and out, pan around, and click to your heart’s content. Of course,
nothing actually works yet (apart from the Cancel button), but we have got a slippy
map working with our Tile Map Server and the OpenLayers JavaScript widget.
That’s quite an achievement!</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><strong>What if it doesn’t work?</strong></p>
<p>If the map isn’t being shown for some reason, there are several
possible causes. First, check the Django web server log, as we
are printing any Python exceptions there. If that doesn’t reveal
the problem, look at your web browser’s error console window
to see if there are any errors at the JavaScript level. Because we
are now writing JavaScript code, error messages will appear
within the web browser rather than in Django’s server log. In
Firefox, you can view JavaScript errors by selecting the <strong>Error</strong>
<strong>Console</strong> item from the <strong>Tools</strong> menu. Other browsers have
similar windows for showing JavaScript errors.</p>
<p>JavaScript debugging can be quite tricky, even for people
experienced with developing web-based applications. If you do
get stuck, you may find the following article helpful: <a class="reference external" href="http://">http://</a>
www.webmonkey.com/2010/02/javascript_debugging_for_beginners</p>
</div>
</div>
</div>
</section>
<section id="id12">
<h2>拦截鼠标点击<a class="headerlink" href="#id12" title="此标题的永久链接">#</a></h2>
<p>Intercepting mouse clicks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p>当用户点击地图时，我们需要拦截该鼠标点击事件，识别用户点击的地图坐标，然后请求服务器识别被点击的要素（如果有的话）。为了拦截鼠标点击事件，我们需要创建一个自定义的 <cite>OpenLayers.Control</cite> 子类。按照 OpenLayers 的惯例，我们将这个子类添加到 OpenLayers 命名空间，并将其命名为 <cite>OpenLayers.Control.Click</cite>。定义好这个新控件后，我们可以创建其实例，并将其添加到地图上，以便它可以响应鼠标点击。</p>
<p>所有这些都需要使用 JavaScript 实现。这段代码可能有些复杂，所以我们一步一步来。编辑你的 <cite>selectFeature.html</cite> 文件，并在 <cite>&lt;script&gt;</cite> 标签内的 <cite>init()</cite> 函数之前添加以下代码：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Click</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Class</span><span class="p">(</span>
<span class="w">    </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">defaultHandlerOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;single&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;double&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;pixelTolerance&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;stopSingle&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;stopDouble&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">initialize</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Util</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
<span class="w">                </span><span class="p">{},</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">defaultHandlerOptions</span><span class="p">);</span>
<span class="w">            </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span>
<span class="w">                </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">arguments</span><span class="p">);</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Click</span><span class="p">(</span>
<span class="w">                </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;click&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">onClick</span><span class="p">},</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span><span class="p">);</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nx">onClick</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>不要太担心这里的具体细节——<cite>initialize()</cite> 函数有点像“黑魔法”，它创建了一个 <cite>OpenLayers.Control.Click</cite> 实例，并将其设置为 OpenLayers 控件。我们关注的重点是 <cite>defaultHandlerOptions</cite> 字典和 <cite>onClick()</cite> 函数。</p>
<p><cite>defaultHandlerOptions</cite> 字典告诉 OpenLayers 你希望点击处理程序如何响应鼠标点击。在这个例子中，我们希望响应单击事件，但不响应双击事件（因为双击用于放大地图）。</p>
<p><cite>onClick()</cite> 函数实际上是 <cite>OpenLayers.Control.Click</cite> 类的 JavaScript 方法。当用户在地图上点击时，这个方法会被调用——目前，我们只是简单地弹出一个 <cite>alert</cite> 对话框显示 “click”，但这足以确认点击控件已经生效。</p>
<p>现在，我们已经定义了新的点击控件，让我们将其添加到地图中。在 <cite>init()</cite> 函数的 <cite>}</cite> 之前立即添加以下代码：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">click</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Click</span><span class="p">();</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="nx">click</span><span class="p">);</span>
<span class="nx">click</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
</pre></div>
</div>
<p>如你所见，我们创建了 <cite>OpenLayers.Control.Click</cite> 类的一个新实例，将其添加到地图中，并激活它。</p>
<p>完成所有这些代码后，我们现在可以重新加载 “Select Feature” 网页，并查看用户在地图上点击时会发生什么：</p>
<img alt="../_images/468-0.png" class="align-center" src="../_images/468-0.png" />
<p>目前为止，一切正常。请注意，我们的点击处理程序仅拦截单击事件；如果你在地图上双击，它仍然会放大。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你的地图无法正常工作，你可能在输入 JavaScript 代码时出了错。请打开浏览器的 JavaScript 控制台或日志窗口，并重新加载页面。如果 JavaScript 代码存在问题，错误信息会出现在该窗口中。</p>
</div>
<p>现在，让我们实现真正的 <cite>onClick()</cite> 函数，以响应用户的鼠标点击。当用户点击地图时，我们将使用 AJAX 请求向服务器发送被点击点的纬度和经度值。服务器将返回被点击要素的编辑页面 URL，如果没有点击到要素，则返回空字符串。如果返回了 URL，我们将重定向用户的浏览器到该 URL。</p>
<p>为了发起 AJAX 请求，我们将使用 <cite>OpenLayers.Request.GET</cite> 函数，并传入一个回调函数，当服务器返回响应时，该回调函数将被调用。我们先编写 AJAX 调用代码。</p>
<p>用以下代码替换之前的 <cite>onClick()</cite> 函数：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">onClick</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">map</span><span class="p">.</span><span class="nx">getLonLatFromViewPortPx</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">xy</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">GET</span><span class="p">({</span>
<span class="w">        </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;{{ find_feature_url }}&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">shapefile_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="nx">shapefile</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">}},</span>
<span class="w">                    </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">coord</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">coord</span><span class="p">.</span><span class="nx">lon</span><span class="p">},</span>
<span class="w">        </span><span class="nx">callback</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handleResponse</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这个函数做了两件事：</p>
<ol class="arabic simple">
<li><p>通过 <cite>map.getLonLatFromViewPortPx()</cite> 方法获取被点击点的地图坐标。</p></li>
<li><p>创建 <cite>OpenLayers.Request.GET</cite> 对象，向服务器发送 AJAX 请求，并在收到响应时调用 <cite>handleResponse()</cite> 回调函数。</p></li>
</ol>
<p>请注意，<cite>OpenLayers.Request.GET()</cite> 函数接受一组查询参数（在 <cite>params</cite> 里），以及要发送请求的 <cite>url</cite>，以及当接收到响应时调用的 <cite>callback</cite> 函数。我们使用模板参数 <cite>{{ find_feature_url }}</cite> 来指定请求的 URL。当模板加载时，该 URL 将由 <cite>edit_shapefile()</cite> 视图函数提供。发起请求时，查询参数将包含 shapefile 记录的 ID 以及点击的纬度和经度。</p>
<p>在编辑 <cite>select_feature.html</cite> 模板时，让我们实现回调函数。在 <cite>OpenLayers.Control.Click</cite> 类定义的 <cite>onClick()</cite> 函数 <cite>}</cite> 结束括号下方，添加以下函数：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">handleResponse</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Server returned a &quot;</span><span class="o">+</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="o">+</span><span class="s2">&quot; error&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>确保在 <cite>onClick()</cite> 函数的结束括号后添加一个逗号，否则会导致 JavaScript 语法错误。就像在 Python 中一样，JavaScript 也需要逗号来分隔字典项。</p>
</div>
<p>即使你不熟悉 JavaScript，这个函数也很容易理解：
- 如果服务器返回的 <cite>status</cite> 不是 200，则弹出错误消息。
- 否则，我们检查 <cite>responseText</cite> 是否为空，如果不为空，则重定向用户的浏览器到该 URL。</p>
<p>现在，我们已经实现了回调函数，让我们回到 <cite>view.py</cite> 模块，并定义 <cite>find_feature_url</cite> 参数，以便将其传递给我们创建的模板。在 <cite>edit_shapefile()</cite> 函数中添加以下高亮部分：</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">def</span><span class="w"> </span><span class="nx">edit_shapefile</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="nx">shapefile_id</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="k">try</span><span class="o">:</span>
<span class="w">        </span><span class="nx">shapefile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Shapefile</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="nx">shapefile_id</span><span class="p">)</span>
<span class="w">    </span><span class="nx">except</span><span class="w"> </span><span class="nx">Shapefile</span><span class="p">.</span><span class="nx">DoesNotExist</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">HttpResponseNotFound</span><span class="p">()</span>

<span class="w">    </span><span class="nx">tms_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http://&quot;</span><span class="o">+</span><span class="nx">request</span><span class="p">.</span><span class="nx">get_host</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/tms/&quot;</span>
<span class="w">    </span><span class="nx">find_feature_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http://&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">get_host</span><span class="p">()</span><span class="w"> </span><span class="o">\</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;/editor/find_feature&quot;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;select_feature.html&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="p">{</span><span class="s1">&#39;shapefile&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">shapefile</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;find_feature_url&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">find_feature_url</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;tms_url&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">tms_url</span><span class="p">})</span>
</pre></div>
</div>
<p><cite>find_feature_url</cite> 模板参数将包含点击处理程序发送 AJAX 请求的 URL。该 URL 可能如下所示：</p>
<p><a class="reference external" href="http://127.0.0.1:8000/editor/find_feature">http://127.0.0.1:8000/editor/find_feature</a></p>
<p>我们的 <cite>onClick()</cite> 函数会为该请求附加 <cite>shapefile_id</cite>、<cite>latitude</cite> 和 <cite>longitude</cite> 查询参数，因此最终的 AJAX 请求将如下所示：</p>
<p><a class="reference external" href="http://127.0.0.1:8000/editor/find_feature?shapefile_id=1&amp;latitude=-38.1674&amp;longitude=176.2344">http://127.0.0.1:8000/editor/find_feature?shapefile_id=1&amp;latitude=-38.1674&amp;longitude=176.2344</a></p>
<p>现在，我们的点击处理程序已经可以正常运行，接下来我们准备实现 <cite>find_feature()</cite> 视图函数，以响应这些 AJAX 请求。</p>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>When the user clicks on the map, we want to intercept that mouse click, identify
the map coordinate that the user clicked on, and then ask the server to identify the
clicked-on feature (if any). To intercept mouse clicks, we will need to create a custom
OpenLayers.Control subclass. We’ll follow the OpenLayers convention of adding
the subclass to the OpenLayers namespace, by calling our new control OpenLayers.
Control.Click. Once we’ve defined our new control, we can create an instance of
the control and add it to the map so that the control can respond to mouse clicks.</p>
<p>All of this has to be done in JavaScript. The code can be a bit confusing, so let’s take
this one step at a time. Edit your selectFeature.html file and add the following
code to the &lt;script&gt; tag, immediately before your init() function:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Click</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Class</span><span class="p">(</span>
<span class="w">    </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">defaultHandlerOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;single&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;double&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;pixelTolerance&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;stopSingle&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;stopDouble&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">initialize</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Util</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
<span class="w">                </span><span class="p">{},</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">defaultHandlerOptions</span><span class="p">);</span>
<span class="w">            </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span>
<span class="w">                </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">arguments</span><span class="p">);</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Click</span><span class="p">(</span>
<span class="w">                </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;click&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">onClick</span><span class="p">},</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span><span class="p">);</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nx">onClick</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Don’t worry too much about the details here—the initialize() function is
a bit of black magic that creates a new OpenLayers.Control.Click instance
and sets it up to run as an OpenLayers control. What is interesting to us is the
defaultHandlerOptions dictionary, and the onClick() function.</p>
<p>The defaultHandlerOptions dictionary tells OpenLayers how you want the
click handler to respond to mouse clicks. In this case, we want to respond to single
clicks, but not double clicks (as these are used to zoom further in to the map).</p>
<p>The onClick() function is actually a JavaScript method for our OpenLayers.
Control.Click class. This method will be called when the user clicks on the
map—at the moment, all we’re doing is displaying an alert box with the message
Click, but that’s enough to ensure that the click control is working.</p>
<p>Now that we’ve defined our new click control, let’s add it to the map. Add the
following lines immediately before the closing } for the init() function:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">click</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Click</span><span class="p">();</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="nx">click</span><span class="p">);</span>
<span class="nx">click</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
</pre></div>
</div>
<p>As you can see, we create a new instance of our OpenLayers.Control.Click class,
add it to the map, and activate it.</p>
<p>With all this code written, we can now reload the Select Feature web page and see what happens when the user clicks on a map:</p>
<img alt="../_images/468-0.png" class="align-center" src="../_images/468-0.png" />
<p>So far so good. Notice that our click handler only intercepts single clicks; if you
double-click on the map, it will still zoom in.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If your map isn’t working, you may have made a mistake typing in the JavaScript code. Open your browser’s JavaScript console or log window, and reload the page. An error message will appear in this window if there is a problem with your JavaScript code.</p>
</div>
<p>Let’s now implement the real onClick() function to respond to the user’s mouse-
click. When the user clicks on the map, we’re going to send the clicked-on latitude
and longitude value to the server using an AJAX request. The server will return
the URL of the edit feature page for the clicked-on feature, or an empty string if no
feature was clicked on. If a URL was returned, we’ll then redirect the user’s web
browser to that URL.</p>
<p>To make the AJAX call, we’re going to use the OpenLayers.Request.GET function,
passing in a callback function which will be called when a response is received back
from the server. Let’s start by writing the AJAX call.</p>
<p>Replace our dummy onClick() function with the following:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">onClick</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">map</span><span class="p">.</span><span class="nx">getLonLatFromViewPortPx</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">xy</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">GET</span><span class="p">({</span>
<span class="w">        </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;{{ find_feature_url }}&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">shapefile_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="nx">shapefile</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">}},</span>
<span class="w">                 </span><span class="nx">latitude</span><span class="o">:</span><span class="w"> </span><span class="nx">coord</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span>
<span class="w">                 </span><span class="nx">longitude</span><span class="o">:</span><span class="w"> </span><span class="nx">coord</span><span class="p">.</span><span class="nx">lon</span><span class="p">},</span>
<span class="w">        </span><span class="nx">callback</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handleResponse</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function does two things: it obtains the map coordinate that corresponds to
the clicked-on point (by calling the map.getLonLatFromViewPortPx() method),
and then it creates an OpenLayers.Request.GET object to send the AJAX request
to the server and call the handleResponse() callback function when the response
is received.</p>
<p>Notice that the OpenLayers.Request.GET() function accepts a set of query
parameters (in the params entry), as well as a URL to send the request to (in the url
entry) and a callback function to call when the response is received (in the callback
entry). We’re using a template parameter, {{ find_feature_url }}, to select
the URL to send the request to. This will be provided by our edit_shapeFile()
view function when the template is loaded. When we make the request, the query
parameters will consist of the record ID of the shapefile and the clicked-on latitude
and longitude values.</p>
<p>While we’re editing the select_feature.html template, let’s go ahead and implement the callback function. Add the following function to the end of the OpenLayers.Control.Click class definition (immediately below the closing } for the onClick() function):</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">handleResponse</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Server returned a &quot;</span><span class="o">+</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="o">+</span><span class="s2">&quot; error&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Make sure you add a comma after the onClick() function’s closing parenthesis, or you’ll get a JavaScript error. Just as with Python, you need to add commas to separate dictionary entries in JavaScript.</p>
</div>
<p>Even if you’re not familiar with JavaScript, this function should be easy to
understand: if the response didn’t have a status value of 200, an error message is
displayed. Otherwise, we check that the response text is not blank, and if so we
redirect the user’s web browser to that URL.</p>
<p>Now that we’ve implemented our callback function, let’s go back to our view module
and define the find_feature_url parameter which will get passed to the template
we’ve created. Edit the view.py module to add the following highlighted lines to the
edit_shapefile() function:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">def</span><span class="w"> </span><span class="nx">edit_shapefile</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="nx">shapefile_id</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="k">try</span><span class="o">:</span>
<span class="w">        </span><span class="nx">shapefile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Shapefile</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="nx">shapefile_id</span><span class="p">)</span>
<span class="w">    </span><span class="nx">except</span><span class="w"> </span><span class="nx">Shapefile</span><span class="p">.</span><span class="nx">DoesNotExist</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">HttpResponseNotFound</span><span class="p">()</span>

<span class="w">    </span><span class="nx">tms_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http://&quot;</span><span class="o">+</span><span class="nx">request</span><span class="p">.</span><span class="nx">get_host</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/tms/&quot;</span>
<span class="w">    </span><span class="nx">find_feature_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http://&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">get_host</span><span class="p">()</span><span class="w"> </span><span class="o">\</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;/editor/find_feature&quot;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;select_feature.html&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="p">{</span><span class="s1">&#39;shapefile&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">shapefile</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">&#39;find_feature_url&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">find_feature_url</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">&#39;tms_url&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">tms_url</span><span class="p">})</span>
</pre></div>
</div>
<p>The find_feature_url template parameter will contain the URL the click handler
will send its AJAX request to. This URL will look like the following:</p>
<p><a class="reference external" href="http://127.0.0.1:8000/editor/find_feature">http://127.0.0.1:8000/editor/find_feature</a></p>
<p>Our onClick() function will add shapefile_id, latitude and longitude
query parameters to this request, so the AJAX request sent to the server will
look like the following:</p>
<p><a class="reference external" href="http://127.0.0.1:8000/editor/find_feature?shapefile_id=1&amp;latitude=-38.1674&amp;longitude=176.2344">http://127.0.0.1:8000/editor/find_feature?shapefile_id=1&amp;latitude=-38.1674&amp;longitude=176.2344</a></p>
<p>With our click handler up and running, we’re now ready to start implementing the
find_feature() view function to respond to these AJAX requests.</p>
</div>
</div>
</section>
<section id="id13">
<h2>实现查找特征视图<a class="headerlink" href="#id13" title="此标题的永久链接">#</a></h2>
<p>Implementing the find feature view</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p>我们现在需要编写视图函数来接收 AJAX 请求，检查用户是否点击了某个要素（如果有的话），并返回一个合适的 URL，以便将用户的浏览器重定向到该要素的“编辑”页面。为此，我们将利用 GeoDjango 的 <strong>空间查询函数</strong>。</p>
<p>让我们先添加 <cite>find_feature</cite> 视图。编辑 <cite>views.py</cite>，并添加以下占位代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_feature</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>返回一个空字符串告诉我们的 AJAX 回调函数没有点击任何要素。我们稍后会用适当的空间查询替换它。但首先，我们需要添加一个 URL 模式，使传入的请求能够被转发到 <cite>find_feature()</cite> 视图函数。打开 <cite>urls.py</cite> 模块，并在 URL 模式列表中添加以下条目：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^find_feature$&#39;</span><span class="p">,</span> <span class="s1">&#39;find_feature&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>现在，你应该可以运行 ShapeEditor，点击已上传 shapefile 的 <strong>编辑</strong> 超链接，查看显示 shapefile 内各个要素的地图，并在地图上某处点击。然而，系统的响应将是——<strong>什么也不会发生！</strong> 这是因为我们的 <cite>find_feature()</cite> 函数返回了一个空字符串，因此系统认为用户没有点击任何要素，从而忽略了鼠标点击。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在这种情况下，“什么也不会发生” 是个好消息。只要 Python 或 JavaScript 级别没有显示任何错误消息，就说明 AJAX 代码运行正常。因此，即便什么也没发生，仍然应该尝试一下，以确保代码没有错误。你可以在服务器接收的 HTTP 请求列表中看到 AJAX 请求。</p>
</div>
<p>在实现 <cite>find_feature()</cite> 之前，让我们先回顾一下“点击”一个要素的几何体意味着什么。ShapeEditor 支持各种几何类型：<cite>Point</cite>、<cite>LineString</cite>、<cite>Polygon</cite>、<cite>MultiPoint</cite>、<cite>MultiLineString</cite>、<cite>MultiPolygon</cite> 和 <cite>GeometryCollection</cite>。如果要检查用户是否点击了 <cite>Polygon</cite> 或 <cite>MultiPolygon</cite>，只需判断点击点是否在多边形的范围内即可。但 <cite>LineString</cite> 和 <cite>Point</cite> 没有内部区域（它们的面积总是零），所以点击点永远不可能“在” 这些几何体内部。它可能无限接近，但用户永远无法真正点击到 <cite>Point</cite> 或 <cite>LineString</cite> 内部。</p>
<p>这意味着以下 SQL 空间查询：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ST_Contains</span><span class="p">(</span><span class="n">feature</span><span class="p">.</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">clickPt</span><span class="p">)</span>
</pre></div>
</div>
<p>将无法满足需求，因为点击点永远不会“在” <cite>Point</cite> 或 <cite>LineString</cite> 内部。相反，我们必须允许用户点击靠近要素的位置，而不是严格地点击在其内部。为此，我们将计算一个搜索半径（单位为地图单位），然后使用 <cite>DWithin()</cite> 空间查询函数，找到在点击点给定半径范围内的所有要素。</p>
<p><strong>计算搜索半径</strong></p>
<p>我们知道用户可能在地球表面的任何地方点击，并且我们的所有要素都存储为经纬度坐标。但地图坐标（经纬度值）与地球表面的实际距离之间的关系因地理位置不同而变化。例如，在赤道上 1° 大约等于 111 公里，而在瑞典，这个距离只有赤道的一半。</p>
<p>为了在全球范围内使用一致的搜索半径，我们将使用 <cite>PROJ.4</cite> 库，根据点击点的经纬度和所需的线性距离计算地图单位中的距离。让我们将这个函数添加到 <cite>shared.utils</cite> 模块中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calc_search_radius</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s2">&quot;WGS84&quot;</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">latitude</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">longitude</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">latitude</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">longitude</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">radius</span>
</pre></div>
</div>
<p>该函数计算给定线性距离（以米为单位）在地图单位中的等效距离。它计算从起始位置出发，分别朝北、南、东、西四个方向移动指定距离后得到的新坐标。然后计算起始点与终点之间的纬度或经度差值：</p>
<img alt="../_images/473-0.png" class="align-center" src="../_images/473-0.png" />
<p>最后，取这些差值中的最大值，并将其作为搜索半径（单位为经纬度）。</p>
<p>由于 <cite>utils.py</cite> 现在使用了 <cite>pyproj</cite>，请在模块顶部添加以下导入语句：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
</pre></div>
</div>
<p>执行 <cite>DWithin()</cite> 空间查询</p>
<p>有了 <cite>calc_search_radius()</cite> 函数后，我们可以使用 <cite>DWithin()</cite> 空间查询，查找靠近点击点的所有要素。在 GeoDjango 中，我们使用 <cite>filter()</cite> 进行空间查询：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geometry__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
</pre></div>
</div>
<p>这将创建一个查询集，只返回符合 <cite>dwithin</cite> 条件的 <cite>Feature</cite> 对象。GeoDjango 会自动将该查询转换为 SQL 语句，如下所示：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ST_DWithin</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>注意 <cite>geometry__dwithin</cite> 关键字参数包含两个下划线（<cite>__</cite>）。Django 使用双下划线将字段名与过滤函数名称分隔开。</p>
</div>
<p>现在我们可以最终实现 <cite>find_feature()</cite> 视图函数。编辑 <cite>views.py</cite>，并替换 <cite>find_feature()</cite> 的主体内容：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_feature</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;shapefile_id&#39;</span><span class="p">])</span>
        <span class="n">latitude</span>     <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
        <span class="n">longitude</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calc_search_radius</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;Point&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geom_point__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LineString&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiLineString&quot;</span><span class="p">]:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geom_multilinestring__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">]:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geom_multipolygon__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;MultiPoint&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geom_multipoint__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;GeometryCollection&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geom_geometrycollection__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unsupported geometry:&quot;</span><span class="p">,</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">feature</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;/editor/edit_feature/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shapefile_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>添加以下导入语句到 <cite>views.py</cite> 顶部：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.gis.geos</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapeEditor.shared.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Feature</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapeEditor.shared</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
</pre></div>
</div>
<p><strong>测试点击功能</strong></p>
<p>现在，你可以运行 Django 服务器并点击 shapefile 中的要素。如果点击海洋，什么也不会发生——但如果点击了一个要素，你的浏览器应该会跳转到如下 URL：</p>
<p><a class="reference external" href="http://127.0.0.1:8000/editor/edit_feature/X/Y">http://127.0.0.1:8000/editor/edit_feature/X/Y</a></p>
<p>其中，<cite>X</cite> 是 shapefile 的 ID，<cite>Y</cite> 是点击的要素 ID。恭喜！你已经实现了点击选择要素的功能！ 🎉</p>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>We now need to write the view function which receives the AJAX request, checks
to see which feature was clicked on (if any), and returns a suitable URL to use to
redirect the user’s web browser to the “edit” page for that clicked-on feature. To
implement this, we’re going to make use of GeoDjango’s <strong>spatial query functions</strong>.</p>
<p>Let’s start by adding the find_feature view itself. To do this, edit views.py again
and add the following placeholder code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_feature</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Returning an empty string tells our AJAX callback function that no feature was
clicked on. We’ll replace this with some proper spatial queries shortly. First, though,
we need to add a URL pattern so that incoming requests will get forwarded to the
find_feature() view function. Open up the editor application’s urls.py module
and add the following entry to the URL pattern list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^find_feature$&#39;</span><span class="p">,</span> <span class="s1">&#39;find_feature&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>You should now be able to run the ShapeEditor, click on the <strong>Edit</strong> hyperlink for an
uploaded shapefile, see a map showing the various features within the shapefile, and
click somewhere on the map. In response, the system should do—absolutely nothing!
This is because our find_feature() function is returning an empty string, so the
system thinks that the user didn’t click on a feature and so ignores the mouse-click.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>In this case, “absolutely nothing” is good news. As long as no error messages are being displayed, either at the Python or JavaScript level, this tells us that the AJAX code is running correctly. So go ahead and try this, even though nothing happens, just to make sure that you haven’t got any bugs in your code. You should see the AJAX calls in the list of incoming HTTP requests being received by the server.</p>
</div>
<p>Before we implement the find_feature() function, let’s take a step back and
think what it means for the user to “click on” a feature’s geometry. The shapeEditor
supports a complete range of possible geometry types: Point, LineString, Polygon,
MultiPoint, MultiLineString, MultiPolygon, and GeometryCollection. Identifying if
the user clicked on a Polygon or MultiPolygon feature is straightforward enough: we
simply see if the clicked-on point is inside the polygon’s bounds. But because lines
and points have no interior (their area will always be zero), a given coordinate could
never be “inside” a Point or a LineString geometry. It might get infinitely close, but
the user can never actually click inside a Point or a LineString.</p>
<p>This means that a spatial query of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">features</span> <span class="n">WHERE</span> <span class="n">ST_Contains</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span><span class="n">clickPt</span><span class="p">)</span>
</pre></div>
</div>
<p>This is not going to work, because the click point can never be inside a Point or
a LineString geometry. Instead, we have to allow for the user clicking close to the
feature rather than within it. To do this, we’ll calculate a search radius, in map
units, and then use the DWithin() spatial query function to find all features
within the given search radius of the clicked-on point.</p>
<p>Let’s start by calculating the search radius. We know that the user might click
anywhere on the Earth’s surface, and that we are storing all our features in lat
/long coordinates. We also know that the relationship between map coordinates
(latitude/longitude values) and actual distances on the Earth’s surface varies
widely depending on whereabouts on the Earth you are: a degree at the equator
equals a distance of 111 kilometers, while a degree in Sweden is only half that far.</p>
<p>To allow for a consistent search radius everywhere in the world, we will use the
PROJ.4 library to calculate the distance in map units given the clicked-on location
and a desired linear distance. Let’s add this function to our shared.utils module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calc_search_radius</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s2">&quot;WGS84&quot;</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">latitude</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="n">longitude</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">latitude</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">angle</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">longitude</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">radius</span>
</pre></div>
</div>
<p>This function calculates the distance, in map units, of a given linear distance
measured in meters. It calculates the lat/long coordinates for four points directly
north, south, east, and west of the starting location and the given number of meters
away from that point. It then calculates the difference in latitude or longitude
between the starting location and the end point:</p>
<img alt="../_images/473-0.png" class="align-center" src="../_images/473-0.png" />
<p>Finally, it takes the largest of these differences and returns it as the search radius,
which is measured in degrees of latitude or longitude.</p>
<p>Because our utils.py module is now using pyproj, add the following import
statement to the top of this module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
</pre></div>
</div>
<p>With the calc_search_radius() function written, we can now use the DWithin()
spatial query to identify all features close to the clicked-on location. The general
process of doing this in GeoDjango is to use the filter() function to create a
spatial query, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geometry__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
</pre></div>
</div>
<p>This creates a query set that returns only the Feature objects which match the given
criteria. GeoDjango cleverly adds support for spatial queries to Django’s built-in
filtering capabilities; in this case, the geometry__dwithin=(pt, radius) parameter
tells GeoDjango to perform the dwithin() spatial query using the two supplied
parameters on the field named geometry within the Feature object. Thus, this
statement will be translated by GeoDjango into a spatial database query which looks
something as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="kn">from</span><span class="w"> </span><span class="nn">feature</span> <span class="n">WHERE</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Note that the geometry__dwithin keyword parameter includes two underscore characters; Django uses a double-underscore to separate the field name from the filter function’s name.</p>
</div>
<p>Knowing this, and having the utils.calc_search_radius() function implemented,
we can finally implement our find_feature() view function. Edit views.py and
replace the body of the find_feature() function with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_feature</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapefile_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;shapefile_id&#39;</span><span class="p">])</span>
        <span class="n">latitude</span>     <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
        <span class="n">longitude</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

        <span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calc_search_radius</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;Point&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_point__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LineString&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiLineString&quot;</span><span class="p">]:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_multilinestring__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">]:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_multipolygon__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;MultiPoint&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_multipoint__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;GeometryCollection&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_geometrycollection__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Unsupported geometry: &quot;</span> <span class="o">+</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">feature</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;/editor/edit_feature/&quot;</span> <span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">shapefile_id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>There’s a lot here, so let’s take this one step at a time. First off, we’ve wrapped all our
code inside a try…except statement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_feature</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the same technique we used when implementing the Tile Map Server; it
means that any Python errors in your code will be displayed in the web server’s
log, and the AJAX function will return gracefully rather than crashing.</p>
<p>We then extract the supplied query parameters, converting them from strings to
numbers, load the desired Shapefile object, create a GeoDjango Point object out
of the clicked-on coordinates, and calculate the search radius in degrees:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shapefile_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;shapefile_id&#39;</span><span class="p">])</span>
<span class="n">latitude</span>     <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
<span class="n">longitude</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

<span class="n">shapefile</span> <span class="o">=</span> <span class="n">Shapefile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">shapefile_id</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calc_search_radius</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we use a hardwired search radius of 100 meters; this is enough to let the
user select a point or line feature by clicking close to it, without being so large that
the user might accidentally click on the wrong feature.</p>
<p>With this done, we’re now ready to perform the spatial query. Because our Feature
object has separate fields to hold each different type of geometry, we have to build
the query based on the geometry’s type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;Point&quot;</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_point__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LineString&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiLineString&quot;</span><span class="p">]:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_multilinestring__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">]:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_multipolygon__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;MultiPoint&quot;</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_multipoint__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;GeometryCollection&quot;</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">geom_geometrycollection__dwithin</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;Unsupported geometry: &quot;</span> <span class="o">+</span> <span class="n">shapefile</span><span class="o">.</span><span class="n">geom_type</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In each case, we choose the appropriate geometry field, and use __dwithin to
perform a spatial query on the appropriate field in the Feature object.</p>
<p>Once we’ve created the appropriate spatial query, we simply check to see if the query
returned exactly one Feature. If not, we return an empty string back to the AJAX
handler’s callback function, to tell it that the user did not click on a feature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If there was exactly one matching feature, we get the clicked-on feature and use it
to build a URL redirecting the user’s web browser to the “edit feature” URL for the
clicked-on feature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">feature</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;/shape-editor/editFeature/&quot;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">shapefile_id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</pre></div>
</div>
<p>After typing in the previous code, add the following import statements to the top
of the views.py module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.gis.geos</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapeEditor.shared.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Feature</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapeEditor.shared</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
</pre></div>
</div>
<p>This completes the find_feature() view function. Save your changes, run the
Django web server if it is not already running, and try clicking on a shapefile’s
features. If you click on the ocean, nothing should happen—but if you click on
a feature, you should see your web browser redirected to a URL of the form:</p>
<p><a class="reference external" href="http://127.0.0.1:8000/shape-editor/editFeature/X/Y">http://127.0.0.1:8000/shape-editor/editFeature/X/Y</a></p>
<p>where X is the record ID of the shapefile, and Y is the record ID of the clicked-on
feature. Of course, at this stage you’ll get a <strong>Page Not Found</strong> error, because you haven’t
written that page yet. But at least you can click on a feature to select it, which is a major
milestone in the development of the ShapeEditor application. Congratulations!</p>
</div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="editring.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">编辑要素</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">11 ShapeEditor – 选择和编辑特征</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2025, Erik Westra
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">选择要编辑的要素</a><ul>
<li><a class="reference internal" href="#tile">实现 Tile 地图服务器</a><ul>
<li><a class="reference internal" href="#id2">设置基础地图</a></li>
<li><a class="reference internal" href="#id3">Tile 渲染</a><ul>
<li><a class="reference internal" href="#id4">解析查询参数</a></li>
<li><a class="reference internal" href="#id5">设置地图</a></li>
<li><a class="reference internal" href="#id6">定义基础层</a></li>
<li><a class="reference internal" href="#id7">定义要素层</a></li>
<li><a class="reference internal" href="#id8">渲染地图图块</a></li>
<li><a class="reference internal" href="#id9">完成图块地图服务器</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#openlayers">使用 OpenLayers 显示地图</a></li>
<li><a class="reference internal" href="#id12">拦截鼠标点击</a></li>
<li><a class="reference internal" href="#id13">实现查找特征视图</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/translations.js"></script>
    </body>
</html>