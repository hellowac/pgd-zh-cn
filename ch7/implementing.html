<!doctype html>
<html class="no-js" lang="zh-CN">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="应用程序审查和改进" href="aplication.html" /><link rel="prev" title="导入数据" href="importing-data.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>实现 DISTAL 应用程序 - python地理空间开发 1.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../_static/mystyles.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">python地理空间开发 1.0 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">python地理空间开发 1.0 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">内容</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about_author.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about_reviewers.html">审稿人简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch1/index.html">1 使用 Python 进行地理空间开发</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch1/python.html">Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/geo_dev.html">地理空间开发</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/applications.html">地理空间开发的应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/recent_dev.html">最新动态</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch2/index.html">2 GIS</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch2/core_concepts.html">核心 GIS 概念</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/gis_data_format.html">GIS 数据格式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/working.html">手动处理 GIS 数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch3/index.html">3 用于地理空间开发的 Python 库</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch3/rw.html">读取和写入地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/dealing_proj.html">处理投影</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/analyzing.html">分析和处理地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/visualizing.html">可视化地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch4/index.html">4 地理空间数据来源</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch4/vector_format.html">矢量格式的地理空间数据来源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/raster_format.html">栅格格式地理空间数据源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/other_format.html">其他类型地理空间数据的来源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/choosing_format.html">选择地理空间数据源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch5/index.html">5 使用 Python 处理地理空间数据</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch5/pre-req.html">先决条件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/rw.html">读取和写入地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/changing.html">更改基准和投影</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/representing.html">表示和存储地理空间数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/performing.html">执行地理空间计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/converting.html">转换和标准化几何和距离单位</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/exercises.html">练习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch6/index.html">6 数据库中的 GIS</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch6/spatially.html">空间数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/spatially-indexes.html">空间索引</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/open-source.html">支持空间功能的开源数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/commerical.html">商业空间数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/recommended.html">建议的最佳做法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/working.html">使用 Python 处理地理空间数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">7 使用空间数据</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="about-distal.html">关于 DISTAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="designing.html">设计和构建数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="downloading.html">下载数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="importing-data.html">导入数据</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">实现 DISTAL 应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="aplication.html">应用程序审查和改进</a></li>
<li class="toctree-l2"><a class="reference internal" href="summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch8/index.html">8 使用 Python 和 Mapnik 生成地图</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch8/introducing.html">Mapnik 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/creating.html">创建示例地图</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/mapnik.html">Mapnik 深度介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/mapgenerator.html">重新审视 MapGenerator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/mapdefinition.html">地图定义文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch9/index.html">9 整合所有要素——完整的地图系统</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch9/about-shapeditor.html">关于 ShapeEditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/designing-shape.html">设计 ShapeEditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/prerequisites.html">先决条件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/the-structure-ofdjango.html">Django 应用程序的结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/settingup-database.html">设置数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/settingup-shapeeditor.html">设置 ShapeEditor 项目</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/defining-shapeditor.html">定义 ShapeEditor 的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/creating-shared.html">创建共享应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/defining-datamodel.html">定义数据模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/playing.html">玩转管理系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch9/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch10/index.html">10 ShapeEditor – 实现列表视图、导入和导出</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch10/implementing.html">实现“列出 Shapefile”视图</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/importing.html">导入 Shapefile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/exporting.html">导出 shapefiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ch11/index.html">11 ShapeEditor – 选择和编辑特征</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch11/selecting.html">选择要编辑的要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch11/editring.html">编辑要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch11/adding.html">添加要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch11/deleting.html">删除要素</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch11/deleting-shapefiles.html">删除 shapefiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch11/using.html">使用 ShapeEditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch11/further.html">进一步改进和增强</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch11/summary.html">小结</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="distal">
<h1>实现 DISTAL 应用程序<a class="headerlink" href="#distal" title="此标题的永久链接">#</a></h1>
<p>Implementing the DISTAL application</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p>现在我们已经获得了数据，可以开始实现 DISTAL 应用程序了。为了简化操作，我们将使用 CGI 脚本来实现用户界面。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>CGI 脚本并不是实现 DISTAL 应用程序的唯一方法。其他可能的方法包括使用 Web 应用框架，如 TurboGears 或 Django，使用 AJAX 编写自己的动态 Web 应用，使用 CherryPy（<a class="reference external" href="http://cherrypy.org">http://cherrypy.org</a>），甚至使用像 Pyjamas（<a class="reference external" href="http://pyjs.org">http://pyjs.org</a>）这样的工具将 Python 代码编译成 JavaScript。然而，这些方法比 CGI 更复杂，我们将在本章中使用 CGI 脚本，以便尽可能简化代码。</p>
</div>
<p>让我们来看一下我们的 CGI 脚本将如何实现 DISTAL 应用程序的工作流：</p>
<a class="with-border reference internal image-reference" href="../_images/247-0.png"><img alt="../_images/247-0.png" class="with-border align-center" src="../_images/247-0.png" style="width: 530.5px; height: 876.0px;" /></a>
<p>如你所见，有三个独立的 CGI 脚本，分别是 <cite>selectCountry.py</cite>、<cite>selectArea.py</cite> 和 <cite>showResults.py</cite>，每个脚本实现了 DISTAL 应用程序的不同部分。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>什么是 CGI 脚本？</p>
<p>虽然编写 CGI 脚本的细节超出了本书的范围，但基本概念是将原始 HTML 输出打印到标准输出，并使用内置的 <cite>cgi</cite> 模块处理来自浏览器的 CGI 参数。</p>
<p>要将 Python 程序作为 CGI 脚本运行，你需要做两件事：首先，在脚本的开头添加一个 “shebang” 行，像这样：</p>
<blockquote>
<div><p>#!/usr/bin/python</p>
</div></blockquote>
<p>对于 MS Windows，添加以下行：</p>
<blockquote>
<div><p>#!C:Python27python.exe -U</p>
</div></blockquote>
<p>你使用的确切路径取决于你在计算机上安装 Python 的位置。</p>
<p>第二件事是，至少在类 Unix 系统上，需要将脚本设置为可执行。例如：</p>
<blockquote>
<div><p>chmod +x selectCountry.py</p>
</div></blockquote>
<p>更多信息，请参见网络上常见的 CGI 教程，例如：[<a class="reference external" href="http://wiki.python.org/moin/CgiScripts](http://wiki.python.org/moin/CgiScripts">http://wiki.python.org/moin/CgiScripts](http://wiki.python.org/moin/CgiScripts</a>)。</p>
</div>
<p>让我们从创建一个简单的 Web 服务器开始，它能够运行我们的 CGI 脚本。对于 Python 来说，这很简单；只需创建以下程序，我们称之为 <cite>webServer.py</cite>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">BaseHTTPServer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">CGIHTTPServer</span>

<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">CGIHTTPServer</span><span class="o">.</span><span class="n">CGIHTTPRequestHandler</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>接下来，在与 <cite>webServer.py</cite> 程序相同的目录下创建一个名为 <cite>cgi-bin</cite> 的子目录。这个子目录将保存你创建的各种 CGI 脚本。</p>
<p>运行 <cite>webServer.py</cite> 将会在 <cite>http://127.0.0.1:8000</cite> 设置一个 Web 服务器，执行你放入 <cite>cgi-bin</cite> 子目录中的任何 CGI 脚本。例如，要访问 <cite>selectCountry.py</cite> 脚本，你可以在 Web 浏览器中输入以下 URL：</p>
<p><a class="reference external" href="http://127.0.0.1:8000/cgi-bin/selectCountry.py">http://127.0.0.1:8000/cgi-bin/selectCountry.py</a></p>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p>Now that we have the data, we can start to implement the DISTAL application itself. To keep things simple, we will use CGI scripts to implement the user interface.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>CGI scripts aren’t the only way we could implement the DISTAL application. Other possible approaches include using web application frameworks such as TurboGears or Django, using AJAX to write your own dynamic web application, using CherryPy (<a class="reference external" href="http://cherrypy.org">http://cherrypy.org</a>) or even using tools such as Pyjamas (<a class="reference external" href="http://pyjs">http://pyjs</a>. org) to compile Python code into JavaScript. All of these approaches, however, are more complicated than CGI, and we will be making use of CGI scripts in this chapter to keep the code as straightforward as possible.</p>
</div>
<p>Let’s take a look at how our CGI scripts will implement the DISTAL application’s workflow:</p>
<a class="with-border reference internal image-reference" href="../_images/247-0.png"><img alt="../_images/247-0.png" class="with-border align-center" src="../_images/247-0.png" style="width: 530.5px; height: 876.0px;" /></a>
<p>As you can see, there are three separate CGI scripts, selectCountry.py, selectArea.py, and showResults.py, each implementing a distinct part of the DISTAL application.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>What is a CGI Script?</p>
<p>While the details of writing CGI scripts are beyond the scope of this
book, the basic concept is to print the raw HTML output to stdout,
and to process the incoming CGI parameters from the browser using
the built-in cgi module.</p>
<p>To run a Python program as a CGI script, you have to do two things:
first, you have to add a “shebang” line to the start of the script, like this:</p>
<blockquote>
<div><p>#!/usr/bin/python</p>
</div></blockquote>
<p>For MS Windows, add the following line:</p>
<blockquote>
<div><p>#!C:Python27python.exe -U</p>
</div></blockquote>
<p>The exact path you use will depend on where you have Python
installed on your computer.</p>
<p>The second thing you need to do, at least on Unix-like systems, is make
your script executable. For example:</p>
<blockquote>
<div><p>chmod +x selectCountry.py</p>
</div></blockquote>
<p>For more information, see one of the CGI tutorials commonly available
on the Internet, for example: <a class="reference external" href="http://wiki.python.org/moin/">http://wiki.python.org/moin/</a>
CgiScripts.</p>
</div>
<p>Let’s start by creating a simple web server capable of running our CGI scripts. With Python this is easy; simply create the following program, which we will call webServer.py:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">BaseHTTPServer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">CGIHTTPServer</span>

<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">CGIHTTPServer</span><span class="o">.</span><span class="n">CGIHTTPRequestHandler</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, create a subdirectory named cgi-bin within the same directory as your
webServer.py program. This subdirectory will hold the various CGI scripts
you create.</p>
<p>Running webServer.py will set up a web server at <a class="reference external" href="http://127.0.0.1:8000">http://127.0.0.1:8000</a>,
which will execute any CGI scripts you place into the cgi-bin subdirectory.
So, for example, to access the selectCountry.py script, you would enter the
following URL into your web browser:</p>
<p><a class="reference external" href="http://127.0.0.1:8000/cgi-bin/selectCountry.py">http://127.0.0.1:8000/cgi-bin/selectCountry.py</a></p>
</div>
</div>
<section id="id1">
<h2>共享“数据库”模块<a class="headerlink" href="#id1" title="此标题的永久链接">#</a></h2>
<p>The shared “database” module</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>为了简化操作，我们将把所有与数据库相关的代码放入一个单独的模块中，我们称之为 <cite>database.py</cite>。下面是该模块的基本结构，并实现了 <cite>database.open()</cite> 函数，我们将在 CGI 脚本中使用该函数来打开数据库连接：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># database.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely.wkt</span>

<span class="c1">##############################################################</span>
<span class="c1"># 根据需要编辑这些常量，以匹配你的设置。</span>

<span class="n">MYSQL_DBNAME</span>   <span class="o">=</span> <span class="s2">&quot;distal&quot;</span>
<span class="n">MYSQL_USERNAME</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>
<span class="n">MYSQL_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>

<span class="n">POSTGIS_DBNAME</span> <span class="o">=</span> <span class="s2">&quot;distal&quot;</span>
<span class="n">POSTGIS_USERNAME</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>
<span class="n">POSTGIS_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>

<span class="n">SPATIALITE_DB_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                    <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;distal.db&quot;</span><span class="p">)</span>

<span class="n">DB_TYPE</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>

<span class="c1">#############################################################</span>

<span class="k">def</span><span class="w"> </span><span class="nf">open</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_connection</span><span class="p">,</span> <span class="n">_cursor</span>

    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">MySQLdb</span>
        <span class="n">_connection</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">MYSQL_USERNAME</span><span class="p">,</span>
                                        <span class="n">passwd</span><span class="o">=</span><span class="n">MYSQL_PASSWORD</span><span class="p">)</span>
        <span class="n">_cursor</span> <span class="o">=</span> <span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE &quot;</span><span class="o">+</span><span class="n">MYSQL_DBNAME</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">psycopg2</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dbname=&quot;</span> <span class="o">+</span> <span class="n">POSTGIS_DBNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">POSTGIS_USERNAME</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;user=&quot;</span> <span class="o">+</span> <span class="n">POSTGIS_USERNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">POSTGIS_PASSWORD</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;password=&quot;</span> <span class="o">+</span> <span class="n">POSTGIS_PASSWORD</span><span class="p">)</span>
        <span class="n">_connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="n">_cursor</span> <span class="o">=</span> <span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pysqlite2</span><span class="w"> </span><span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">sqlite</span>
        <span class="n">_connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SPATIALITE_DBNAME</span><span class="p">)</span>
        <span class="n">_connection</span><span class="o">.</span><span class="n">enable_load_extension</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT load_extension(&quot;...&quot;)&#39;</span><span class="p">)</span>
        <span class="n">_cursor</span> <span class="o">=</span> <span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown database type: &quot;</span> <span class="o">+</span>
                            <span class="n">db_type</span><span class="p">)</span>
</pre></div>
</div>
<p>确保将此 <cite>database.py</cite> 模块放置在与 CGI 脚本相同的目录中。</p>
<p>不要忘记编辑模块顶部的常量，以匹配你特定的设置，输入适当的数据库名称、用户名和密码等。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><cite>SPATIALITE_DB_PATH</cite> 常量设置为我们 <cite>distal.db</cite> 文件的绝对路径。我们使用 Python 内置的 <cite>__file__</cite> 全局变量，避免将路径硬编码到模块中。</p>
</div>
<p>请注意，我们使用私有的全局变量（以单个下划线字符为前缀）来存储数据库连接和游标。这使得我们可以在以后访问这些变量，随着我们向模块添加更多功能。</p>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>To make things easier, we’ll put all the database-specific code into a separate module,
which we’ll call database.py. Here is the basic structure for this module, along with
the implementation of the database.open() function, which we’ll use
in our CGI scripts to open a connection to the database:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># database.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely.wkt</span>

<span class="c1">##############################################################</span>
<span class="c1"># Edit these constants as necessary to match your setup.</span>

<span class="n">MYSQL_DBNAME</span>   <span class="o">=</span> <span class="s2">&quot;distal&quot;</span>
<span class="n">MYSQL_USERNAME</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>
<span class="n">MYSQL_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>

<span class="n">POSTGIS_DBNAME</span> <span class="o">=</span> <span class="s2">&quot;distal&quot;</span>
<span class="n">POSTGIS_USERNAME</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>
<span class="n">POSTGIS_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>

<span class="n">SPATIALITE_DB_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                  <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;distal.db&quot;</span><span class="p">)</span>

<span class="n">DB_TYPE</span> <span class="o">=</span> <span class="s2">&quot;XXX&quot;</span>

<span class="c1">#############################################################</span>

<span class="k">def</span><span class="w"> </span><span class="nf">open</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_connection</span><span class="p">,</span> <span class="n">_cursor</span>

    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">MySQLdb</span>
        <span class="n">_connection</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">MYSQL_USERNAME</span><span class="p">,</span>
                                      <span class="n">passwd</span><span class="o">=</span><span class="n">MYSQL_PASSWORD</span><span class="p">)</span>
        <span class="n">_cursor</span> <span class="o">=</span> <span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE &quot;</span><span class="o">+</span><span class="n">MYSQL_DBNAME</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">psycopg2</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dbname=&quot;</span> <span class="o">+</span> <span class="n">POSTGIS_DBNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">POSTGIS_USERNAME</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;user=&quot;</span> <span class="o">+</span> <span class="n">POSTGIS_USERNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">POSTGIS_PASSWORD</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;password=&quot;</span> <span class="o">+</span> <span class="n">POSTGIS_PASSWORD</span><span class="p">)</span>
        <span class="n">_connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="n">_cursor</span> <span class="o">=</span> <span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pysqlite2</span><span class="w"> </span><span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">sqlite</span>
        <span class="n">_connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SPATIALITE_DBNAME</span><span class="p">)</span>
        <span class="n">_connection</span><span class="o">.</span><span class="n">enable_load_extension</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT load_extension(&quot;...&quot;)&#39;</span><span class="p">)</span>
        <span class="n">_cursor</span> <span class="o">=</span> <span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown database type: &quot;</span> <span class="o">+</span>
                           <span class="n">db_type</span><span class="p">)</span>
</pre></div>
</div>
<p>Make sure you place this database.py module into the same directory as your
CGI scripts.</p>
<p>Don’t forget to edit the constants at the top of the module to match your particular
setup, entering the appropriate database names, usernames and passwords, and
so on.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The SPATIALITE_DB_PATH constant is set to the absolute path to our distal.db file. We use the Python’s built-in __file__ global to avoid having to hardwire paths into our module.</p>
</div>
<p>Note that we use private global variables (prefixed with an underscore character) to
store the database connection and cursor. This lets us access these variables later on,
as we add more functions to this module.</p>
</div>
</div>
</section>
<section id="id2">
<h2>“选择国家”脚本<a class="headerlink" href="#id2" title="此标题的永久链接">#</a></h2>
<p>The “select country” script</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p><cite>selectCountry.py</cite> 脚本的任务是向用户显示一个国家列表，以便用户选择一个所需的国家，然后将所选国家传递给 <cite>selectArea.py</cite> 脚本以进行进一步处理。</p>
<p>以下是 <cite>selectCountry.py</cite> 脚本输出的样子：</p>
<a class="with-border reference internal image-reference" href="../_images/251-0.png"><img alt="../_images/251-0.png" class="with-border align-center" src="../_images/251-0.png" style="width: 138.5px; height: 100.0px;" /></a>
<p>这个 CGI 脚本非常基础：我们只需要打印出 HTML 页面内容，让用户从一个国家名称列表中选择一个国家：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">database</span>
<span class="n">database</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

<span class="nb">print</span> <span class="s1">&#39;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;html&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;head&gt;&lt;title&gt;Select Country&lt;/title&gt;&lt;/head&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;form method=&quot;POST&quot; action=&quot;selectArea.py&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;select name=&quot;countryID&quot; size=&quot;10&quot;&gt;&#39;</span>

<span class="k">for</span> <span class="nb">id</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">list_countries</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s1">&#39;&lt;option value=&quot;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;&lt;/option&gt;&#39;</span>

<span class="nb">print</span> <span class="s1">&#39;&lt;/select&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;submit&quot; value=&quot;OK&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/form&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/html&gt;&#39;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>理解 HTML 表单</p>
<p>如果你之前没有使用过 HTML 表单，别担心。它们非常简单，如果你愿意，你可以直接复制这里给出的示例代码。如果想了解更多关于 HTML 表单的信息，可以查阅网上的许多教程。一个不错的例子可以在 <a class="reference external" href="http://www.pagetutor.com/form_tutor">http://www.pagetutor.com/form_tutor</a> 找到。</p>
</div>
<p>如你所见，我们在 <cite>database</cite> 模块中调用了 <cite>list_countries()</cite> 函数，返回了一个国家记录的 ID 和关联的名称列表。该函数的实现很简单；只需在 <cite>database.py</cite> 模块中添加以下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">list_countries</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_cursor</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id,name FROM countries &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;ORDER BY name&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_cursor</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>不幸的是，这段代码有一个问题：由于 SpatiaLite 无法处理 UTF-8 字符编码，我们必须在返回之前手动将国家名称从 Unicode 转换为 UTF-8。我们可以通过在函数中添加以下高亮部分来完成此操作：</p>
<p>这完成了“选择国家”脚本的编写。现在，你应该能够通过在浏览器中输入以下 URL 来运行它：</p>
<p><a class="reference external" href="http://127.0.0.1:8000/cgi-bin/selectCountry.py">http://127.0.0.1:8000/cgi-bin/selectCountry.py</a></p>
<p>如果一切顺利，你应该能看到国家列表，并且能够选择一个国家。如果你点击 <strong>OK</strong> 按钮，你应该会看到一个 404 错误，表示 <cite>selectArea.py</cite> 脚本尚未存在——这完全正确，因为我们还没有实现它。</p>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>The task of the selectCountry.py script is to display a list of countries to the user, so that the user can choose a desired country which is then passed to the selectArea.py script for further processing.</p>
<p>Here is what the selectCountry.py script’s output will look like:</p>
<a class="with-border reference internal image-reference" href="../_images/251-0.png"><img alt="../_images/251-0.png" class="with-border align-center" src="../_images/251-0.png" style="width: 138.5px; height: 100.0px;" /></a>
<p>This CGI script is very basic: we simply print out the contents of the HTML page which lets the user choose a country from a list of country names:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">database</span>
<span class="n">database</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

<span class="nb">print</span> <span class="s1">&#39;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;html&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;head&gt;&lt;title&gt;Select Country&lt;/title&gt;&lt;/head&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;form method=&quot;POST&quot; action=&quot;selectArea.py&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;select name=&quot;countryID&quot; size=&quot;10&quot;&gt;&#39;</span>

<span class="k">for</span> <span class="nb">id</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">list_countries</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s1">&#39;&lt;option value=&quot;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;&lt;/option&gt;&#39;</span>

<span class="nb">print</span> <span class="s1">&#39;&lt;/select&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;submit&quot; value=&quot;OK&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/form&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/html&gt;&#39;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>Understanding HTML Forms</p>
<p>If you haven’t used HTML forms before, don’t panic. They are quite straightforward, and if you want you can just copy the code from the examples given here. To learn more about HTML forms, check out one of the many tutorials available online. A good example can be found at <a class="reference external" href="http://www.pagetutor.com/form_tutor">http://www.pagetutor.com/form_tutor</a>.</p>
</div>
<p>As you can see, we call the list_countries() function within the database module
to return a list of country record IDs and their associated names. The implementation
of this function is straightforward; simply add the following code to your database.
py module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">list_countries</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_cursor</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id,name FROM countries &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;ORDER BY name&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_cursor</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>Unfortunately, there is a problem with this code: because SpatiaLite can’t handle
UTF-8 character encoding, we have to manually convert the country name from
Unicode to UTF-8 before returning it. We can do this by adding the following
highlighted lines to our function:</p>
<p>This completes the “select country” script. You should now be able to run it by typing
the following URL in your web browser:</p>
<p><a class="reference external" href="http://127.0.0.1:8000/cgi-bin/selectCountry.py">http://127.0.0.1:8000/cgi-bin/selectCountry.py</a></p>
<p>All going well, you should see the list of countries and be able to select one. If you
click on the <strong>OK</strong> button, you should see a 404 error, indicating that the selectArea.
py script doesn’t exist yet—which is perfectly correct, as we haven’t implemented
it yet.</p>
</div>
</div>
</section>
<section id="id3">
<h2>“选择区域”脚本<a class="headerlink" href="#id3" title="此标题的永久链接">#</a></h2>
<p>The “select area” script</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>DISTAL 应用程序的下一个部分是 <cite>selectArea.py</cite>。这个脚本生成一个显示所选国家简单地图的网页。用户可以输入所需的搜索半径并点击地图以标识 DISTAL 搜索的起点：</p>
<img alt="../_images/253-0.png" class="with-border align-center" src="../_images/253-0.png" />
<p>为了使这个脚本正常工作，我们需要一种生成地图的方法。使用 Mapnik 工具包来生成地图将在第 8 章《使用 Python 和 Mapnik 生成地图》中详细介绍；现在，我们将创建一个独立的 <cite>mapGenerator.py</cite> 模块，该模块负责地图的渲染，以便我们可以专注于 DISTAL 应用程序的其他部分。</p>
<p>以下是 <cite>mapGenerator.py</cite> 模块的完整源代码，该模块应该放在你的 <cite>cgi-bin</cite> 目录中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># mapGenerator.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">os.path</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapnik</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generateMap</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">minX</span><span class="p">,</span> <span class="n">minY</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">maxY</span><span class="p">,</span>
                <span class="n">mapWidth</span><span class="p">,</span> <span class="n">mapHeight</span><span class="p">,</span>
                <span class="n">hiliteExpr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s2">&quot;#8080a0&quot;</span><span class="p">,</span>
                <span class="n">hiliteLine</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">hiliteFill</span><span class="o">=</span><span class="s2">&quot;#408000&quot;</span><span class="p">,</span>
                <span class="n">normalLine</span><span class="o">=</span><span class="s2">&quot;#404040&quot;</span><span class="p">,</span> <span class="n">normalFill</span><span class="o">=</span><span class="s2">&quot;#a0a0a0&quot;</span><span class="p">,</span>
                <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="n">srcType</span> <span class="o">=</span> <span class="n">datasource</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
<span class="k">del</span> <span class="n">datasource</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

<span class="k">if</span> <span class="n">srcType</span> <span class="o">==</span> <span class="s2">&quot;OGR&quot;</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Ogr</span><span class="p">(</span><span class="o">**</span><span class="n">datasource</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">srcType</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">PostGIS</span><span class="p">(</span><span class="o">**</span><span class="n">datasource</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">srcType</span> <span class="o">==</span> <span class="s2">&quot;SQLite&quot;</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">SQLite</span><span class="p">(</span><span class="o">**</span><span class="n">datasource</span><span class="p">)</span>

<span class="n">layer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;Layer&quot;</span><span class="p">)</span>
<span class="n">layer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">source</span>

<span class="nb">map</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">mapWidth</span><span class="p">,</span> <span class="n">mapHeight</span><span class="p">,</span>
                    <span class="s1">&#39;+proj=longlat +datum=WGS84&#39;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>

<span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>

<span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

<span class="k">if</span> <span class="n">hiliteExpr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">hiliteExpr</span><span class="p">)</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">hiliteFill</span><span class="p">)))</span>
<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Stroke</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">hiliteLine</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)))</span>

<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

<span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>
<span class="n">rule</span><span class="o">.</span><span class="n">set_else</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">normalFill</span><span class="p">)))</span>
<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Stroke</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">normalLine</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)))</span>

<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

<span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;Map Style&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
<span class="n">layer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Map Style&quot;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="k">if</span> <span class="n">points</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">memoryDatasource</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">MemoryDatasource</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
    <span class="n">context</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="n">next_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">long</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">wkt</span> <span class="o">=</span> <span class="s2">&quot;POINT (</span><span class="si">%0.8f</span><span class="s2"> </span><span class="si">%0.8f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">long</span><span class="p">,</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">next_id</span><span class="p">)</span>
        <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">add_geometries_from_wkt</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
        <span class="n">next_id</span> <span class="o">=</span> <span class="n">next_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">memoryDatasource</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;Points&quot;</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">memoryDatasource</span>

    <span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

    <span class="n">pointImgFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                <span class="s2">&quot;point.png&quot;</span><span class="p">)</span>

    <span class="n">shield</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">ShieldSymbolizer</span><span class="p">(</span>
                <span class="n">mapnik</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;[name]&#39;</span><span class="p">),</span>
                <span class="s2">&quot;DejaVu Sans Bold&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span>
                <span class="n">mapnik</span><span class="o">.</span><span class="n">PathExpression</span><span class="p">(</span><span class="n">pointImgFile</span><span class="p">))</span>
    <span class="n">shield</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">shield</span><span class="o">.</span><span class="n">unlock_image</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shield</span><span class="p">)</span>

    <span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

    <span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;Point Style&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Point Style&quot;</span><span class="p">)</span>

    <span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="nb">map</span><span class="o">.</span><span class="n">zoom_to_box</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Envelope</span><span class="p">(</span><span class="n">minX</span><span class="p">,</span> <span class="n">minY</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">maxY</span><span class="p">))</span>

<span class="n">scriptDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">cacheDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scriptDir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;mapCache&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cacheDir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cacheDir</span><span class="p">)</span>
<span class="n">fd</span><span class="p">,</span><span class="n">filename</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">cacheDir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

<span class="n">mapnik</span><span class="o">.</span><span class="n">render_to_file</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">)</span>

<span class="k">return</span> <span class="s2">&quot;../mapCache/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>不用过多担心这个模块的细节；所有内容将在第 8 章《使用 Python 和 Mapnik 生成地图》中解释。与此同时，可以按照原样使用此模块。需要注意的两件事是：</p>
<ul>
<li><p>你需要在计算机上安装 Mapnik 才能使此模块正常工作。可以在 <a class="reference external" href="http://mapnik.org">http://mapnik.org</a> 找到 Mapnik 工具包。</p></li>
<li><p>此模块需要一个小的图像文件，用于在地图上标记地名。该图像是 9x9 像素，看起来像这样：</p>
<img alt="../_images/256-0.png" class="align-center" src="../_images/256-0.png" />
<p>这张图片是本书示例源代码的一部分。如果你没有访问示例代码，可以创建或查找一个类似的图像；确保图像命名为 <cite>point.png</cite> 并放置在与 <cite>mapGenerator.py</cite> 模块相同的目录中。</p>
</li>
</ul>
<p>现在，我们已经准备好开始查看 <cite>selectArea.py</cite> 脚本。我们从 shebang 行和导入所需的各种模块开始：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cgi</span><span class="o">,</span><span class="w"> </span><span class="nn">os.path</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely.wkt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">database</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapGenerator</span>
</pre></div>
</div>
<p>接下来，我们定义一些有用的常量：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">HEADER</span> <span class="o">=</span> <span class="s2">&quot;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s2">&quot;</span> \
        <span class="o">+</span> <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Select Area&lt;/title&gt;&quot;</span> \
        <span class="o">+</span> <span class="s2">&quot;&lt;/head&gt;&lt;body&gt;&quot;</span>

<span class="n">FOOTER</span> <span class="o">=</span> <span class="s2">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>

<span class="n">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">MAX_HEIGHT</span> <span class="o">=</span> <span class="mi">400</span>
</pre></div>
</div>
<p>然后，我们打开数据库：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">database</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</pre></div>
</div>
<p>接下来的任务是提取用户点击的国家的 ID：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;countryID&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">HEADER</span>
    <span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;Please select a country&lt;/b&gt;&#39;</span>
    <span class="nb">print</span> <span class="n">FOOTER</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">countryID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;countryID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>现在我们已经有了所选国家的 ID，准备开始生成地图。这个过程分为四个步骤：</p>
<ul class="simple">
<li><p>计算定义要显示的世界区域的边界框</p></li>
<li><p>计算地图的尺寸</p></li>
<li><p>设置数据源</p></li>
<li><p>渲染地图图像</p></li>
</ul>
<p>接下来，我们将逐一查看每个步骤。</p>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>The next part of the DISTAL application is selectArea.py. This script generates a web page that displays a simple map of the selected country. The user can enter a desired search radius and click on the map to identify the starting point for the DISTAL search:</p>
<img alt="../_images/253-0.png" class="with-border align-center" src="../_images/253-0.png" />
<p>For this script to work, we’re going to need some way of generating a map. Map
generation using the Mapnik toolkit will be covered in detail in Chapter 8, Using
Python and Mapnik to Generate Maps; for now, we are going to create a standalone
mapGenerator.py module, which does the map rendering for us so that we can
focus on the other aspects of the DISTAL application.
Here is the full source code for the mapGenerator.py module, which should be
placed in your cgi-bin directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># mapGenerator.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">os.path</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapnik</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generateMap</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">minX</span><span class="p">,</span> <span class="n">minY</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">maxY</span><span class="p">,</span>
                <span class="n">mapWidth</span><span class="p">,</span> <span class="n">mapHeight</span><span class="p">,</span>
                <span class="n">hiliteExpr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s2">&quot;#8080a0&quot;</span><span class="p">,</span>
                <span class="n">hiliteLine</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">hiliteFill</span><span class="o">=</span><span class="s2">&quot;#408000&quot;</span><span class="p">,</span>
                <span class="n">normalLine</span><span class="o">=</span><span class="s2">&quot;#404040&quot;</span><span class="p">,</span> <span class="n">normalFill</span><span class="o">=</span><span class="s2">&quot;#a0a0a0&quot;</span><span class="p">,</span>
                <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="n">srcType</span> <span class="o">=</span> <span class="n">datasource</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
<span class="k">del</span> <span class="n">datasource</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

<span class="k">if</span> <span class="n">srcType</span> <span class="o">==</span> <span class="s2">&quot;OGR&quot;</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Ogr</span><span class="p">(</span><span class="o">**</span><span class="n">datasource</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">srcType</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">PostGIS</span><span class="p">(</span><span class="o">**</span><span class="n">datasource</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">srcType</span> <span class="o">==</span> <span class="s2">&quot;SQLite&quot;</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">SQLite</span><span class="p">(</span><span class="o">**</span><span class="n">datasource</span><span class="p">)</span>

<span class="n">layer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;Layer&quot;</span><span class="p">)</span>
<span class="n">layer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">source</span>

<span class="nb">map</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">mapWidth</span><span class="p">,</span> <span class="n">mapHeight</span><span class="p">,</span>
                 <span class="s1">&#39;+proj=longlat +datum=WGS84&#39;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>

<span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>

<span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

<span class="k">if</span> <span class="n">hiliteExpr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">hiliteExpr</span><span class="p">)</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">hiliteFill</span><span class="p">)))</span>
<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Stroke</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">hiliteLine</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)))</span>

<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

<span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>
<span class="n">rule</span><span class="o">.</span><span class="n">set_else</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">normalFill</span><span class="p">)))</span>
<span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span>
    <span class="n">mapnik</span><span class="o">.</span><span class="n">Stroke</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="n">normalLine</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)))</span>

<span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

<span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;Map Style&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
<span class="n">layer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Map Style&quot;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="k">if</span> <span class="n">points</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">memoryDatasource</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">MemoryDatasource</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
    <span class="n">context</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="n">next_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">long</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">wkt</span> <span class="o">=</span> <span class="s2">&quot;POINT (</span><span class="si">%0.8f</span><span class="s2"> </span><span class="si">%0.8f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">long</span><span class="p">,</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">next_id</span><span class="p">)</span>
        <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">add_geometries_from_wkt</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
        <span class="n">next_id</span> <span class="o">=</span> <span class="n">next_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">memoryDatasource</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Layer</span><span class="p">(</span><span class="s2">&quot;Points&quot;</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">datasource</span> <span class="o">=</span> <span class="n">memoryDatasource</span>

    <span class="n">style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>

    <span class="n">pointImgFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                <span class="s2">&quot;point.png&quot;</span><span class="p">)</span>

    <span class="n">shield</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">ShieldSymbolizer</span><span class="p">(</span>
                <span class="n">mapnik</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;[name]&#39;</span><span class="p">),</span>
                <span class="s2">&quot;DejaVu Sans Bold&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span>
                <span class="n">mapnik</span><span class="o">.</span><span class="n">PathExpression</span><span class="p">(</span><span class="n">pointImgFile</span><span class="p">))</span>
    <span class="n">shield</span><span class="o">.</span><span class="n">displacement</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">shield</span><span class="o">.</span><span class="n">unlock_image</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shield</span><span class="p">)</span>

    <span class="n">style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

    <span class="nb">map</span><span class="o">.</span><span class="n">append_style</span><span class="p">(</span><span class="s2">&quot;Point Style&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Point Style&quot;</span><span class="p">)</span>

    <span class="nb">map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="nb">map</span><span class="o">.</span><span class="n">zoom_to_box</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Envelope</span><span class="p">(</span><span class="n">minX</span><span class="p">,</span> <span class="n">minY</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">maxY</span><span class="p">))</span>

<span class="n">scriptDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">cacheDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scriptDir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;mapCache&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cacheDir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cacheDir</span><span class="p">)</span>
<span class="n">fd</span><span class="p">,</span><span class="n">filename</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">cacheDir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

<span class="n">mapnik</span><span class="o">.</span><span class="n">render_to_file</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">)</span>

<span class="k">return</span> <span class="s2">&quot;../mapCache/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>Don’t worry too much about the details of this module; everything will be explained in Chapter 8, Using Python and Mapnik to Generate Maps. In the meantime, just use this module as written. There are just two things to be aware of:</p>
<ul>
<li><p>You need to have Mapnik installed on your computer for this module to work. The Mapnik toolkit can be found at <a class="reference external" href="http://mapnik.org">http://mapnik.org</a>.</p></li>
<li><p>This module requires a small image file that is used to mark place names on the map. This 9 x 9 pixel image looks like this:</p>
<img alt="../_images/256-0.png" class="align-center" src="../_images/256-0.png" />
<p>This preceding image is available as part of the example source code that comes with this book. If you don’t have access to the example code, you can create or search for an image that looks like this; make sure the image is named point.png and is placed into the same directory as the mapGenerator.py module itself.</p>
</li>
</ul>
<p>We’re now ready to start looking at the selectArea.py script itself. We’ll start with our shebang line and import the various modules we’ll need:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cgi</span><span class="o">,</span><span class="w"> </span><span class="nn">os.path</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely.wkt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">database</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapGenerator</span>
</pre></div>
</div>
<p>Next, we define some useful constants:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">HEADER</span> <span class="o">=</span> <span class="s2">&quot;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s2">&quot;</span> \
       <span class="o">+</span> <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Select Area&lt;/title&gt;&quot;</span> \
       <span class="o">+</span> <span class="s2">&quot;&lt;/head&gt;&lt;body&gt;&quot;</span>

<span class="n">FOOTER</span> <span class="o">=</span> <span class="s2">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>

<span class="n">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">MAX_HEIGHT</span> <span class="o">=</span> <span class="mi">400</span>
</pre></div>
</div>
<p>Then we open up the database:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">database</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</pre></div>
</div>
<p>Our next task is to extract the ID of the country the user clicked on:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;countryID&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">HEADER</span>
    <span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;Please select a country&lt;/b&gt;&#39;</span>
    <span class="nb">print</span> <span class="n">FOOTER</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">countryID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;countryID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that we have the ID of the selected country, we’re ready to start generating the
map. Doing this is a four-step process:</p>
<ul class="simple">
<li><p>Calculate the bounding box that defines the portion of the world to be displayed</p></li>
<li><p>Calculate the map’s dimensions</p></li>
<li><p>Set up the data source</p></li>
<li><p>Render the map image</p></li>
</ul>
<p>Let’s look at each of these in turn.</p>
</div>
</div>
<section id="id4">
<h3>计算边界框<a class="headerlink" href="#id4" title="此标题的永久链接">#</a></h3>
<p>Calculating the bounding box</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>在我们能够在地图上显示所选国家之前，我们需要计算该国家的边界框——即最小和最大纬度与经度值。知道了边界框后，我们可以绘制以所需国家为中心的地图。如果不这样做，地图将覆盖整个世界。</p>
<p>让我们从向数据库模块中添加一个函数开始，以提取所选国家所需的信息：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_country_details</span><span class="p">(</span><span class="n">country_id</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_cursor</span>

    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;AsText(Envelope(outline)) &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;FROM countries WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">country_id</span><span class="p">,))</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;ST_AsText(ST_Envelope(outline)) &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;FROM countries WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">country_id</span><span class="p">,))</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;ST_AsText(ST_Envelope(outline)) &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;FROM countries WHERE id=?&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">country_id</span><span class="p">,))</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span>       <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;bounds_wkt&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>这个函数返回给定国家的名称和它的边界框，以 WKT 格式的字符串形式。注意我们首先计算国家轮廓的封闭范围（或边界框），然后使用 <cite>AsText</cite> 函数将该边界框转换为 WKT 字符串。</p>
<p>有了这个函数，我们现在可以在 <cite>selectArea.py</cite> 脚本中添加必要的代码，以计算要在地图上显示的区域；只需将以下代码添加到 CGI 脚本的末尾：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_country_details</span><span class="p">(</span><span class="n">countryID</span><span class="p">)</span>

<span class="n">envelope</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;bounds_wkt&#39;</span><span class="p">])</span>
<span class="n">minLong</span><span class="p">,</span><span class="n">minLat</span><span class="p">,</span><span class="n">maxLong</span><span class="p">,</span><span class="n">maxLat</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">minLong</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">minLat</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">maxLong</span> <span class="o">=</span> <span class="n">maxLong</span> <span class="o">+</span> <span class="mf">0.2</span>
<span class="n">maxLat</span> <span class="o">=</span> <span class="n">maxLat</span> <span class="o">+</span> <span class="mf">0.2</span>
</pre></div>
</div>
<p>正如你所见，我们使用 Shapely 提取最小和最大纬度与经度值，然后稍微增加这些边界值，以便国家不会紧贴地图边缘。</p>
<p>现在代码有一个小问题：如果指定了无效的国家 ID，我们的程序会崩溃。为了解决这个问题，请在调用 <cite>database.get_country_details()</cite> 之后立即添加以下错误处理代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">details</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">HEADER</span>
    <span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;Missing Country &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">countryID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span>
    <span class="nb">print</span> <span class="n">FOOTER</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>Before we can show the selected country on a map, we need to calculate the bounding
box for that country—that is, the minimum and maximum latitude and longitude
values. Knowing the bounding box allows us to draw a map centered over the desired
country. If we didn’t do this, the map would cover the entire world.</p>
<p>Let’s start by adding a function to our database module to extract the information
we need about the selected country:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_country_details</span><span class="p">(</span><span class="n">country_id</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_cursor</span>

    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;AsText(Envelope(outline)) &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;FROM countries WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">country_id</span><span class="p">,))</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;ST_AsText(ST_Envelope(outline)) &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;FROM countries WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">country_id</span><span class="p">,))</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;ST_AsText(ST_Envelope(outline)) &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;FROM countries WHERE id=?&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">country_id</span><span class="p">,))</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span>       <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;bounds_wkt&#39;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>This function returns the given country’s name and its bounding box as a
WKT-format string. Note how we first calculate the envelope (or bounding box)
for the country’s outline, and then convert that envelope into a WKT string using
the AsText function.</p>
<p>With this function in place, we can now add the necessary code to our selectArea.
py script to calculate the area of the world to display on our map; simply add the
following to the end of your CGI script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_country_details</span><span class="p">(</span><span class="n">countryID</span><span class="p">)</span>

<span class="n">envelope</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;bounds_wkt&#39;</span><span class="p">])</span>
<span class="n">minLong</span><span class="p">,</span><span class="n">minLat</span><span class="p">,</span><span class="n">maxLong</span><span class="p">,</span><span class="n">maxLat</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">minLong</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">minLat</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">maxLong</span> <span class="o">=</span> <span class="n">maxLong</span> <span class="o">+</span> <span class="mf">0.2</span>
<span class="n">maxLat</span> <span class="o">=</span> <span class="n">maxLat</span> <span class="o">+</span> <span class="mf">0.2</span>
</pre></div>
</div>
<p>As you can see, we use Shapely to extract the minimum and maximum latitude and
longitude values, and then increase these bounds slightly so that the country won’t
butt up against the edge of the map.</p>
<p>There’s just one problem with our code: if an invalid country ID was specified, our
program will crash. To get around this, add the following error-handling code to
the script, immediately below the call to database.get_country_details():</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">details</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">HEADER</span>
    <span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;Missing Country &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">countryID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span>
    <span class="nb">print</span> <span class="n">FOOTER</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h3>计算地图尺寸<a class="headerlink" href="#id5" title="此标题的永久链接">#</a></h3>
<p>Calculating the map’s dimensions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<p>边界框不仅仅有助于缩放到地图的所需部分：它还帮助我们正确地定义地图的尺寸。请注意，前面的阿尔巴尼亚地图显示该国比宽度更高。如果你天真地将这张地图绘制成一个正方形图像，阿尔巴尼亚将看起来是这样的：</p>
<img alt="../_images/260-0.png" class="with-border align-center" src="../_images/260-0.png" />
<p>更糟糕的是，智利会看起来是这样的：</p>
<img alt="../_images/260-1.png" class="with-border align-center" src="../_images/260-1.png" />
<p>而不是这样：</p>
<img alt="../_images/261-0.png" class="with-border align-center" src="../_images/261-0.png" />
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这是一种简化；虽然大多数地图工具包会尽量保持地图的纵横比，但它们的行为是不可预测的，这意味着你无法准确地识别点击点的经纬度坐标。</p>
</div>
<p>为了正确显示国家，我们需要计算该国家的纵横比（即宽度与高度的比例），然后基于这个纵横比计算地图图像的大小，同时限制图像的总体尺寸，以便它能够适应网页。以下是必要的代码，你应该将其添加到 <cite>selectArea.py</cite> 脚本的末尾：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxLong</span> <span class="o">-</span> <span class="n">minLong</span><span class="p">)</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxLat</span> <span class="o">-</span> <span class="n">minLat</span><span class="p">)</span>
<span class="n">aspectRatio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>

<span class="n">mapWidth</span> <span class="o">=</span> <span class="n">MAX_WIDTH</span>
<span class="n">mapHeight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapWidth</span> <span class="o">/</span> <span class="n">aspectRatio</span><span class="p">)</span>

<span class="k">if</span> <span class="n">mapHeight</span> <span class="o">&gt;</span> <span class="n">MAX_HEIGHT</span><span class="p">:</span>
    <span class="c1"># 缩放地图以适应。</span>
    <span class="n">scaleFactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MAX_HEIGHT</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">mapHeight</span><span class="p">)</span>
    <span class="n">mapWidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapWidth</span> <span class="o">*</span> <span class="n">scaleFactor</span><span class="p">)</span>
    <span class="n">mapHeight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapHeight</span> <span class="o">*</span> <span class="n">scaleFactor</span><span class="p">)</span>
</pre></div>
</div>
<p>这样做意味着地图的尺寸将正确反映我们正在显示的国家的维度。</p>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<p>The bounding box isn’t useful only to zoom in on the desired part of the map: it also
helps us to correctly define the map’s dimensions. Note that the preceding map of
Albania shows the country as being taller than it is wide. If you were to naively
draw this map as a square image, Albania would end up looking like this:</p>
<img alt="../_images/260-0.png" class="with-border align-center" src="../_images/260-0.png" />
<p>Even worse, Chile would look like this:</p>
<img alt="../_images/260-1.png" class="with-border align-center" src="../_images/260-1.png" />
<p>Rather than this:</p>
<img alt="../_images/261-0.png" class="with-border align-center" src="../_images/261-0.png" />
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This is a slight simplification; the mapping toolkits generally do try to preserve the aspect ratio for a map, but their behavior is unpredictable and means that you can’t identify the lat/long coordinates for a clicked-on point.</p>
</div>
<p>To display the country correctly, we need to calculate the country’s aspect ratio
(its width as a proportion of its height) and then calculate the size of the map image
based on this aspect ratio, while limiting the overall size of the image so that it can
fit within a web page. Here’s the necessary code, which you should add to the end
of your selectArea.py script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxLong</span> <span class="o">-</span> <span class="n">minLong</span><span class="p">)</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxLat</span> <span class="o">-</span> <span class="n">minLat</span><span class="p">)</span>
<span class="n">aspectRatio</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="n">height</span>

<span class="n">mapWidth</span> <span class="o">=</span> <span class="n">MAX_WIDTH</span>
<span class="n">mapHeight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapWidth</span> <span class="o">/</span> <span class="n">aspectRatio</span><span class="p">)</span>

<span class="k">if</span> <span class="n">mapHeight</span> <span class="o">&gt;</span> <span class="n">MAX_HEIGHT</span><span class="p">:</span>
    <span class="c1"># Scale the map to fit.</span>
    <span class="n">scaleFactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MAX_HEIGHT</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">mapHeight</span><span class="p">)</span>
    <span class="n">mapWidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapWidth</span> <span class="o">*</span> <span class="n">scaleFactor</span><span class="p">)</span>
    <span class="n">mapHeight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapHeight</span> <span class="o">*</span> <span class="n">scaleFactor</span><span class="p">)</span>
</pre></div>
</div>
<p>Doing this means that the map is correctly sized to reflect the dimensions of the country we are displaying.</p>
</div>
</div>
</section>
<section id="id6">
<h3>设置数据源<a class="headerlink" href="#id6" title="此标题的永久链接">#</a></h3>
<p>Setting up the data source</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>数据源告诉地图生成器如何访问底层的地图数据。数据源的工作原理超出了本章的范围；现在，我们只需设置所需的数据源字典和相关文件，以便我们可以生成地图。请注意，这个字典的内容会根据你使用的数据库以及你尝试访问的表不同而有所变化；在本例中，我们尝试显示来自 <cite>countries</cite> 表的选定特征。为了解决这个问题，我们将在数据库模块中创建一个新的函数，用于为我们特定的数据库设置数据源：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_country_datasource</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="n">vrtFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                            <span class="s2">&quot;countries.vrt&quot;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">vrtFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;OGRVRTLayer name=&quot;countries&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &lt;SrcDataSource&gt;MySQL:&#39;</span> <span class="o">+</span> <span class="n">MYSQL_DBNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MYSQL_USERNAME</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,user=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_USERNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MYSQL_PASSWORD</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,passwd=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_PASSWORD</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/SrcDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &lt;SrcSQL&gt;SELECT id,outline &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;FROM countries&lt;/SrcSQL&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;/OGRVRTLayer&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s2">&quot;OGR&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span> <span class="p">:</span> <span class="n">vrtFile</span><span class="p">,</span>
                <span class="s1">&#39;layer&#39;</span> <span class="p">:</span> <span class="s2">&quot;countries&quot;</span><span class="p">}</span>

    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">,</span>
                <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s2">&quot;distal&quot;</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;countries&quot;</span><span class="p">,</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">POSTGIS_USERNAME</span><span class="p">,</span>
                <span class="s1">&#39;password&#39;</span> <span class="p">:</span> <span class="n">POSTGIS_PASSWORD</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;SQLite&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">SPATIALITE_DBNAME</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;countries&quot;</span><span class="p">,</span>
                <span class="s1">&#39;geometry_field&#39;</span> <span class="p">:</span> <span class="s2">&quot;outline&quot;</span><span class="p">,</span>
                <span class="s1">&#39;key_field&#39;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>MySQL 使用所谓的“虚拟数据源”，这是一种特殊文件，告诉 Mapnik 如何访问数据。我们在需要时创建这个文件，并根据需要将用户名和其他详细信息存储到该文件中。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>请注意，我们将 <cite>countries.vrt</cite> 文件存储在与 CGI 脚本相同的目录中。这样可以更容易地从 Mapnik 访问此文件。</p>
</div>
<p>现在我们已经编写了 <cite>get_datasource()</cite> 函数，接下来是使用它。在 <cite>selectArea.py</cite> 脚本的末尾添加以下行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasource</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_country_datasource</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>The data source tells the map generator how to access the underlying map data.
How data sources work is beyond the scope of this chapter; for now, we are simply
going to set up the required datasource dictionary and related files so that we can
generate our map. Note that the contents of this dictionary will vary depending on
which database you are using, as well as which table you are trying to access; in this
case, we are trying to display selected features from the countries table. To handle
this, we’ll create a new function within our database module to set up the data
source for our particular database:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_country_datasource</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="n">vrtFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                            <span class="s2">&quot;countries.vrt&quot;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">vrtFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;OGRVRTLayer name=&quot;countries&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &lt;SrcDataSource&gt;MySQL:&#39;</span> <span class="o">+</span> <span class="n">MYSQL_DBNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MYSQL_USERNAME</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,user=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_USERNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MYSQL_PASSWORD</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,passwd=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_PASSWORD</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/SrcDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &lt;SrcSQL&gt;SELECT id,outline &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;FROM countries&lt;/SrcSQL&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;/OGRVRTLayer&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s2">&quot;OGR&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span> <span class="p">:</span> <span class="n">vrtFile</span><span class="p">,</span>
                <span class="s1">&#39;layer&#39;</span> <span class="p">:</span> <span class="s2">&quot;countries&quot;</span><span class="p">}</span>

    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">,</span>
                <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s2">&quot;distal&quot;</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;countries&quot;</span><span class="p">,</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">POSTGIS_USERNAME</span><span class="p">,</span>
                <span class="s1">&#39;password&#39;</span> <span class="p">:</span> <span class="n">POSTGIS_PASSWORD</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;SQLite&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">SPATIALITE_DBNAME</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;countries&quot;</span><span class="p">,</span>
                <span class="s1">&#39;geometry_field&#39;</span> <span class="p">:</span> <span class="s2">&quot;outline&quot;</span><span class="p">,</span>
                <span class="s1">&#39;key_field&#39;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>MySQL uses what is called a “virtual datasource”, which is a special file that
tells Mapnik how to access the data. We create this file as we need it, storing
the username and other details into the file as required.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Note that we are storing the countries.vrt file in the same directory as our CGI scripts. This makes it easier to access this file from Mapnik.</p>
</div>
<p>Now that we have written the get_datasource() function, it’s time to use it.
Add the following line to the end of your selectArea.py script:</p>
<p>datasource = database.get_country_datasource()</p>
</div>
</div>
</section>
<section id="id7">
<h3>渲染地图图像<a class="headerlink" href="#id7" title="此标题的永久链接">#</a></h3>
<p>Rendering the map image</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>有了边界框、地图的尺寸和数据源的设置后，我们终于可以将地图渲染为图像文件了。这只需要一个函数调用，代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imgFile</span> <span class="o">=</span> <span class="n">mapGenerator</span><span class="o">.</span><span class="n">generateMap</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span>
                                    <span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span>
                                    <span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">,</span>
                                    <span class="n">mapWidth</span><span class="p">,</span> <span class="n">mapHeight</span><span class="p">,</span>
                                    <span class="s2">&quot;[id] = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">countryID</span><span class="p">))</span>
</pre></div>
</div>
<p>请注意，我们的数据源已经设置为显示来自 <cite>countries</cite> 表的特征，并且 <cite>“[id] = “+str(countryID)</cite> 是一个“高亮表达式”，用于在地图上突出显示给定 ID 的国家。</p>
<p><cite>mapGenerator.generateMap()</cite> 函数返回一个 PNG 格式的图像文件，其中包含生成的地图。该图像文件存储在一个临时目录中，并返回文件的相对路径。这样我们可以直接在 CGI 脚本中使用返回的 <cite>imgFile</cite>，如以下代码所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s1">&#39;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;html&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;head&gt;&lt;title&gt;Select Area&lt;/title&gt;&lt;/head&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;form method=&quot;POST&quot; action=&quot;showResults.py&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;Select all features within&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;text&quot; name=&quot;radius&quot; value=&quot;10&quot; size=&quot;2&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;miles of a point.&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;Click on the map to identify your starting point:&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;br&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;image&quot; src=&quot;&#39;</span> <span class="o">+</span> <span class="n">imgFile</span> <span class="o">+</span> <span class="s1">&#39;&quot; ismap&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;hidden&quot; name=&quot;countryID&quot;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;value=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">countryID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;hidden&quot; name=&quot;mapWidth&quot;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;value=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mapWidth</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;hidden&quot; name=&quot;mapHeight&quot;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;value=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mapHeight</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/form&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><cite>&lt;input type=”hidden”&gt;</cite> 行定义了“隐藏表单字段”，将信息传递给下一个 CGI 脚本。我们将在下一节讨论如何使用这些信息。</p>
</div>
<p>在这个 CGI 脚本中使用 <cite>&lt;input type=”image” src=”…” ismap&gt;</cite> 的有趣效果是使得地图变得可以点击：当用户点击图像时，包含的 HTML 表单将会提交，并带有两个额外的参数，分别是 <cite>x</cite> 和 <cite>y</cite>。这两个参数包含用户点击图像时的坐标。</p>
<p>这就完成了 <cite>selectArea.py</cite> 的 CGI 脚本。确保你已经在程序的开头添加了适当的“shebang”行，并使其可执行，如前面所述，以便它可以作为 CGI 脚本运行。</p>
<p>如果一切顺利，你应该能够在 Web 浏览器中输入以下网址：</p>
<p><a class="reference external" href="http://127.0.0.1:8000/cgi-bin/selectCountry.py">http://127.0.0.1:8000/cgi-bin/selectCountry.py</a></p>
<p>选择一个国家，并在浏览器中显示该国的地图。如果你点击地图，你会收到一个 404 错误，表示最终的 CGI 脚本尚未编写。</p>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>With the bounding box, the map’s dimensions and the data source all set up, we
are finally ready to render the map into an image file. This is done using a single
function call as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imgFile</span> <span class="o">=</span> <span class="n">mapGenerator</span><span class="o">.</span><span class="n">generateMap</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span>
                                   <span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span>
                                   <span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">,</span>
                                   <span class="n">mapWidth</span><span class="p">,</span> <span class="n">mapHeight</span><span class="p">,</span>
                                   <span class="s2">&quot;[id] = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">countryID</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that our datasource has been set up to display features from the countries
table, and that the “[id] = “+str(countryID) is a “highlight expression” is used
to visually highlight the country with the given ID.</p>
<p>The mapGenerator.generateMap() function returns a reference to a PNG-format
image file containing the generated map. This image file is stored in a temporary
directory, and the file’s relative pathname is returned to the caller. This allows us
to use the returned imgFile directly within our CGI script, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s1">&#39;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;html&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;head&gt;&lt;title&gt;Select Area&lt;/title&gt;&lt;/head&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;form method=&quot;POST&quot; action=&quot;showResults.py&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;Select all features within&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;text&quot; name=&quot;radius&quot; value=&quot;10&quot; size=&quot;2&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;miles of a point.&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;Click on the map to identify your starting point:&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;br&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;image&quot; src=&quot;&#39;</span> <span class="o">+</span> <span class="n">imgFile</span> <span class="o">+</span> <span class="s1">&#39;&quot; ismap&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;hidden&quot; name=&quot;countryID&quot;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;</span>
<span class="n">value</span><span class="o">=</span><span class="s2">&quot;&#39; + str(countryID) + &#39;&quot;</span><span class="o">&gt;</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;hidden&quot; name=&quot;mapWidth&quot;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;</span>
<span class="n">value</span><span class="o">=</span><span class="s2">&quot;&#39; + str(mapWidth) + &#39;&quot;</span><span class="o">&gt;</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;input type=&quot;hidden&quot; name=&quot;mapHeight&quot;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;</span>
<span class="n">value</span><span class="o">=</span><span class="s2">&quot;&#39; + str(mapHeight) + &#39;&quot;</span><span class="o">&gt;</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/form&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The &lt;input type=”hidden”&gt; lines define “hidden form fields” that pass information on to the next CGI script. We’ll discuss how this information is used in the next section.</p>
</div>
<p>The use of <em>&lt;input type=”image” src=”…” ismap&gt;</em> in this CGI script has the
interesting effect of making the map clickable: when the user clicks on the image, the
enclosing HTML form will be submitted with two extra parameters named x and y.
These contain the coordinate within the image that the user clicked on.</p>
<p>This completes the <em>selectArea.py</em> CGI script. Make sure you added an appropriate
“shebang” line to the start of your program and made it executable, as described
earlier, so that it can run as a CGI script.</p>
<p>All going well, you should be able to point your web browser to:</p>
<p><a class="reference external" href="http://127.0.0.1:8000/cgi-bin/selectCountry.py">http://127.0.0.1:8000/cgi-bin/selectCountry.py</a></p>
<p>Choose a country, and see a map of that country displayed within your web browser.
If you click within the map, you’ll get a 404 error, indicating that the final CGI script
hasn’t been written yet.</p>
</div>
</div>
</section>
</section>
<section id="id8">
<h2>“显示结果”脚本<a class="headerlink" href="#id8" title="此标题的永久链接">#</a></h2>
<p>The “show results” script</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<p>最终的CGI脚本是实际工作的地方。首先，创建你的 <cite>showResults.py</cite> 文件，并在文件中输入以下内容：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cgi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">database</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapGenerator</span>

<span class="c1">############################################################</span>

<span class="n">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">MAX_HEIGHT</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">METERS_PER_MILE</span> <span class="o">=</span> <span class="mf">1609.344</span>

<span class="c1">############################################################</span>

<span class="n">database</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>别忘了将此文件标记为可执行文件，这样它就可以作为CGI脚本运行了。你可以使用 <cite>chmod</cite> 命令来完成此操作，正如本章前面“什么是CGI脚本？”部分中所描述的那样。</p>
</div>
<p>在此脚本中，我们将获取用户点击的 <cite>(x, y)</cite> 坐标，以及输入的搜索半径，将 <cite>(x, y)</cite> 坐标转换为经度和纬度，并识别出该搜索半径内的所有地名。然后，我们生成一个高分辨率的地图，显示搜索半径内的海岸线和地名，并将该地图展示给用户。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>请记住，x 对应的是经度值，y 对应的是纬度值。</p>
<p><cite>(x, y)</cite> 等于 <cite>(经度, 纬度)</cite>，而不是 <cite>(纬度, 经度)</cite>。</p>
</div>
<p>接下来我们逐步分析这些步骤。</p>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<p>The final CGI script is where the real work is done. Start by creating your
showResults.py file, and type the following into this file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cgi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">database</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mapGenerator</span>

<span class="c1">############################################################</span>

<span class="n">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">MAX_HEIGHT</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">METERS_PER_MILE</span> <span class="o">=</span> <span class="mf">1609.344</span>

<span class="c1">############################################################</span>

<span class="n">database</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Don’t forget to mark this file as executable so that it can be run as a CGI script. You can do this using the chmod command, as described in the <em>What is a CGI script?</em> section earlier in this chapter.</p>
</div>
<p>In this script, we will take the (x, y) coordinate the user clicked on, along with the
entered search radius, convert the (x, y) coordinate into a longitude and latitude,
and identify all the place names within that search radius. We then generate a
high-resolution map showing the shorelines and place names within the search
radius, and display that map to the user.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Remember that x corresponds to a longitude value, and y to a latitude value.</p>
<p>(x, y) equals (longitude, latitude), not (latitude, longitude).</p>
</div>
<p>Let’s examine each of these steps in turn.</p>
</div>
</div>
<section id="id9">
<h3>识别点击点<a class="headerlink" href="#id9" title="此标题的永久链接">#</a></h3>
<p>Identifying the clicked-on point</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p><cite>selectArea.py</cite> 脚本生成了一个 HTML 表单，当用户点击低分辨率的国家地图时，该表单会被提交。<cite>showResults.py</cite> 脚本接收表单参数，包括用户点击的点的 x 和 y 坐标。</p>
<p>单独来看，这个坐标并没有太大用处。它只是用户点击的点的 x 和 y 偏移量，单位是像素。我们需要将提交的 (x, y) 像素坐标转换为对应于地球表面被点击点的经纬度值。</p>
<p>为此，我们需要以下信息：</p>
<ul class="simple">
<li><p>地图的地理坐标范围：<em>minLong, minLat, maxLong, 和 maxLat</em></p></li>
<li><p>地图的尺寸（像素）：mapWidth 和 mapHeight</p></li>
</ul>
<p>这些变量都在前一节中计算过，并通过隐藏的表单变量传递给我们，同时还包括国家 ID、所需的搜索半径和点击点的 (x, y) 坐标。我们可以使用 cgi 模块来检索这些信息；将以下代码添加到 <cite>showResults.py</cite> 文件的末尾：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">countryID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;countryID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">radius</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">x</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">y</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="n">mapWidth</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;mapWidth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">mapHeight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;mapHeight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>有了这些信息，我们现在可以计算出用户点击的经纬度。为此，我们首先必须计算用于生成用户点击的地图的边界。将以下代码添加到 <cite>showResults.py</cite> 文件的末尾：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_country_details</span><span class="p">(</span><span class="n">countryID</span><span class="p">)</span>
<span class="n">envelope</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;bounds_wkt&#39;</span><span class="p">])</span>
<span class="n">minLong</span><span class="p">,</span><span class="n">minLat</span><span class="p">,</span><span class="n">maxLong</span><span class="p">,</span><span class="n">maxLat</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">minLong</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">minLat</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">maxLong</span> <span class="o">=</span> <span class="n">maxLong</span> <span class="o">+</span> <span class="mf">0.2</span>
<span class="n">maxLat</span> <span class="o">=</span> <span class="n">maxLat</span> <span class="o">+</span> <span class="mf">0.2</span>
</pre></div>
</div>
<p>现在，我们可以计算用户点击的确切经纬度。我们首先计算用户点击的图像上横向偏移的距离，得到一个从 0 到 1 的数值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xFract</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mapWidth</span><span class="p">)</span>
</pre></div>
</div>
<p>xFract 值为 0.0 对应图像的左侧，而 xFract 值为 1.0 对应图像的右侧。然后，我们将此值与最小和最大经度值结合起来，计算被点击点的经度：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">longitude</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">+</span> <span class="n">xFract</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLong</span><span class="o">-</span><span class="n">minLong</span><span class="p">)</span>
</pre></div>
</div>
<p>然后，我们对 Y 坐标执行相同的操作，将其转换为纬度值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yFract</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mapHeight</span><span class="p">)</span>
<span class="n">latitude</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">yFract</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLat</span><span class="o">-</span><span class="n">minLat</span><span class="p">)</span>
</pre></div>
</div>
<p>请注意，在上面的计算中我们使用了 (1-yFract) 而不是 yFract。这是因为 minLat 值对应的是图像底部的纬度，而 yFract 值为 0.0 时对应的是图像的顶部。通过使用 (1-yFract)，我们将值垂直翻转，以便正确计算纬度。</p>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p>The selectArea.py script generates an HTML form that is submitted when the user
clicks on the low-resolution country map. The showResults.py script receives the
form parameters, including the x and y coordinates of the point the user clicked on.</p>
<p>By itself, this coordinate isn’t very useful. It’s simply the x and y offset, measured in
pixels, of the point the user clicked on. We need to translate the submitted (x, y) pixel
coordinate into a latitude and longitude value corresponding to the clicked-on point
on the Earth’s surface.</p>
<p>To do this, we need to have the following information:</p>
<ul class="simple">
<li><p>The map’s bounding box in geographic coordinates: <em>minLong, minLat, maxLong, and maxLat</em></p></li>
<li><p>The map’s size in pixels: mapWidth and mapHeight</p></li>
</ul>
<p>These variables were all calculated in the previous section and passed to us using
hidden form variables, along with the country ID, the desired search radius, and
the (x, y) coordinate of the clicked on point. We can retrieve all of these using the
cgi module; add the following code to the end of your showResults.py file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">countryID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;countryID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">radius</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">x</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">y</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="n">mapWidth</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;mapWidth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">mapHeight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;mapHeight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>With this information, we can now calculate the latitude and longitude that the
user clicked on. To do this, we first have to calculate the bounds that were used
to generate the map that the user clicked on. Add the following code to the end
of your showResults.py file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_country_details</span><span class="p">(</span><span class="n">countryID</span><span class="p">)</span>
<span class="n">envelope</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;bounds_wkt&#39;</span><span class="p">])</span>
<span class="n">minLong</span><span class="p">,</span><span class="n">minLat</span><span class="p">,</span><span class="n">maxLong</span><span class="p">,</span><span class="n">maxLat</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">minLong</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">minLat</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">-</span> <span class="mf">0.2</span>
<span class="n">maxLong</span> <span class="o">=</span> <span class="n">maxLong</span> <span class="o">+</span> <span class="mf">0.2</span>
<span class="n">maxLat</span> <span class="o">=</span> <span class="n">maxLat</span> <span class="o">+</span> <span class="mf">0.2</span>
</pre></div>
</div>
<p>We can now calculate the exact latitude and longitude the user clicked on. We start
by calculating how far across the image the user clicked, as a number in the range
from 0 to 1:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xFract</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mapWidth</span><span class="p">)</span>
</pre></div>
</div>
<p>An xFract value of 0.0 corresponds to the left side of the image, while an xFract
value of 1.0 corresponds to the right side of the image. We then combine this with
the minimum and maximum longitude values to calculate the longitude of the
clicked-on point:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">longitude</span> <span class="o">=</span> <span class="n">minLong</span> <span class="o">+</span> <span class="n">xFract</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLong</span><span class="o">-</span><span class="n">minLong</span><span class="p">)</span>
</pre></div>
</div>
<p>We then do the same to convert the Y coordinate into a latitude value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yFract</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">mapHeight</span><span class="p">)</span>
<span class="n">latitude</span> <span class="o">=</span> <span class="n">minLat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">yFract</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLat</span><span class="o">-</span><span class="n">minLat</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we are using (1-yFract) rather than yFract in the preceding calculation.
This is because the minLat value refers to the latitude of the bottom of the image, while
a yFract value of 0.0 corresponds to the top of the image. By using (1-yFract), we
flip the values vertically so that the latitude is calculated correctly.</p>
</div>
</div>
</section>
<section id="id10">
<h3>按距离识别特征<a class="headerlink" href="#id10" title="此标题的永久链接">#</a></h3>
<p>Identifying features by distance</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>让我们回顾一下目前为止所取得的进展。用户已经选择了一个国家，查看了该国轮廓的简单地图，输入了所需的搜索半径，并点击地图上的一个点来确定搜索的起点。然后，我们将这个点击的点转换为经纬度值。</p>
<p>所有这些为我们提供了三个数字：所需的搜索半径，以及用于开始搜索的起点的纬度/经度坐标。</p>
<p>我们现在的任务是确定哪些特征位于点击点给定的搜索半径内：</p>
<p>因为搜索半径是以实际距离（英里）指定的，所以我们需要能够精确地计算距离。在第二章《GIS》中，我们讨论了解决这个问题的一种方法—— <strong>大圆距离</strong> 的概念：</p>
<p>给定起点和终点，大圆距离的计算告诉我们两点之间沿地球表面的距离。</p>
<p>为了确定匹配的特征，我们需要某种方式找出所有大圆距离小于或等于所需搜索半径的匹配地名。让我们看看我们可能采取的一些方法来识别这些特征。</p>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>Let’s review what we have achieved so far. The user has selected a country, viewed
a simple map of the country’s outline, entered a desired search radius, and clicked on
a point on the map to identify the origin for the search. We have then converted this
clicked-on point into a latitude and longitude value.</p>
<p>All of this provides us with three numbers: the desired search radius, and the lat/
long coordinates for the point at which to start the search. Our task now is to identify
which features are within the given search radius of the clicked-on point:</p>
<p>Because the search radius is specified as an actual distance in miles, we need to be able to calculate distances accurately. We looked at an approach to solving this problem in Chapter 2, GIS, where we considered the concept of a <strong>great circle distance</strong>:</p>
<p>Given a start and end point, the great circle distance calculation tells us the distance
along the Earth’s surface between the two points.</p>
<p>In order to identify the matching features, we need to somehow find all the
matching place names which have a great circle distance less than or equal to
the desired search radius. Let’s look at some ways in which we could possibly
identify these features.</p>
</div>
</div>
<section id="id11">
<h4>手动计算距离<a class="headerlink" href="#id11" title="此标题的永久链接">#</a></h4>
<p>Calculating distances manually</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p>正如我们在第五章《在Python中处理地理空间数据》中看到的，pyproj 允许我们基于两个经纬度坐标进行精确的大圆距离计算，方法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>
<span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">long1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">long2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">)</span>
</pre></div>
</div>
<p>计算结果中的距离单位是米，我们可以很容易地将其转换为英里，如下所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">miles</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="mf">1609.344</span>
</pre></div>
</div>
<p>基于此，我们可以编写一些代码来查找在所需搜索半径内的特征：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s2">&quot;WGS84&quot;</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select id, X(position), Y(position) &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;from places&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">startLong</span><span class="p">,</span> <span class="n">startLat</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">/</span> <span class="mf">1609.344</span> <span class="o">&lt;=</span> <span class="n">searchRadius</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>这样肯定可以工作，并返回在给定搜索半径内的所有特征的准确列表。问题在于速度；因为我们的 places 表中有超过四百万个特征，所以这个程序会花费几分钟时间来识别所有匹配的地名。显然，这不是一个非常实际的解决方案。</p>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>As we saw in Chapter 5, Working with Geospatial Data in Python, pyproj allows us
to do accurate great circle distance calculations based on two lat/long coordinates,
like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>
<span class="n">angle1</span><span class="p">,</span><span class="n">angle2</span><span class="p">,</span><span class="n">distance</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">long1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span>
                                  <span class="n">long2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">)</span>
</pre></div>
</div>
<p>The resulting distance is in meters, and we could easily convert this to miles
as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">miles</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="mf">1609.344</span>
</pre></div>
</div>
<p>Based on this, we could write some code to find the features within the desired
search radius:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s2">&quot;WGS84&quot;</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select id,X(position),Y(position) &quot;</span> <span class="o">+</span>
               <span class="s2">&quot;from places&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="nb">id</span><span class="p">,</span><span class="n">long</span><span class="p">,</span><span class="n">lat</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="n">angle1</span><span class="p">,</span><span class="n">angle2</span><span class="p">,</span><span class="n">distance</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">startLong</span><span class="p">,</span> <span class="n">startLat</span><span class="p">,</span>
                                      <span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">/</span> <span class="mf">1609.344</span> <span class="o">&lt;=</span> <span class="n">searchRadius</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>This would certainly work, and would return an accurate list of all features within
the given search radius. The problem is speed; because there are more than four
million features in our places table, this program would take several minutes to
identify all the matching place names. Obviously this isn’t a very practical solution.</p>
</div>
</div>
</section>
<section id="id12">
<h4>使用角距离<a class="headerlink" href="#id12" title="此标题的永久链接">#</a></h4>
<p>Using angular distances</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p>我们在 <em>第五章《在Python中处理地理空间数据》</em> 中看到了另一种通过距离识别特征的方法，在那一章中，我们查找了城市区域内或附近的所有公园。在那一章中，我们使用了**角距离**来估算两个点之间的距离。角距离是以度为单位的距离——从技术上讲，它是从地球中心出发的两条射线之间的夹角，这两条射线分别指向地球表面的两个目标点。因为纬度和经度值都是角度测量，所以我们可以基于两个经纬度值像这样轻松计算角距离：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">long2</span><span class="o">-</span><span class="n">long1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>这是一种简单的笛卡尔距离计算方法。我们天真地把纬度和经度值当作笛卡尔坐标来处理。虽然这样做是不正确的，但它的确给了我们某种形式的距离测量。</p>
<p>那么这种角距离测量给了我们什么呢？我们知道，角距离越大，实际的（大圆）距离也越大。在 <em>第五章《在Python中处理地理空间数据》</em> 中，我们用这个方法来查找位于加利福尼亚的所有公园，这些公园大约在城市区域十公里以内。然而，在那一章中，我们能够使用这种方法是因为我们只处理了加利福尼亚的数据。实际上，角距离会根据纬度的不同而有很大差异；如果你当前的位置在赤道附近，查找在经度±1度范围内的点将包含111公里的所有点；如果你处于±30度纬度处，则为100公里；在±60度纬度时，只有55公里；而在极地，则为零公里：</p>
<a class="with-border reference internal image-reference" href="../_images/270-0.png"><img alt="../_images/270-0.png" class="with-border align-center" src="../_images/270-0.png" style="width: 301.5px; height: 449.09999999999997px;" /></a>
<p>由于DISTAL包含了全球数据，因此角度测量几乎是没用的——我们无法假设给定的纬度和经度差异会等于地球表面上的某一距离，这对我们进行基于距离的搜索是无帮助的。</p>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>We saw an alternative way of identifying features by distance in <em>Chapter 5, Working
with Geospatial Data in Python</em>, where we looked for all parks in or near an urban
area. In that chapter, we used an <strong>angular distance</strong> to estimate how far apart two
points were. An angular distance is a distance measured in degrees—technically,
it is the angle between two rays going out from the center of the Earth through the
two desired points on the Earth’s surface. Because latitude and longitude values
are angular measurements, we can easily calculate an angular distance based on
two lat/long values like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">long2</span><span class="o">-</span><span class="n">long1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a simple Cartesian distance calculation. We are naively treating lat/long
values as if they were Cartesian coordinates. This isn’t right, but it does give us
a distance measurement of sorts.</p>
<p>So what does this angular distance measurement give us? We know that the bigger
the angular distance, the bigger the real (great circle) distance will be. In Chapter 5,
Working with Geospatial Data in Python, we used this to identify all parks in California
which where approximately within ten kilometers of an urban area. However, we
could get away with this in that chapter because we were only dealing with data for
California. In reality, the angular distance varies greatly depending on which latitude
you are dealing with; looking for points within ±1 degree of longitude of your current
location will include all points within 111 km if you are at the equator, 100 km if you
are at ±30 degree latitude, 55 km at ±60 degree, and zero km at the poles:</p>
<a class="with-border reference internal image-reference" href="../_images/270-0.png"><img alt="../_images/270-0.png" class="with-border align-center" src="../_images/270-0.png" style="width: 502.5px; height: 748.5px;" /></a>
<p>Because DISTAL includes data for the entire world, angular measurements would be all but useless—we can’t assume that a given difference in latitude and longitude values would equal a given distance across the Earth’s surface in any way which would help us do the distance-based searching.</p>
</div>
</div>
</section>
<section id="id13">
<h4>使用投影坐标<a class="headerlink" href="#id13" title="此标题的永久链接">#</a></h4>
<p>Using projected coordinates</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>另一种查找给定距离内所有点的方法是使用投影坐标系统，该系统准确地表示坐标值之间的距离差异。例如， <strong>统一横轴墨卡托（UTM）投影</strong> 定义了Y坐标为相对于赤道的南北距离（单位：米），X坐标为相对于某一参考点的东西距离（单位：米）。使用UTM投影，可以通过笛卡尔距离公式轻松地找出给定距离内的所有点：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">long2</span><span class="o">-</span><span class="n">long1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">searchRadius</span><span class="p">:</span>
<span class="o">......</span>
</pre></div>
</div>
<p>不幸的是，像UTM这样的投影坐标系统仅对覆盖地球表面小部分区域的数据准确。UTM坐标系统实际上是多个不同的投影，将世界划分为六十个不同的“区”，每个区宽六度经度。你需要使用与你的特定数据相对应的正确UTM区：例如，加利福尼亚的坐标属于UTM第10区，尝试将它们投影到UTM第20区将导致距离测量非常不准确。</p>
<p>如果你有的数据仅覆盖地球表面的一小块区域，使用投影坐标系统将有很大优势。你不仅可以使用笛卡尔坐标计算距离，还可以利用数据库函数，如PostGIS的 <strong>ST_DWithin()</strong> 函数，快速找到距离某个中心点给定物理距离内的所有点。</p>
<p>然而，不幸的是， <strong>DISTAL</strong> 应用程序使用的数据覆盖了整个地球。因此，我们无法为这个应用程序使用投影坐标，而必须寻找其他方式来解决这个问题。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当然， <strong>DISTAL</strong> 应用程序是故意设计为包含全球数据的，正是出于这个原因。若能使用单一的UTM区来处理所有数据，那将是太过于方便了。</p>
</div>
<p>事实上，DISTAL可以使用投影UTM坐标，但这非常复杂。因为每个数据库表中的每个特征都必须具有相同的空间参考，所以不可能在一个表中存储属于不同UTM区的特征——我们能够在UTM投影中存储全球数据的唯一方式是为每个UTM区创建一个单独的数据库表。</p>
<p>这将需要六十个单独的数据库表！要识别给定距离内的点，你首先需要弄清楚起始点位于哪个UTM区，然后检查该数据库表中的特征。你还必须处理超出单个UTM区边界的搜索。</p>
<p>不言而喻，这种方法对于我们来说过于复杂。它确实能工作（并且比任何其他方法都具有更好的可扩展性），但由于其复杂性，我们不考虑使用它。</p>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>Another way of finding all points within a given distance is to use a projected
coordinate system that accurately represents distance as differences between
coordinate values. For example, the Universal Transverse Mercator projection
defines Y coordinates as a number of meters north or south of the equator, and
X coordinates as a number of meters east or west of a given reference point.
Using the UTM projection, it would be easy to identify all points within a given
distance by using the Cartesian distance formula:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">long2</span><span class="o">-</span><span class="n">long1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">searchRadius</span><span class="p">:</span>
<span class="o">......</span>
</pre></div>
</div>
<p>Unfortunately, projected coordinate systems such as UTM are only accurate for
data that covers a small portion of the Earth’s surface. The UTM coordinate system
is actually a large number of different projections, dividing the world up into sixty
separate “zones” each six degrees of longitude wide. You need to use the correct
UTM zone for your particular data: California’s coordinates belong in UTM zone
10, and attempting to project them into UTM zone 20 would cause your distance
measurements to be very inaccurate.</p>
<p>If you had data that covered only a small area of the Earth’s surface, using
a projected coordinate system would have great advantages. Not only could
you calculate distances using Cartesian coordinates, you could also make use
of database functions such as PostGIS’s ST_DWithin() function to quickly find
all points within a given physical distance of a central point.</p>
<p>Unfortunately, the DISTAL application makes use of data covering the entire Earth.
For this reason, we can’t use projected coordinates for this application, and have to
find some other way of solving this problem.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Of course, the DISTAL application was deliberately designed to include world-wide data, for precisely this reason. Being able to use a single UTM zone for all the data would be too convenient.</p>
</div>
<p>Actually, there is a way in which DISTAL could use projected UTM coordinates,
but it’s rather complicated. Because every feature in a given database table has to
have the same spatial reference, it isn’t possible to have different features in a table
belonging to different UTM zones—the only way we could store worldwide data in
UTM projections would be to have a separate database table for each UTM zone.</p>
<p>This would require sixty separate database tables! To identify the points within
a given distance, you would first have to figure out which UTM zone the starting
point was in, and then check the features within that database table. You would also
have to deal with searches that extend out beyond the edge of a single UTM zone.</p>
<p>Needless to say, this approach is far too complex for us. It would work
(and would scale better than any of the alternatives) but we won’t consider
it because of its complexity.</p>
</div>
</div>
</section>
<section id="id14">
<h4>混合方法<a class="headerlink" href="#id14" title="此标题的永久链接">#</a></h4>
<p>A hybrid approach</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<p>在第6章《数据库中的GIS》中，我们讨论了识别位于给定多边形内的所有点的过程。由于MySQL仅处理边界框交集测试，我们最终不得不编写一个程序，要求数据库识别所有位于边界框内的点，然后手动检查每个点是否实际位于多边形内：</p>
<a class="with-border reference internal image-reference" href="../_images/272-0.png"><img alt="../_images/272-0.png" class="with-border align-center" src="../_images/272-0.png" style="width: 581.5px; height: 327.5px;" /></a>
<p>这为我们解决 <strong>DISTAL</strong> 的基于距离选择问题提供了一种思路：我们可以计算一个包含所需搜索半径的边界框，要求数据库识别所有位于该边界框内的点，然后计算所有返回点的 <strong>大圆距离</strong> ，仅选择实际位于搜索半径内的点。由于实际位于边界框内的点相对较少，仅计算这些点的 <strong>大圆距离</strong> 会很快，这使我们能够在没有较大性能损失的情况下准确地找到匹配的点。</p>
<p>让我们从计算边界框开始。我们已经知道起始点的坐标和所需的搜索半径：</p>
<a class="with-border reference internal image-reference" href="../_images/273-0.png"><img alt="../_images/273-0.png" class="with-border align-center" src="../_images/273-0.png" style="width: 251.0px; height: 251.0px;" /></a>
<p>使用 <strong>pyproj</strong> ，我们可以通过在起始点的正北、正南、正东和正西方向各自移动半径米来计算四个点的纬度/经度坐标：</p>
<a class="with-border reference internal image-reference" href="../_images/273-1.png"><img alt="../_images/273-1.png" class="with-border align-center" src="../_images/273-1.png" style="width: 252.5px; height: 254.0px;" /></a>
<p>然后，我们使用这四个点来定义包含所需搜索半径的边界框：</p>
<a class="with-border reference internal image-reference" href="../_images/274-0.png"><img alt="../_images/274-0.png" class="with-border align-center" src="../_images/274-0.png" style="width: 252.5px; height: 252.5px;" /></a>
<p>我们将在数据库模块中创建一个新函数，使用这个边界框进行空间搜索。让我们首先将以下内容添加到你的 <strong>database.py</strong> 模块的末尾：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_places_within</span><span class="p">(</span><span class="n">startLat</span><span class="p">,</span> <span class="n">startLong</span><span class="p">,</span> <span class="n">searchRadius</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_cursor</span>

    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>请注意，由于我们使用 <strong>pyproj</strong> 执行前向大地测量计算，我们可以计算出边界框的正确纬度/经度坐标，而不受起始点纬度的影响。唯一可能失败的情况是，当 <strong>startLat</strong> 在距离北极或南极 <strong>searchRadius</strong> 米内时——考虑到我们正在搜索城市，这种情况几乎不可能发生（我们也可以始终添加错误检查代码来捕捉这种情况）。</p>
<p>当完成时，我们的 <strong>find_places_within()</strong> 函数将返回所有位于给定边界框内的地点，以及计算出的边界框。由于每个数据库的空间查询不同，我们将分别查看每个数据库。</p>
<p>对于MySQL，我们将使用提供的边界框创建一个多边形，然后使用 <strong>MBRContains()</strong> 函数搜索该多边形内的地点。为此，将第一个 <cite>…</cite> 替换为以下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span> <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span>
    <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span> <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span>
    <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">)])</span>
<span class="n">wkt</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;X(position),Y(position) &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM places WHERE MBRContains(&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;GeomFromText(</span><span class="si">%s</span><span class="s2">), position)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">wkt</span><span class="p">,))</span>
</pre></div>
</div>
<p>PostGIS采用类似的方法，创建一个多边形，然后使用 <strong>ST_CONTAINS()</strong> 函数来识别匹配的地点：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span> <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span>
                <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span> <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span>
                <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">)])</span>
<span class="n">wkt</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;ST_X(position),ST_Y(position) &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM places WHERE ST_CONTAINS(&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;ST_GeomFromText(</span><span class="si">%s</span><span class="s2">, 4326), &quot;</span> <span class="o">+</span>
    <span class="s2">&quot;position)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">wkt</span><span class="p">,))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>你可能会想知道为什么我们不使用PostGIS的 <strong>ST_DWITHIN()</strong> 函数来识别匹配的地点。问题在于我们使用的是未投影的坐标，这意味着传递给 <strong>ST_DWITHIN()</strong> 的“距离”必须以度数而不是米为单位。这是可行的，但需要进行一些复杂的计算才能从米转换为度数。为了保持简单，我们将使用 <strong>ST_CONTAINS()</strong> 函数。</p>
</div>
<p>最后，对于 <strong>SpatiaLite</strong> ，我们需要做更多的工作。请记住， <strong>SpatiaLite</strong> 不会自动为查询使用空间索引。为了使这段代码在 <strong>SpatiaLite</strong> 中高效运行，我们必须直接检查空间索引：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;X(position),Y(position) &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM places WHERE id in &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;(SELECT pkid &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM idx_places_position &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;WHERE xmin &gt;= ? AND xmax &lt;= ? &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;AND ymin &gt;= ? and ymax &lt;= ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">maxLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">))</span>
</pre></div>
</div>
<p>现在，我们已经执行了一个SQL查询，识别了所有位于边界框内的点，接下来我们可以检查 <strong>大圆距离</strong> 并丢弃那些位于边界框内但在搜索半径之外的点。为此，在 <strong>find_places_within()</strong> 函数的末尾添加以下内容：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">places</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List of (long, lat, name) tuples.</span>

<span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s2">&quot;WGS84&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">_cursor</span><span class="p">:</span>
    <span class="n">name</span><span class="p">,</span><span class="n">long</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="n">row</span>
    <span class="n">angle1</span><span class="p">,</span><span class="n">angle2</span><span class="p">,</span><span class="n">distance</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">startLong</span><span class="p">,</span> <span class="n">startLat</span><span class="p">,</span>
                                        <span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="n">searchRadius</span><span class="p">:</span> <span class="k">continue</span>

    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>

<span class="k">return</span> <span class="p">{</span><span class="s1">&#39;places&#39;</span> <span class="p">:</span> <span class="n">places</span><span class="p">,</span>
        <span class="s1">&#39;minLat&#39;</span> <span class="p">:</span> <span class="n">minLat</span><span class="p">,</span>
        <span class="s1">&#39;minLong&#39;</span> <span class="p">:</span> <span class="n">minLong</span><span class="p">,</span>
        <span class="s1">&#39;maxLat&#39;</span> <span class="p">:</span> <span class="n">maxLat</span><span class="p">,</span>
        <span class="s1">&#39;maxLong&#39;</span> <span class="p">:</span> <span class="n">maxLong</span> <span class="p">}</span>
</pre></div>
</div>
<p>正如你所看到的，我们返回了匹配地点的列表，以及我们计算出的最小和最大纬度与经度值。</p>
<p>这完成了我们的 <strong>find_places_within()</strong> 函数，它实现了一个百分之百准确的基于距离的地点名称查找，并且计算结果只需要几毫秒的时间。</p>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<p>In Chapter 6, GIS in the Database, we looked at the process of identifying all points
within a given polygon. Because MySQL only handles bounding-box intersection
tests, we ended up having to write a program which asked the database to identify
all points within the bounding box, and then manually checked each point to see if
it was actually inside the polygon:</p>
<a class="with-border reference internal image-reference" href="../_images/272-0.png"><img alt="../_images/272-0.png" class="with-border align-center" src="../_images/272-0.png" style="width: 581.5px; height: 327.5px;" /></a>
<p>This suggests a way in which we can solve the distance-based-selection problem for
DISTAL: we can calculate a bounding box which encloses the desired search radius,
ask the database to identify all points within that bounding box, and then calculate
the great circle distance for all the returned points, selecting just those points that are
actually inside the search radius. Because a relatively small number of points will
be inside the bounding box, calculating the great circle distance for just these points
will be quick, allowing us to accurately find the matching points without a large
performance penalty.</p>
<p>Let’s start by calculating the bounding box. We already know the coordinates for the
starting point and the desired search radius:</p>
<a class="with-border reference internal image-reference" href="../_images/273-0.png"><img alt="../_images/273-0.png" class="with-border align-center" src="../_images/273-0.png" style="width: 251.0px; height: 251.0px;" /></a>
<p>Using pyproj, we can calculate the lat/long coordinates for four points by traveling
radius meters directly north, south, east, and west of the starting point:</p>
<a class="with-border reference internal image-reference" href="../_images/273-1.png"><img alt="../_images/273-1.png" class="with-border align-center" src="../_images/273-1.png" style="width: 252.5px; height: 254.0px;" /></a>
<p>We then use these four points to define the bounding box that encloses the desired
search radius:</p>
<a class="with-border reference internal image-reference" href="../_images/274-0.png"><img alt="../_images/274-0.png" class="with-border align-center" src="../_images/274-0.png" style="width: 252.5px; height: 252.5px;" /></a>
<p>We’re going to create a new function within our database module, which performs a
spatial search using this bounding box. Let’s start by adding the following to the end
of your database.py module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_places_within</span><span class="p">(</span><span class="n">startLat</span><span class="p">,</span> <span class="n">startLong</span><span class="p">,</span> <span class="n">searchRadius</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_cursor</span>

    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Note that, because we’re using pyproj to do a forward geodetic calculation, we
can calculate the correct lat/long coordinates for the bounding box regardless of
the latitude of the starting point. The only place this will fail is if startLat is within
searchRadius meters of the North or South Pole—which is highly unlikely given
that we’re searching for cities (and we could always add error-checking code to
catch this).</p>
<p>When it’s finished, our find_places_within() function will return a list of
all the places within the given bounding box, as well as the calculated bounding
box. Because the spatial queries are different for each database, we’ll look at each
one individually.</p>
<p>For MySQL, we’ll create a Polygon out of the supplied bounding box, and then use
the MBRContains() function to search for places within that Polygon. To do this,
replace the first … with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span> <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span>
    <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span> <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span>
    <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">)])</span>
<span class="n">wkt</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;X(position),Y(position) &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM places WHERE MBRContains(&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;GeomFromText(</span><span class="si">%s</span><span class="s2">), position)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">wkt</span><span class="p">,))</span>
</pre></div>
</div>
<p>PostGIS uses a similar approach, creating a Polygon and then using the
ST_CONTAINS() function to identify the matching places:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span> <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">),</span>
             <span class="p">(</span><span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span> <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">),</span>
             <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">)])</span>
<span class="n">wkt</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;ST_X(position),ST_Y(position) &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM places WHERE ST_CONTAINS(&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;ST_GeomFromText(</span><span class="si">%s</span><span class="s2">, 4326), &quot;</span> <span class="o">+</span>
    <span class="s2">&quot;position)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">wkt</span><span class="p">,))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>You might be wondering why we don’t use PostGIS’s ST_DWITHIN() function to identify the matching places. The problem is that we are using unprojected coordinates, which means that the “distance” supplied to ST_DWITHIN() would have to be in measured in degrees rather than meters. This is possible, but there are some tricky calculations required to convert from meters to degrees. To keep things simple, we’ll use the ST_CONTAINS() function instead.</p>
</div>
<p>Finally, for SpatiaLite we have to do a bit more work. Remember that SpatiaLite
doesn’t automatically use a spatial index for queries. To make this code efficient
in SpatiaLite, we have to check the spatial index directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;X(position),Y(position) &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM places WHERE id in &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;(SELECT pkid &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;FROM idx_places_position &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;WHERE xmin &gt;= ? AND xmax &lt;= ? &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;AND ymin &gt;= ? and ymax &lt;= ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">minLong</span><span class="p">,</span> <span class="n">maxLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">))</span>
</pre></div>
</div>
<p>Now that we have executed an SQL query to identify all the points within the
bounding box, we can check the great circle distance and discard those points,
which are inside the bounding box, but outside the search radius. To do this,
add the following to the end of your find_places_within() function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">places</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List of (long, lat, name) tuples.</span>

<span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s2">&quot;WGS84&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">_cursor</span><span class="p">:</span>
    <span class="n">name</span><span class="p">,</span><span class="n">long</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="n">row</span>
    <span class="n">angle1</span><span class="p">,</span><span class="n">angle2</span><span class="p">,</span><span class="n">distance</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">startLong</span><span class="p">,</span> <span class="n">startLat</span><span class="p">,</span>
                                      <span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="n">searchRadius</span><span class="p">:</span> <span class="k">continue</span>

    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>

<span class="k">return</span> <span class="p">{</span><span class="s1">&#39;places&#39;</span> <span class="p">:</span> <span class="n">places</span><span class="p">,</span>
        <span class="s1">&#39;minLat&#39;</span> <span class="p">:</span> <span class="n">minLat</span><span class="p">,</span>
        <span class="s1">&#39;minLong&#39;</span> <span class="p">:</span> <span class="n">minLong</span><span class="p">,</span>
        <span class="s1">&#39;maxLat&#39;</span> <span class="p">:</span> <span class="n">maxLat</span><span class="p">,</span>
        <span class="s1">&#39;maxLong&#39;</span> <span class="p">:</span> <span class="n">maxLong</span> <span class="p">}</span>
</pre></div>
</div>
<p>As you can see, we return the list of matching places, along with the minimum and
maximum latitude and longitude values we calculated.</p>
<p>This completes our <em>find_places_within()</em> function, which achieves a 100 percent
accurate distance-based lookup on place names, with the results taking only a
fraction of a second to calculate.</p>
</div>
</div>
</section>
</section>
<section id="id15">
<h3>显示结果<a class="headerlink" href="#id15" title="此标题的永久链接">#</a></h3>
<p>Displaying the results</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p>现在，我们已经计算出了位于所需搜索半径内的地点名称列表，我们可以使用 <strong>mapGenerator.py</strong> 模块来显示它们。然而，在此之前，我们需要设置一个数据源来显示高分辨率的海岸线。让我们向我们的 <strong>database.py</strong> 模块添加另一个函数来完成这一任务：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_shoreline_datasource</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>

        <span class="n">vrtFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                <span class="s2">&quot;shorelines.vrt&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">vrtFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;OGRVRTLayer name=&quot;shorelines&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span>
        <span class="o">&lt;</span><span class="n">SrcDataSource</span><span class="o">&gt;</span><span class="n">MYSQL</span><span class="p">:</span><span class="s1">&#39; + MYSQL_DBNAME)</span>
        <span class="k">if</span> <span class="n">MYSQL_USERNAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,user=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_USERNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MYSQL_PASSWORD</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,passwd=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_PASSWORD</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,tables=shorelines&lt;/SrcDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &lt;SrcSQL&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;     SELECT id,outline FROM shorelines &#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;WHERE level=1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;     &lt;/SrcSQL&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;/OGRVRTLayer&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s2">&quot;OGR&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span> <span class="p">:</span> <span class="n">vrtFile</span><span class="p">,</span>
                <span class="s1">&#39;layer&#39;</span> <span class="p">:</span> <span class="s2">&quot;shorelines&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">,</span>
                <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s2">&quot;distal&quot;</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;shorelines&quot;</span><span class="p">,</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">POSTGIS_USERNAME</span><span class="p">,</span>
                <span class="s1">&#39;password&#39;</span> <span class="p">:</span> <span class="n">POSTGIS_PASSWORD</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;SQLite&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">SPATIALITE_DBNAME</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;shorelines&quot;</span><span class="p">,</span>
                <span class="s1">&#39;geometry_field&#39;</span> <span class="p">:</span> <span class="s2">&quot;outline&quot;</span><span class="p">,</span>
                <span class="s1">&#39;key_field&#39;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>如你所见，这个函数几乎与我们的 <strong>get_country_datasource()</strong> 函数相同，只是它访问了不同的数据库表格，用于显示高分辨率的海岸线，而不是低分辨率的国家轮廓。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>请注意，我们在.VRT文件中的 <strong>SrcSQL</strong> 语句只包括`level`等于1的海岸线数据。这意味着我们仅显示海岸线，而不包括湖泊、湖中的岛屿等。由于 <strong>mapGenerator.py</strong> 模块不支持多个数据源，因此我们在此版本的 <strong>DISTAL</strong> 系统中无法绘制湖泊。扩展 <strong>mapGenerator.py</strong> 以支持多个数据源是可能的，但对于这一章来说过于复杂。目前，我们只能接受这个限制。</p>
</div>
<p>设置完成后，我们终于可以回到 <strong>showResults.py</strong> 文件，使用它来显示我们的结果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">find_places_within</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span>
                                        <span class="n">radius</span><span class="p">)</span>

<span class="n">imgFile</span> <span class="o">=</span> <span class="n">mapGenerator</span><span class="o">.</span><span class="n">generateMap</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span>
                                    <span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span>
                                    <span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">,</span>
                                    <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span>
                                    <span class="n">points</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;places&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>在我们之前调用地图生成器时，我们使用了一个筛选表达式来突出显示特定的特征。在这个例子中，我们不需要突出显示任何东西。相反，我们将地点名称列表传递给它，作为关键字参数 <strong>points</strong> 。</p>
<p>地图生成器创建一个PNG格式的文件，并返回对该文件的引用，我们可以将其展示给用户：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s1">&#39;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;html&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;head&gt;&lt;title&gt;Search Results&lt;/title&gt;&lt;/head&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">countryName</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;img src=&quot;&#39;</span> <span class="o">+</span> <span class="n">imgFile</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/html&gt;&#39;</span>
</pre></div>
</div>
<p>这完成了我们第一个版本的 <strong>showResults.py</strong> CGI脚本。</p>
</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<p>Now that we have calculated the list of place names within the desired search radius,
we can use the mapGenerator.py module to display them. Before we do so, though,
we’ll have to set up a data source to display the high-resolution shorelines. Let’s add
another function to our database.py module, which does this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_shoreline_datasource</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;MySQL&quot;</span><span class="p">:</span>

        <span class="n">vrtFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                               <span class="s2">&quot;shorelines.vrt&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">vrtFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;OGRVRTLayer name=&quot;shorelines&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span>
        <span class="o">&lt;</span><span class="n">SrcDataSource</span><span class="o">&gt;</span><span class="n">MYSQL</span><span class="p">:</span><span class="s1">&#39; + MYSQL_DBNAME)</span>
        <span class="k">if</span> <span class="n">MYSQL_USERNAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,user=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_USERNAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MYSQL_PASSWORD</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,passwd=&quot;</span> <span class="o">+</span> <span class="n">MYSQL_PASSWORD</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,tables=shorelines&lt;/SrcDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   &lt;SrcSQL&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;     SELECT id,outline FROM shorelines &#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;WHERE level=1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;     &lt;/SrcSQL&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;/OGRVRTLayer&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/OGRVRTDataSource&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s2">&quot;OGR&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span> <span class="p">:</span> <span class="n">vrtFile</span><span class="p">,</span>
                <span class="s1">&#39;layer&#39;</span> <span class="p">:</span> <span class="s2">&quot;shorelines&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;PostGIS&quot;</span><span class="p">,</span>
                <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="s2">&quot;distal&quot;</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;shorelines&quot;</span><span class="p">,</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">POSTGIS_USERNAME</span><span class="p">,</span>
                <span class="s1">&#39;password&#39;</span> <span class="p">:</span> <span class="n">POSTGIS_PASSWORD</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">DB_TYPE</span> <span class="o">==</span> <span class="s2">&quot;SpatiaLite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;SQLite&quot;</span><span class="p">,</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">SPATIALITE_DBNAME</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s2">&quot;shorelines&quot;</span><span class="p">,</span>
                <span class="s1">&#39;geometry_field&#39;</span> <span class="p">:</span> <span class="s2">&quot;outline&quot;</span><span class="p">,</span>
                <span class="s1">&#39;key_field&#39;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>As you can see, this is almost identical to our <em>get_country_datasource()</em> function, except that it accesses a different database table to display the high-resolution shoreline rather than the low-resolution country outlines.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Notice that the SrcSQL statement in our .VRT file only includes shoreline data where level is equal 1. This means that we’re only displaying the coastlines, and not the lakes, islands-on-lakes, and so on. Because the mapGenerator.py module doesn’t support multiple data sources, we aren’t able to draw lakes in this version of the DISTAL system. Extending mapGenerator.py to support multiple data sources is possible, but is too complicated for this chapter. For now we’ll just have to live with this limitation.</p>
</div>
<p>With this in place, we can finally return to our showResults.py file and use it to display our results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">find_places_within</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span>
                                      <span class="n">radius</span><span class="p">)</span>

<span class="n">imgFile</span> <span class="o">=</span> <span class="n">mapGenerator</span><span class="o">.</span><span class="n">generateMap</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span>
                                   <span class="n">minLong</span><span class="p">,</span> <span class="n">minLat</span><span class="p">,</span>
                                   <span class="n">maxLong</span><span class="p">,</span> <span class="n">maxLat</span><span class="p">,</span>
                                   <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span>
                                   <span class="n">points</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;places&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>When we called the map generator previously, we used a filter expression to
highlight particular features. In this case we don’t need to highlight anything.
Instead, we pass it the list of place names to display on the map in the keyword
parameter named points.</p>
<p>The map generator creates a PNG-format file, and returns a reference to that file
which we can then display to the user:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s1">&#39;Content-Type: text/html; charset=UTF-8</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;html&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;head&gt;&lt;title&gt;Search Results&lt;/title&gt;&lt;/head&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">countryName</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;p&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;img src=&quot;&#39;</span> <span class="o">+</span> <span class="n">imgFile</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/body&gt;&#39;</span>
<span class="nb">print</span> <span class="s1">&#39;&lt;/html&gt;&#39;</span>
</pre></div>
</div>
<p>This completes our first version of the <em>showResults.py</em> CGI script.</p>
</div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="aplication.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">应用程序审查和改进</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="importing-data.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">导入数据</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2025, Erik Westra
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">实现 DISTAL 应用程序</a><ul>
<li><a class="reference internal" href="#id1">共享“数据库”模块</a></li>
<li><a class="reference internal" href="#id2">“选择国家”脚本</a></li>
<li><a class="reference internal" href="#id3">“选择区域”脚本</a><ul>
<li><a class="reference internal" href="#id4">计算边界框</a></li>
<li><a class="reference internal" href="#id5">计算地图尺寸</a></li>
<li><a class="reference internal" href="#id6">设置数据源</a></li>
<li><a class="reference internal" href="#id7">渲染地图图像</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">“显示结果”脚本</a><ul>
<li><a class="reference internal" href="#id9">识别点击点</a></li>
<li><a class="reference internal" href="#id10">按距离识别特征</a><ul>
<li><a class="reference internal" href="#id11">手动计算距离</a></li>
<li><a class="reference internal" href="#id12">使用角距离</a></li>
<li><a class="reference internal" href="#id13">使用投影坐标</a></li>
<li><a class="reference internal" href="#id14">混合方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id15">显示结果</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/translations.js"></script>
    </body>
</html>